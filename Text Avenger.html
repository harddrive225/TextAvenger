<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html style="background: black;">
<head><p style="background-color: green; color: red; font-size: 70px; font-weight: 900; text-align: center; height: 70px; padding: 0px; margin: 0px;"> TEXT AVENGER </p></head>
<body>
	<div style="position: relative; width: 70%; float: left;">
		<div>
			<p id="prompt" style="background: green; font-size: 18px; font-weight: 600; width: 95%; height: 185px; margin: 10px 0px 10px 0px;">Please create or load a character.</p>
		</div>
		<div style="float: left; width: 60%;">
		<p id="option">1<button id="button0" onclick="buttonVarArray[0](0);" style="display: none;">Option 0</button></p>
		<p id="option">2<button id="button1" onclick="buttonVarArray[1](1);" style="display: none;">Option 1</button></p>
		<p id="option">3<button id="button2" onclick="buttonVarArray[2](2);" style="display: none;">Option 2</button></p>
		<p id="option">4<button id="button3" onclick="buttonVarArray[3](3);" style="display: none;">Option 3</button></p>
		<p id="option">5<button id="button4" onclick="buttonVarArray[4](4);" style="display: none;">Option 4</button></p>
		<p id="option">6<button id="button5" onclick="buttonVarArray[5](5);" style="display: none;">Option 5</button></p>
		<p id="option">7<button id="button6" onclick="buttonVarArray[6](6);" style="display: none;">Option 6</button></p>
		<p id="option">8<button id="button7" onclick="buttonVarArray[7](7);" style="display: none;">Option 7</button></p>
		<p id="option">9<button id="button8" onclick="buttonVarArray[8](8);" style="display: none;">Option 8</button></p>
		<p id="option">10<button id="button9" onclick="buttonVarArray[9](9);" style="display: none;">Option 9</button></p>
		</div>
		<p id="menu" style="background: red; font-size: 18px; font-weight: 600; width: 35%; height: 200px; margin-right: 30px; position: relative; float: right;">
			MENU<br/>
			<button id="load" onclick="loadChar();">Load</button>
			<button id="save" onclick="saveChar();">Save</button>
			<button id="newChar" onclick="createChar();">New Character</button><br/>
			<button id="useItem" onclick="useItem();" style="display: none;">Use Item</button>
			<button id="removeItem" onclick="dropStuffThru(player.items, player.itemsQuantity, 'item');" style="display: none;">Drop Item</button>
			<button id="checkItemInfo" onclick="checkInfo('item', false);" style="display: none;">Check Item Info</button>
			<button id="equipWeapon" onclick="equipStuff(0);" style="display: none;">Equip Weapon</button>
			<button id="removeWeapon" onclick="dropStuffThru(player.weapons, player.weaponsQuantity, 'weapon');" style="display: none;">Drop Weapon</button>
			<button id="checkWeaponInfo" onclick="checkInfo('weapon', false);" style="display: none;">Check Weapon Info</button>
			<button id="equipArmor" onclick="equipStuff(1);" style="display: none;">Equip Armor</button>
			<button id="removeArmor" onclick="dropStuffThru(player.armor, player.armorQuantity, 'armor');" style="display: none;">Drop Armor</button>
			<button id="checkArmorInfo" onclick="checkInfo('armor', false);" style="display: none;">Check Armor Info</button>
			<button id="castSpell" onclick="castSpell();" style="display: none;">Cast Spell</button>
			<button id="checkAttackSpellInfo" onclick="checkInfo('attack spell', false);" style="display: none;">Check Spell Info</button>
			<button id="checkEffectSpellInfo" onclick="checkInfo('effect spell', false);" style="display: none;">Check Spell Info</button>
			<button id="checkQuest" onclick="checkInfo('quest', false);" style="display: none;">Check Quest</button>
			<br/><br/><br/>
			<button onclick="window.alert('Player Progress Number: '+player.progress+' Nights Work Number: '+(player.progress-81))">Progress</button>
			<button onclick="gotoProg()">Go To</button>
			<button onclick="nwCheck()">Night's Work</button>
		</p>
	</div>
	<div style="position: relative; width: 30%; float: right;">
		<ul style="background: green; font-size: 14px; font-weight: 600; width: 40%; padding: 20px; height: 140px; float: left; overflow: hidden">Combat Stats
			<li id="name">Name: Stat</li>
			<li id="level">Level: Stat</li>
			<li id="health">Health: Stat</li>
			<li id="manna">Manna: Stat</li>
			<li id="status">Status: Stat</li>
			<li id="experience">XP: Stat</li>
			<li id="nextLevel">NextLvl XP: Stat</li>
		</ul>
		<ul style="background: green; font-size: 14px; font-weight: 600; width: 40%; padding: 20px; height: 140px; float: right; overflow: hidden">
			<br/>
			<li id="raceClass">Race/Class: Stat</li>
			<li id="strength">Strength: Stat</li>
			<li id="dexterity">Dexterity: Stat</li>
			<li id="IQ">IQ: Stat</li>
			<li id="defense">Defense: Stat</li>
			<li id="armorClass">Armor Class: Stat</li>
			<li id="gold">Gold: 0</li>
		</ul>
	</div>
	<div style="background: green; float: right; height: 50px; width: 30%">
		<button id="listItems" onclick="loadInventory();" class="smallButton">Inventory</button>
		<button id="listWeapons" onclick="loadWeapons();" class="smallButton">Weapons</button>
		<button id="listArmor" onclick="loadArmor();" class="smallButton">Armor</button>
		<button id="listSpells" onclick="loadEffectSpells();" class="smallButton">Spells</button>
		<button id="listQuests" onclick="loadQuests();" class="smallButton">Quests</button>
		<br/>
		<button id="listEffectSpells" onclick="loadEffectSpells();" class="smallButton" style="display: none;">Show Effect Spells</button>
		<button id="listAttackSpells" onclick="loadAttackSpells();" class="smallButton" style="display: none;">Show Attack Spells</button>
		<div/>
		<ol id="gameList" style="background: green; font-weight: 600; width: 85%; height: 220px; overflow-x: hidden; overflow-y: scroll; margin: 0px; padding: 30px;">
			<div id="gameListTitle">INVENTORY</div>
		</ol>
	</div>
	<div id="storePopUp" style="display: none;">
		<div id="storePrompt" style="background: blue; height: 12%; font-weight: 800; font-size: 18;">
			What would you like to buy or sell?
		</div>
		<div id="storeButtons" style="text-align: center; background: blue; height: 10%">
			<button id="shopCheckItem" onclick="checkInfo('item', true);" style="display: none">Check Item</button>
			<button id="shopCheckWeapon" onclick="checkInfo('weapon', true);" style="display: none">Check Weapon</button>
			<button id="shopCheckArmor" onclick="checkInfo('armor', true);">Check Armor</button>
			<button id="depositGold" onclick="depositGold()">Deposit Gold</button>
			<button id="withdrawGold"onclick="withdrawGold()">Withdraw Gold</button>
			<button onclick="exitShop();">Exit</button>
			<br/>
			<button id="listShopItems" onclick="loadShopInventory();">Inventory</button>
			<button id="listShopWeapons" onclick="loadShopWeapons();">Weapons</button>
			<button id="listShopArmor" onclick="loadShopArmor();">Armor</button>
		</div>
		<div id="storeLists">
		<ol id="storeSell" style="float: left; background-color: red; font-size: 18px; font-weight: 600; width: 40%; height: 300px; overflow-x: hidden; overflow-y: scroll; margin: 0px; padding: 30px;">
			<div id="sellItems">You</div>
			<div id="shopListTitle0">INVENTORY</div>
		</ol>
		<ol id="storeBuy" style="float: right; background-color: red; font-size: 18px; font-weight: 600; width: 40%; height: 300px; overflow-x: hidden; overflow-y: scroll; margin: 0px; padding: 30px;">
			<div id="buyItems">Merchant</div>
			<div id="shopListTitle1">INVENTORY</div>
		</ol>
		<div id="playerGold" style="float: left; font-weight: 800; font-size: 18; padding-left: 30px">Gold: Stat</div>
		<div id="shopGold" style="float: right; font-weight: 800; font-size: 18; padding-right: 30px">Gold: Stat</div>
			</div>
		</div>
	</div>
	
	
	<style>
		.smallButton {padding: 0px; font-size: 12px;}
		#option {background: green; font-size: 20px; font-weight: 600; height: 30px; margin: 0px; padding: 0px; position: relative;}
	</style>
	
<script type="text/javascript">
	var loadSaveArray = [];
	var player;
	var nwFlags = 1;
	var nwOffset = 81;
	var data = [
		data0, data1, data2, data3, data4, data5, data6, data7, data8, data9, data10, data11, data12, data13, data14, data15, data16, data17, data18, data19, data20, 
		data21, data22, data23, data24, data25, data26 , data27, data28, data29, data30, data31, data32, data33, data34, data35, data36, data37, data38, data39, data40, 
		data41, data42, data43, data44, data45, data46, data47, data48, data49, data50, data51, data52, data53, data54, data55, data56, data57, data58, data59, data60, 
		data61, data62, data63, data64, data65, data66, data67, data68, data69, data70, data71, data72, data73, data74, data75, data76, data77, data78, data79, data80,	/* 
		
		data81, data82, data83, data84, data85, data86, data87, data88, data89, data90, data91, data92, data93, data94, data95, data96, data97, data98, data99, data100, 
		data101, data102, data103, data104, data105, data106, data107, data108, data109, data110, data111, data112, data113, data114, data115, data116, data117, data118, 
		data119, data120, data121, data122, data123, data124, data125, data126, data127, data128, data129, data130, data131, data132, data133, data134, data135, data136, 
		data137, data138, data139, data140, data141, data142, data143, data144, data145, data146, data147, data148, data149, data150, data151, data152, data153, data154, 
		data155, data156, data157, data158, data159, data160, data161, data162, data163, data164, data165, data166, data167, data168, data169, data170, data171, data172, 
		data173, data174, data175, data176, data177, data178, data179, data180, data181, data182, data183, data184, data185, data186, data187, data188, data189, data190, 
		data191, data192, data193, data194, data195, data196, data197, data198, data199, 
*/
		nightsWork0, nightsWork1, nightsWork2, nightsWork3, nightsWork4, nightsWork5, nightsWork6, nightsWork7, nightsWork8, nightsWork9, nightsWork10, nightsWork11, 
		nightsWork12, nightsWork13, nightsWork14, nightsWork15, nightsWork16, nightsWork17, nightsWork18, nightsWork19, nightsWork20, nightsWork21, nightsWork22, 
		nightsWork23, nightsWork24, nightsWork25, nightsWork26, nightsWork27, nightsWork28, nightsWork29, nightsWork30, nightsWork31, nightsWork32, nightsWork33, 
		nightsWork34, nightsWork35, nightsWork36, nightsWork37, nightsWork38, nightsWork39, nightsWork40, nightsWork41, nightsWork42, nightsWork43, nightsWork44, 
		nightsWork45, nightsWork46, nightsWork47, nightsWork48, nightsWork49, nightsWork50, nightsWork51, nightsWork52, nightsWork53, nightsWork54, nightsWork55, 
		nightsWork56, nightsWork57, nightsWork58, nightsWork59, nightsWork60, nightsWork61, nightsWork62, nightsWork63, nightsWork64, nightsWork65, nightsWork66, 
		nightsWork67, nightsWork68, nightsWork69, nightsWork70, nightsWork71, nightsWork72, nightsWork73, nightsWork74, nightsWork75, nightsWork76, nightsWork77, 
		nightsWork78, nightsWork79, nightsWork80, nightsWork81, nightsWork82, nightsWork83, nightsWork84, nightsWork85, nightsWork86, nightsWork87, nightsWork88, 
		nightsWork89, nightsWork90, nightsWork91, nightsWork92, nightsWork93, nightsWork94, nightsWork95, nightsWork96, nightsWork97, nightsWork98, nightsWork99, 
		nightsWork100, nightsWork101, nightsWork102, nightsWork103, nightsWork104, nightsWork105, nightsWork106, nightsWork107, nightsWork108, nightsWork109, 
		nightsWork110, nightsWork111, nightsWork112, nightsWork113, nightsWork114, nightsWork115, nightsWork116, nightsWork117, nightsWork118, nightsWork119, 
		nightsWork120, nightsWork121, nightsWork122, nightsWork123, nightsWork124, nightsWork125, nightsWork126, nightsWork127, nightsWork128, nightsWork129, 
		nightsWork130, nightsWork131, nightsWork132, nightsWork133, nightsWork134, nightsWork135, nightsWork136, nightsWork137, nightsWork138, nightsWork139, 
		nightsWork140, nightsWork141, nightsWork142, nightsWork143, nightsWork144, nightsWork145, nightsWork146, nightsWork147, nightsWork148, nightsWork149, 
		nightsWork150, nightsWork151, nightsWork152, nightsWork153, nightsWork154, nightsWork155, nightsWork156, nightsWork157, nightsWork158, nightsWork159, 
		nightsWork160, nightsWork161, nightsWork162, nightsWork163, nightsWork164, nightsWork165, nightsWork166, nightsWork167, nightsWork168, nightsWork169, 
		nightsWork170, nightsWork171, nightsWork172, nightsWork173, nightsWork174, nightsWork175, nightsWork176, nightsWork177, nightsWork178, nightsWork179, 
		nightsWork180, nightsWork181, nightsWork182, nightsWork183, nightsWork184, nightsWork185		
	];
	
	createGameList = function() {
		for (i=0; i<24; i+=1) {
			document.getElementById("gameList").innerHTML += '<li id="item'+i+'" style="display: none;" onclick="itemVarArray['+i+']('+i+');">ITEM</li>'
		}
	}
	createStoreLists = function() {
		for (i=0; i<60; i+=1) {
			document.getElementById("storeSell").innerHTML += '<li id="sell'+i+'" onclick="sellVarArray['+i+']('+i+');" style="display: none;">ITEM'+i+'</li>'
			document.getElementById("storeBuy").innerHTML += '<li id="buy'+i+'" onclick="buyVarArray['+i+']('+i+');" style="display: none;">ITEM'+i+'</li>'
		}
	}
	createGameList(); createStoreLists();
	
	function playerChar() {
		charName = new Object();
		charName.name = "";
		charName.level = 1;
		charName.race = "";
		charName.class = "";
		charName.strength = 10;
		charName.dexterity = 10;
		charName.iq = 10;
		charName.health = 30;
		charName.hitPoints = 30;
		charName.manna = 30;
		charName.mannaMax = 30;
		charName.defense = 10;
		charName.armorClass = 10;
		charName.experience = 0;
		charName.progress = 0;
		charName.items = [];
		charName.itemsQuantity = [];
		charName.weapons = [weapons.fist];
		charName.weaponsQuantity = [1];
		charName.weaponEquipped = 0;				//weaponEquipped is weapon's position in weapons list.
		charName.armor = [];
		charName.armorQuantity = [];
		charName.armorIsEquipped = [];
		charName.armorTypeEquipped = [];
		charName.spells = [];
		charName.spellsAttack = [];
		charName.weakness = [];
		charName.status = []
		charName.statusRounds = []
		charName.gold = 0;
		charName.quests = [];
		charName.questProgress = [];
		charName.flags = [];
		fillArray(charName.flags, 64, false);
		return charName;
	};
	
	function createChar() {
		player = playerChar();
		player.name = window.prompt("What is your character's name?");
		copyDataToLoadSave();
		playerClass();
	}
	
	function playerClass() {
		document.getElementById("prompt").innerHTML = "Choose your character's race. ";
		buttonReset();
		setButton(0, "Human", human);
		setButton(1, "Elf", elf);
		setButton(2, "Orc", orc);
		setButton(3, "Dwarf", dwarf);
		function human() {
			player.race = "Human";
			player.dexterity += 5;
			classSel();
		}
		function elf() {
			player.race = "Elf";
			player.iq += 5;
			player.mannaMax += 5;
			player.strength -= 5;
			classSel();
		}
		function orc() {
			player.race = "Orc";
			player.defense += 5;
			player.strength += 5;
			player.iq -= 5;
			classSel();
		}
		function dwarf() {
			player.race = "Dwarf";
			player.defense += 5;
			player.hitPoints += 5;
			player.dexterity -= 5;
			classSel();
		}
		function classSel() {
			document.getElementById("prompt").innerHTML = "Choose your character's race. ";
			buttonReset();
			setButton(0, "Warrior", warrior);
			setButton(1, "Mage", mage);
			setButton(2, "Rogue", rogue);
			setButton(3, "Paladin", paladin);
			player.health = player.hitPoints; 
			player.manna = player.mannaMax; 
			player.armorClass = player.defense;
			displayChar();
			function warrior() {
				player.class = "Warrior";
				player.strength += 10;
				player.defense += 5;
				startGame();
			}
			function mage() {
				player.class = "Mage";
				player.iq += 5;
				player.mannaMax += 10;
				startGame();
			}
			function rogue() {
				player.class = "Rogue";
				player.dexterity += 10;
				player.hitPoints += 5;
				startGame();
			}
			function paladin() {
				player.class = "Paladin";
				player.strength += 5;
				player.mannaMax += 5;
				player.iq += 5;
				startGame();
			}
		}
	}
	
	function startGame() {
		player.health = player.hitPoints; 
		player.manna = player.mannaMax; 
		player.armorClass = player.defense; 
		displayChar(); 
		loadInventory(); 
		data0();
	}
	
	function displayChar() {
		var playerStatus = "ready";
		if (player.status.length > 0) {playerStatus = player.status;}
		document.getElementById("name").innerHTML = "Name: " + player.name;
		document.getElementById("level").innerHTML = "Level: " + player.level;
		document.getElementById("strength").innerHTML = "Strength: " + player.strength;
		document.getElementById("dexterity").innerHTML = "Dexterity: " + player.dexterity;
		document.getElementById("IQ").innerHTML = "IQ: " + player.iq;
		document.getElementById("health").innerHTML = "Health: " + player.health + "/" + player.hitPoints;
		document.getElementById("defense").innerHTML = "Defense: " + player.defense;
		document.getElementById("armorClass").innerHTML = "Armor Class: " + player.armorClass;
		document.getElementById("manna").innerHTML = "Manna: " + player.manna + "/" + player.mannaMax;
		document.getElementById("status").innerHTML = "Status: " + playerStatus;
		document.getElementById("experience").innerHTML = "XP: " + player.experience;
		document.getElementById("nextLevel").innerHTML = "LvlUp XP: " + levelUpExpCheck();		
		document.getElementById("gold").innerHTML = "Gold: " + player.gold;
		document.getElementById("raceClass").innerHTML = "Race/Class: "+player.race+" "+player.class;
	};
	
	function levelUpExpCheck() {
		var exp = 0; 
		for (let i=1; i<=player.level; i+=1){
			var add = (i*100); 
			exp += add - (player.level*20);
		}; 
		return exp;
	}
	
	function levelUp() {
		if (levelUpExpCheck() <= player.experience) {
			player.level+=1; 
			player.hitPoints+=player.level; 
			player.mannaMax+=player.level;
			var skillPoints = 10; 
			var str = 0; 
			var dex = 0; 
			var iq = 0; 
			var def = 0; 
			var hp = 0; 
			var manna = 0; 
			document.getElementById("prompt").innerHTML = "You have reached level "+player.level+".";
			buttonReset();setButton(0, "Continue.", lvlUp)
		} else {
			if (combat.active === true) {
				combat.victoryFunc(); 
				combat.victoryFunc = data[player.progress];
				combat.active = false; 
				return;
			} else {data[player.progress]();}
		};
		function lvlUp() {
			document.getElementById("prompt").innerHTML = "Choose which stats you would like to boost. You have "+
			skillPoints+" Skill Points remaining."; buttonReset();
			setButton(0, "Apply.", lvlUpApply); 
			setButton(1, "Reset.", lvlUpReset); 
			setButton(2, "Strength (+"+str+")", statBoost); 
			setButton(3, "Dexterity (+"+dex+")", statBoost); 
			setButton(4, "IQ (+"+iq+")", statBoost); 
			setButton(5, "Defense (+"+def+")", statBoost); 
			setButton(6, "Health (+"+hp+")", statBoost); 
			setButton(7, "Manna (+"+manna+")", statBoost); 
			function statBoost(stat) {
				if (skillPoints===0) {
					return;
				} else if (stat===2) {
					str+=1;
				} else if (stat===3) {
					dex+=1;
				} else if (stat===4) {
					iq+=1;
				} else if (stat===5) {
					def+=1;
				} else if (stat===6) {
					hp+=1;
				} else if (stat===7) {
					manna+=1;
				} 
				skillPoints -= 1; 
				lvlUp();
			}
			function lvlUpReset() {
				skillPoints=10; 
				str=0; 
				dex=0; 
				iq=0; 
				def=0; 
				hp=0; 
				manna=0; 
				lvlUp(); }
			function lvlUpApply() {
				if (skillPoints !== 0) {
					document.getElementById("prompt").innerHTML = "You have not used all of your Skill Points.";
					buttonReset(); 
					setButton(0, "Go back.", lvlUp); 
					return;
				}
				player.strength += str; 
				player.dexterity += dex; 
				player.iq += iq; 
				player.defense += def; 
				player.armorClass += def; 
				player.hitPoints += hp; 
				player.mannaMax += manna; 
				player.health = player.hitPoints; 
				player.manna = player.mannaMax; 
				displayChar(); 
				document.getElementById("prompt").innerHTML = "Your stats have been boosted."; 
				buttonReset(); setButton(0, "Go back.", back);
				function back() {
					if (combat.active === true) {
						combat.victoryFunc(); 
						combat.victoryFunc = data[player.progress];
						combat.active = false; 
						combat.defeatFunc = gameOver;
					} else {data[player.progress]();}
				}
			}
		}
	}
	
	function loadChar() {
		var loadFileRaw = window.prompt("Please enter the save file code.");
		player = playerChar()
		loadFile = loadFileRaw.split("- ");
		for (i=0; i<loadFile.length; i+=1) {
			loadSaveArray[i] = loadFile[i];
		} 
		copyDataFromLoadSave();
		player.armorClass = player.defense; 
		displayChar(); 
		loadInventory(); 
		data[player.progress](); 
 	}
	
	function saveChar() {
		copyDataToLoadSave();
		window.alert("The next pop up contains your save file code. To save your game, you must copy and paste the string of characters into a separate Word document. "+
			"To reload your save file, click the \"Load\" button on the main screen, copy the string of characters from the text file, and paste it into the text box. ");
		window.alert("Save Code: \n\n"+loadSaveArray.join("- "))
	}

	function copyDataFromLoadSave() {
		player.name = 						loadSaveArray[0];
		player.race = 						loadSaveArray[1];
		player.class = 						loadSaveArray[2];
		player.level = 						parseInt(loadSaveArray[3]);
		player.progress = 					parseInt(loadSaveArray[4]);
		player.experience = 				parseInt(loadSaveArray[5]);
		player.strength = 					parseInt(loadSaveArray[6]);
		player.dexterity = 					parseInt(loadSaveArray[7]);
		player.iq = 						parseInt(loadSaveArray[8]);
		player.defense =	 				parseInt(loadSaveArray[9]);
		player.health = 					parseInt(loadSaveArray[10]);
		player.hitPoints = 					parseInt(loadSaveArray[11]);
		player.manna = 						parseInt(loadSaveArray[12]);
		player.mannaMax =	 				parseInt(loadSaveArray[13]);
		player.gold = 						parseInt(loadSaveArray[14]);
		player.weaponEquipped = 			parseInt(loadSaveArray[15]);
		player.weakness.length =	 		parseInt(loadSaveArray[16]);
		player.status.length = 				parseInt(loadSaveArray[17]);
		player.quests.length = 				parseInt(loadSaveArray[18]);
		player.items.length = 				parseInt(loadSaveArray[19]);
		player.weapons.length = 			parseInt(loadSaveArray[20]);
		player.armor.length =		 		parseInt(loadSaveArray[21]);
		player.armorTypeEquipped.length = 	parseInt(loadSaveArray[22]);
		player.spells.length = 				parseInt(loadSaveArray[23]);
		player.spellsAttack.length = 		parseInt(loadSaveArray[24]);
		homeInventory.gold = 				parseInt(loadSaveArray[25]);
		townBank.gold = 					parseInt(loadSaveArray[26]);
		var count = 27;
		for (i=count; i<count+player.items.length; i+=1){player.items[i-count] = items.array[parseInt(loadSaveArray[i])]}
		count += player.items.length;
		for (i=count; i<count+player.items.length; i+=1){player.itemsQuantity[i-count] = parseInt(loadSaveArray[i]);}
		count += player.items.length;
		for (i=count; i<count+player.weapons.length; i+=1){player.weapons[i-count] = weapons.array[parseInt(loadSaveArray[i])]}
		count += player.weapons.length;
		for (i=count; i<count+player.weapons.length; i+=1){player.weaponsQuantity[i-count] = parseInt(loadSaveArray[i]);}
		count += player.weapons.length;
		for (i=count; i<count+player.armor.length; i+=1){player.armor[i-count] = armor.array[parseInt(loadSaveArray[i])]}
		count += player.armor.length;
		for (i=count; i<count+player.armor.length; i+=1){player.armorQuantity[i-count] = parseInt(loadSaveArray[i]);}
		count += player.armor.length;
		for (i=count; i<count+player.armor.length; i+=1){
			if (loadSaveArray[i] === "t") {
				player.armorIsEquipped[i-count] = true;
			} else {
				 player.armorIsEquipped[i-count] = false;
			}
		}
		count += player.armor.length;
		for (i=count; i<count+player.armorTypeEquipped.length; i+=1){player.armorTypeEquipped[i-count] = loadSaveArray[i]}
		count += player.armorTypeEquipped.length;
		for (i=count; i<count+player.spells.length; i+=1){player.spells[i-count] = spells.array[parseInt(loadSaveArray[i])]}
		count += player.spells.length;
		for (i=count; i<count+player.spellsAttack.length; i+=1){player.spellsAttack[i-count] = spells.attack.array[parseInt(loadSaveArray[i])]}
		count += player.spellsAttack.length;
		for (i=count; i<count+player.quests.length; i+=1){player.quests[i-count] = parseInt(loadSaveArray[i])}
		count += player.quests.length;
		for (i=count; i<count+player.quests.length; i+=1){player.questProgress[i-count] = parseInt(loadSaveArray[i])}
		count += player.quests.length;
		for (i=count; i<count+player.weakness.length; i+=1){player.weakness[i-count] = loadSaveArray[i]};
		count += player.weakness.length;
		for (i=count; i<count+player.status.length; i+=1){player.status[i-count] = loadSaveArray[i]};
		count += player.status.length;
		for (i=count; i<count+player.status.length; i+=1){player.statusRounds[i-count] = parseInt(loadSaveArray[i]);}	
		count += player.status.length;
		for (i=count; i<count+homeInventory.items.length; i+=1){homeInventory.items[i-count] = items.array[parseInt(loadSaveArray[i])]};
		count += homeInventory.items.length;
		for (i=count; i<count+homeInventory.items.length; i+=1){homeInventory.itemsQuantity[i-count] = parseInt(loadSaveArray[i]);}
		count += homeInventory.items.length;
		for (i=count; i<count+homeInventory.weapons.length; i+=1){homeInventory.weapons[i-count] = weapons.array[parseInt(loadSaveArray[i])]};
		count += homeInventory.weapons.length;
		for (i=count; i<count+homeInventory.weapons.length; i+=1){homeInventory.weaponsQuantity[i-count] = parseInt(loadSaveArray[i]);}
		count += homeInventory.weapons.length;
		for (i=count; i<count+homeInventory.armor.length; i+=1){homeInventory.armor[i-count] = armor.array[parseInt(loadSaveArray[i])]}
		count += homeInventory.armor.length;
		for (i=count; i<count+homeInventory.armor.length; i+=1){homeInventory.armorQuantity[i-count] = parseInt(loadSaveArray[i]);}
		count += homeInventory.armor.length;
		for (i=count; i<count+homeInventory.items.length; i+=1){homeInventory.items[i-count] = items.array[parseInt(loadSaveArray[i])]};
		count += townBank.items.length;
		for (i=count; i<count+townBank.items.length; i+=1){townBank.itemsQuantity[i-count] = parseInt(loadSaveArray[i]);}
		count += townBank.items.length;
		for (i=count; i<count+townBank.weapons.length; i+=1){townBank.weapons[i-count] = weapons.array[parseInt(loadSaveArray[i])]};
		count += townBank.weapons.length;
		for (i=count; i<count+townBank.weapons.length; i+=1){townBank.weaponsQuantity[i-count] = parseInt(loadSaveArray[i]);}
		count += townBank.weapons.length;
		for (i=count; i<count+townBank.armor.length; i+=1){townBank.armor[i-count] = armor.array[parseInt(loadSaveArray[i])]}
		count += townBank.armor.length;
		for (i=count; i<count+townBank.armor.length; i+=1){townBank.armorQuantity[i-count] = parseInt(loadSaveArray[i]);}
		count += townBank.armor.length;
		for (i=count; i<count+64; i+=1){
			if (loadSaveArray[i] === "t") {
				player.flags[i-count] = true;
			} else {
				player.flags[i-count] = false;
			}
		}
	}
	
	function copyDataToLoadSave() {
		loadSaveArray = [];
		loadSaveArray[0] = player.name;
		loadSaveArray[1] = player.race;
		loadSaveArray[2] = player.class;
		loadSaveArray[3] = player.level;
		loadSaveArray[4] = player.progress;
		loadSaveArray[5] = player.experience;
		loadSaveArray[6] = player.strength;
		loadSaveArray[7] = player.dexterity;
		loadSaveArray[8] = player.iq;
		loadSaveArray[9] = player.defense;
		loadSaveArray[10] = player.health;
		loadSaveArray[11] = player.hitPoints;
		loadSaveArray[12] = player.manna;
		loadSaveArray[13] = player.mannaMax;
		loadSaveArray[14] = player.gold;
		loadSaveArray[15] = player.weaponEquipped;
		loadSaveArray[16] = player.weakness.length
		loadSaveArray[17] = player.status.length
		loadSaveArray[18] = player.quests.length
		loadSaveArray[19] = player.items.length
		loadSaveArray[20] = player.weapons.length
		loadSaveArray[21] = player.armor.length
		loadSaveArray[22] = player.armorTypeEquipped.length
		loadSaveArray[23] = player.spells.length
		loadSaveArray[24] = player.spellsAttack.length
		loadSaveArray[25] = homeInventory.gold
		loadSaveArray[26] = townBank.gold
		var count = loadSaveArray.length;
		for (i=count; i<count+player.items.length; i+=1){loadSaveArray[i] = convert(items.array,player.items[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+player.items.length; i+=1){loadSaveArray[i] = player.itemsQuantity[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+player.weapons.length; i+=1){loadSaveArray[i] = convert(weapons.array,player.weapons[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+player.weapons.length; i+=1){loadSaveArray[i] = player.weaponsQuantity[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+player.armor.length; i+=1){loadSaveArray[i] = convert(armor.array,player.armor[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+player.armor.length; i+=1){loadSaveArray[i] = player.armorQuantity[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+player.armor.length; i+=1){
			if (player.armorIsEquipped[i-count] === true) {
				loadSaveArray[i] = "t"
			} else {
				loadSaveArray[i] = "f"
			}
		}
		count = loadSaveArray.length;
		for (i=count; i<count+player.armorTypeEquipped.length; i+=1){loadSaveArray[i] = player.armorTypeEquipped[i-count]}
		count = loadSaveArray.length;
		for (i=count; i<count+player.spells.length; i+=1){loadSaveArray[i] = convert(spells.array,player.spells[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+player.spellsAttack.length; i+=1){loadSaveArray[i] = convert(spells.attack.array,player.spellsAttack[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+player.quests.length; i+=1){loadSaveArray[i] = player.quests[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+player.quests.length; i+=1){loadSaveArray[i] = player.questProgress[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+player.weakness.length; i+=1){loadSaveArray[i] = player.weakness[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+player.status.length; i+=1){loadSaveArray[i] = player.status[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+player.statusRounds.length; i+=1){loadSaveArray[i] = player.statusRounds[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+homeInventory.items.length; i+=1){loadSaveArray[i] = convert(items.array,homeInventory.items[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+homeInventory.items.length; i+=1){loadSaveArray[i] = homeInventory.itemsQuantity[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+homeInventory.weapons.length; i+=1){loadSaveArray[i] = convert(weapons.array,homeInventory.weapons[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+homeInventory.weapons.length; i+=1){loadSaveArray[i] = homeInventory.weaponsQuantity[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+homeInventory.armor.length; i+=1){loadSaveArray[i] = convert(armor.array,homeInventory.armor[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+homeInventory.armor.length; i+=1){loadSaveArray[i] = homeInventory.armorQuantity[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+townBank.items.length; i+=1){loadSaveArray[i] = convert(items.array,townBank.items[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+townBank.items.length; i+=1){loadSaveArray[i] = townBank.itemsQuantity[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+townBank.weapons.length; i+=1){loadSaveArray[i] = convert(weapons.array,townBank.weapons[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+townBank.weapons.length; i+=1){loadSaveArray[i] = townBank.weaponsQuantity[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+townBank.armor.length; i+=1){loadSaveArray[i] = convert(armor.array,townBank.armor[i-count].name);}
		count = loadSaveArray.length;
		for (i=count; i<count+townBank.armor.length; i+=1){loadSaveArray[i] = townBank.armorQuantity[i-count];}
		count = loadSaveArray.length;
		for (i=count; i<count+64; i+=1){
			if (player.flags[i-count] === true) {
				loadSaveArray[i] = "t"
			} else {
				loadSaveArray[i] = "f"
			}
		}
		function convert(arr,type) {
			for (let i=0; i<arr.length; i+=1) {
				if (arr[i].name === type) {
					return i;
				}
			}
		}
	}
	
	function gotoProg() {
		var set = window.prompt("What number would you like to go to?");
		set = parseInt(set);
		player.progress = set;
		data[player.progress]();
	}

	buttonVarArray = [];	fillArray(buttonVarArray, 10, 0);
	itemVarArray = [];		fillArray(itemVarArray, 24, 0);
	buyVarArray = [];		fillArray(buyVarArray, 24, 0);
	sellVarArray = [];		fillArray(sellVarArray, 24, 0);

	function fillArray(stat, length, data) {for(i=0; i<length; i+=1){stat[i] = data;}}

	function buttonReset() {
		for(i=0; i<10; i+=1) {
			document.getElementById("button" + i).style = "display: none";
			buttonVarArray[i]=0;
		}
	}
	
	function setButton(buttonNum, text, func) {
		document.getElementById("button"+buttonNum).innerHTML = text;
		document.getElementById("button"+buttonNum).style = "display: button";
		buttonVarArray[buttonNum] = func;
	}
	
	function itemSet(set) {
		for(i=0; i<24; i+=1) {
			itemVarArray[i] = set;
		}
	}
	
	function itemReset() {
		for(i=0; i<24; i+=1) {
			document.getElementById("item" + i).style = "display: none";
			itemVarArray[i] = 0;
		}
	}
	function rng(radix) {
		return Math.ceil(Math.random()*radix);
	}
	function goBack(str) {
		document.getElementById("prompt").innerHTML = str;
		buttonReset();
		setButton(0, "Go back.", data[player.progress]);
		if (combat.active === true) {buttonVarArray[0] = combat.checkRound;}
	}
	
	function resetItemElements() {
		document.getElementById("removeItem").style = "display: none";
		document.getElementById("checkItemInfo").style = "display: none";
		document.getElementById("removeWeapon").style = "display: none";
		document.getElementById("removeArmor").style = "display: none";
		document.getElementById("useItem").style = "display: none";
		document.getElementById("equipWeapon").style = "display: none";
		document.getElementById("checkWeaponInfo").style = "display: none";
		document.getElementById("equipArmor").style = "display: none";
		document.getElementById("checkArmorInfo").style = "display: none";
		document.getElementById("castSpell").style = "display: none";
		document.getElementById("checkAttackSpellInfo").style = "display: none";
		document.getElementById("checkEffectSpellInfo").style = "display: none";
		document.getElementById("checkQuest").style = "display: none";
		document.getElementById("listAttackSpells").style = "display: none";
		document.getElementById("listEffectSpells").style = "display: none";
	}
	
	function loadInventory() {	
		document.getElementById("gameListTitle").innerHTML = "INVENTORY";
		resetItemElements();
		itemReset();
		document.getElementById("removeItem").style = "display: button";
		document.getElementById("useItem").style = "display: button";
		document.getElementById("checkItemInfo").style = "display: button";
		for(i=0; i<24; i+=1) {
			document.getElementById("item"+i).style = "display: none";											
		}
		for(i=0; i<player.items.length; i+=1) {
			document.getElementById("item"+i).innerHTML = player.items[i].name + "(" + player.itemsQuantity[i] + ")";
			document.getElementById("item"+i).style = "display: listitem";
		}	
	}

	function loadWeapons() {
		document.getElementById("gameListTitle").innerHTML = "WEAPONS";
		resetItemElements();
		itemReset();
		document.getElementById("removeWeapon").style = "display: button";
		document.getElementById("equipWeapon").style = "display: button";
		document.getElementById("checkWeaponInfo").style = "display: button";
		for(i=1; i<24; i+=1) {
			document.getElementById("item"+i).style = "display: none";											
		}
		document.getElementById("item0").innerHTML = player.weapons[0].name;
		document.getElementById("item0").style = "display: listitem"
		for(i=1; i<player.weapons.length; i+=1) {	
			document.getElementById("item"+i).innerHTML = player.weapons[i].name + "(" + player.weaponsQuantity[i] + ")";
			document.getElementById("item"+i).style = "display: listitem";
		}
		if (player.weaponEquipped >= 0) {
			document.getElementById("item"+player.weaponEquipped).innerHTML += " (Equipped)"
		}
	}

	function loadArmor() {
		document.getElementById("gameListTitle").innerHTML = "ARMOR";
		resetItemElements();
		itemReset();
		document.getElementById("removeArmor").style = "display: button";
		document.getElementById("equipArmor").style = "display: button";
		document.getElementById("checkArmorInfo").style = "display: button";
		for(i=0; i<24; i+=1) {
			document.getElementById("item"+i).style = "display: none";											
		}
		for(i=0; i<player.armor.length; i+=1) {
			document.getElementById("item"+i).innerHTML = player.armor[i].name + "(" + player.armorQuantity[i] + ")";
			document.getElementById("item"+i).style = "display: listitem";
		}
		player.armorClass = player.defense;
		for(i=0; i<player.armor.length; i+=1) {
			if (player.armorIsEquipped[i] === true) {
				player.armorClass += player.armor[i].stat;
				document.getElementById("item"+i).innerHTML += " (Equipped: " + player.armor[i].typeName + ")";
			}
		}
		displayChar();
	}

	function loadQuests() {
		document.getElementById("gameListTitle").innerHTML = "QUESTS";
		resetItemElements();
		itemReset();
		document.getElementById("checkQuest").style = "display: button";
		for(i=0; i<24; i+=1) {
			document.getElementById("item"+i).style = "display: none";
		}
		if (player.quests.length > 0) {
			for(i=0; i<player.quests.length; i+=1) {
				document.getElementById("item"+i).innerHTML = quests.nameArray[player.quests[i]];
				document.getElementById("item"+i).style = "display: listitem";
			}
		}
	}

	function loadEffectSpells() {
		document.getElementById("gameListTitle").innerHTML = "EFFECT SPELLS";
		resetItemElements();
		itemReset();
		document.getElementById("castSpell").style = "display: button";
		document.getElementById("checkEffectSpellInfo").style = "display: button";
		document.getElementById("listAttackSpells").style = "display: button";
		for(i=0; i<24; i+=1) {
			document.getElementById("item"+i).style = "display: none";
		}
		for (i=0; i<player.spells.length; i+=1) {
			document.getElementById("item"+i).innerHTML = player.spells[i].name;
			document.getElementById("item"+i).style = "display: listitem";
		}
	}
	
	function loadAttackSpells() {
		document.getElementById("gameListTitle").innerHTML = "ATTACK SPELLS";
		resetItemElements();
		itemReset();
		document.getElementById("checkAttackSpellInfo").style = "display: button";
		document.getElementById("listEffectSpells").style = "display: button";
		for(i=0; i<24; i+=1) {
			document.getElementById("item"+i).style = "display: none";
		}
		for (i=0; i<player.spellsAttack.length; i+=1) {
			document.getElementById("item"+i).innerHTML = player.spellsAttack[i].name;
			document.getElementById("item"+i).style = "display: listitem";
		}
	}
	
	function setBuySellVars(setBuy, setSell) {
		for(i=0; i<24; i+=1) {
			buyVarArray[i] = setBuy;
			sellVarArray[i] = setSell;
		}
	}
	
	function resetShopButtons() {
		document.getElementById("shopCheckItem").style = "display: none";
		document.getElementById("shopCheckWeapon").style = "display: none";
		document.getElementById("shopCheckArmor").style = "display: none";
	}
	
	function loadShop() {
		document.getElementById("storePopUp").style = "display: block; background: blue; width: 900; height: 500; top: 100px; left: 275px; position: fixed;";
		document.getElementById("storePrompt").innerHTML = "What would you like to buy or sell?";
		document.getElementById("depositGold").style = "display: none";
		document.getElementById("withdrawGold").style = "display: none";
		loadShopInventory();
	}
	
	function loadBank() {
		document.getElementById("storePopUp").style = "display: block; background: blue; width: 900; height: 500; top: 100px; left: 275px; position: fixed;";
		document.getElementById("storePrompt").innerHTML = "What would you like to withdraw or deposit?";
		document.getElementById("depositGold").style = "display: button";
		document.getElementById("withdrawGold").style = "display: button";
		loadShopInventory();
	}
	function loadLoot() {
		document.getElementById("storePopUp").style = "display: block; background: blue; width: 900; height: 500; top: 100px; left: 275px; position: fixed;";
		document.getElementById("storePrompt").innerHTML = "Gather your loot from the enemy. ";
		document.getElementById("depositGold").style = "display: none;";
		document.getElementById("withdrawGold").style = "display: button;";
		document.getElementById("withdrawGold").innerHTML = "Loot Gold";
		loadShopInventory();
	}
	
	function exitShop() {
		document.getElementById("storePopUp").style = "display: none";
		displayChar();
		loadInventory();
	}
	
	function loadShopInventory() {
		resetShopButtons();
		document.getElementById("shopCheckItem").style = "display: button";
		document.getElementById("shopListTitle0").innerHTML = "INVENTORY";
		document.getElementById("shopListTitle1").innerHTML = "INVENTORY";
		for(i=0; i<24; i+=1) {
			document.getElementById("sell"+i).style = "display: none";
		}
		for(i=0; i<60; i+=1) {
			document.getElementById("buy"+i).style = "display: none";
		}
		for(i=0; i<player.items.length; i+=1) {
			var salePrice = player.items[i].value;
			salePrice -= Math.ceil(salePrice/10);
			document.getElementById("sell"+i).innerHTML = player.items[i].name + "(" + player.itemsQuantity[i] + ") (Gold: "+salePrice+")";
			document.getElementById("sell"+i).style = "display: listitem";
		}
		for(i=0; i<currentShop.items.length; i+=1) {
			document.getElementById("buy"+i).innerHTML = currentShop.items[i].name + "(" + currentShop.itemsQuantity[i] + ")";
			document.getElementById("buy"+i).style = "display: listitem";
			document.getElementById("buy"+i).innerHTML += " (Gold: "+currentShop.items[i].value+")";
		}
		document.getElementById("playerGold").innerHTML = "Gold: "+player.gold;
		document.getElementById("shopGold").innerHTML = "Gold: "+currentShop.gold;
		var buyFunc = function(itemNum) {
			buySell(itemNum, 0, "buy", player.items, player.itemsQuantity, currentShop.items, currentShop.itemsQuantity, 1)
		}
		var sellFunc = function(itemNum) {
			buySell(itemNum, 0, "sell", player.items, player.itemsQuantity, currentShop.items, currentShop.itemsQuantity, 1)
		}
		var withdrawFunc = function(itemNum) {
			buySell(itemNum, 0, "withdraw", player.items, player.itemsQuantity, currentShop.items, currentShop.itemsQuantity, 1)
		}
		var depositFunc = function(itemNum) {
			buySell(itemNum, 0, "deposit", player.items, player.itemsQuantity, currentShop.items, currentShop.itemsQuantity, 1)
		}
		if (currentShop.type === "shop") {
			setBuySellVars(buyFunc, sellFunc)
		} else {
			setBuySellVars(withdrawFunc, depositFunc)
		}
	}
	
	function loadShopWeapons() {
		resetShopButtons();
		document.getElementById("shopCheckWeapon").style = "display: button";
		document.getElementById("shopListTitle0").innerHTML = "WEAPONS";
		document.getElementById("shopListTitle1").innerHTML = "WEAPONS";
		for(i=0; i<24; i+=1) {
			document.getElementById("sell"+i).style = "display: none";
		}
		for(i=0; i<60; i+=1) {
			document.getElementById("buy"+i).style = "display: none";
		}
		for(i=0; i<player.weapons.length; i+=1) {
			var salePrice = player.weapons[i].value;
			salePrice -= Math.ceil(salePrice/10);
			document.getElementById("sell"+i).innerHTML = player.weapons[i].name + "(" + player.weaponsQuantity[i] + ")"
			if (player.weaponEquipped === i) {
				document.getElementById("sell"+player.weaponEquipped).innerHTML += " (Equipped)"
			}
			document.getElementById("sell"+i).innerHTML += " (Gold: "+salePrice+")";
			document.getElementById("sell"+i).style = "display: listitem";
		}
		for(i=0; i<currentShop.weapons.length; i+=1) {
			document.getElementById("buy"+i).innerHTML = currentShop.weapons[i].name+"("+currentShop.weaponsQuantity[i]+") (Gold: "+currentShop.weapons[i].value+")";
			document.getElementById("buy"+i).style = "display: listitem";
		}
		document.getElementById("playerGold").innerHTML = "Gold: "+player.gold;
		document.getElementById("shopGold").innerHTML = "Gold: "+currentShop.gold;
		var buyFunc = function(itemNum) {
			buySell(itemNum, 1, "buy", player.weapons, player.weaponsQuantity, currentShop.weapons, currentShop.weaponsQuantity, 1)
		}
		var sellFunc = function(itemNum) {
			buySell(itemNum, 1, "sell", player.weapons, player.weaponsQuantity, currentShop.weapons, currentShop.weaponsQuantity, 1)
		}
		var withdrawFunc = function(itemNum) {
			buySell(itemNum, 1, "withdraw", player.weapons, player.weaponsQuantity, currentShop.weapons, currentShop.weaponsQuantity, 1)
		}
		var depositFunc = function(itemNum) {
			buySell(itemNum, 1, "deposit", player.weapons, player.weaponsQuantity, currentShop.weapons, currentShop.weaponsQuantity, 1)
		}
		if (currentShop.type === "shop") {
			setBuySellVars(buyFunc, sellFunc)
		} else {
			setBuySellVars(withdrawFunc, depositFunc)
		}
		sellVarArray[0] = 0;
	}

	function loadShopArmor() {
		resetShopButtons();
		document.getElementById("shopCheckArmor").style = "display: button";
		document.getElementById("shopListTitle0").innerHTML = "ARMOR";
		document.getElementById("shopListTitle1").innerHTML = "ARMOR";
		for(i=0; i<24; i+=1) {
			document.getElementById("sell"+i).style = "display: none";
		}
		for(i=0; i<60; i+=1) {
			document.getElementById("buy"+i).style = "display: none";
		}
		for(i=0; i<player.armor.length; i+=1) {
			var salePrice = player.armor[i].value;
			salePrice -= Math.ceil(salePrice/10);
			document.getElementById("sell"+i).innerHTML = player.armor[i].name + "(" + player.armorQuantity[i] + ")";
			document.getElementById("sell"+i).style = "display: listitem";
			if (player.armorIsEquipped[i] === true) {
				document.getElementById("sell"+i).innerHTML += " (Equipped: " + player.armor[i].typeName + ")";
			}
			document.getElementById("sell"+i).innerHTML += " (Gold: "+salePrice+")";
		}
		for(i=0; i<currentShop.armor.length; i+=1) {
			document.getElementById("buy"+i).style = "display: listitem";
			document.getElementById("buy"+i).innerHTML = currentShop.armor[i].name+"("+currentShop.armorQuantity[i]+") (Gold: "+currentShop.armor[i].value+")";
		}
		document.getElementById("playerGold").innerHTML = "Gold: "+player.gold;
		document.getElementById("shopGold").innerHTML = "Gold: "+currentShop.gold;
		var buyFunc = function(itemNum) {
			buySell(itemNum, 2, "buy", player.armor, player.armorQuantity, currentShop.armor, currentShop.armorQuantity, 1)
		}
		var sellFunc = function(itemNum) {
			buySell(itemNum, 2, "sell", player.armor, player.armorQuantity, currentShop.armor, currentShop.armorQuantity, 1)
		}
		var withdrawFunc = function(itemNum) {
			buySell(itemNum, 2, "withdraw", player.armor, player.armorQuantity, currentShop.armor, currentShop.armorQuantity, 1)
		}
		var depositFunc = function(itemNum) {
			buySell(itemNum, 2, "deposit", player.armor, player.armorQuantity, currentShop.armor, currentShop.armorQuantity, 1)
		}
		if (currentShop.type === "shop") {
			setBuySellVars(buyFunc, sellFunc)
		} else {
			setBuySellVars(withdrawFunc, depositFunc)
		}
	}
	
	function withdrawGold() {
		if (typeof currentShop.atkString === "undefined") {
			var amount = window.prompt("How much gold would you like to withdraw?")
		} else {
			var amount = combat.opponent.gold;
			document.getElementById("storePrompt").innerHTML = "You looted "+amount+" gold coins. "
		}
		amount = parseInt(amount);
		if (amount > 0 && amount < 1000000) {
			if (amount > currentShop.gold) {
				player.gold += currentShop.gold;
				currentShop.gold = 0;
			} else {
				player.gold += amount;
				currentShop.gold -= amount;
			}
			document.getElementById("playerGold").innerHTML = "Gold: "+player.gold;
			document.getElementById("shopGold").innerHTML = "Gold: "+currentShop.gold;
		} else {window.alert("That is not a valid number."); return;}
	}
	
	function depositGold() {
		var amount = window.prompt("How much gold would you like to deposit?")
		amount = parseInt(amount);
		if (amount > 0 && amount < 1000000) {
			if (amount > player.gold) {
				currentShop.gold += player.gold;
				player.gold = 0;
			} else {
				currentShop.gold += amount;
				player.gold -= amount;
			}
			document.getElementById("playerGold").innerHTML = "Gold: "+player.gold;
			document.getElementById("shopGold").innerHTML = "Gold: "+currentShop.gold;
		} else {window.alert("That is not a valid number."); return;}
	}
	
	function buySell(itemNum, type, action, arr, arrQuantity, storeArr, storeArrQuantity, amount) {
		var str, actionDone, nameArr, valueArray, arrMax, refresh;
		var storeArrMax = currentShop.maxArray
		var shopPitch = "What else would you like to buy or sell?";
		var bankPitch = "What else would you like to withdraw or deposit?";
		var lootPitch = "What else would you like to loot?";
		if (typeof currentShop.atkString !== "undefined") {
			shopPitch = lootPitch;
			bankPitch = lootPitch;
		}
		if (type === 0) {
			str = "item";
			refresh = loadShopInventory;
		} else if (type === 1) {
			str = "weapon";
			refresh = loadShopWeapons;
			if (action === "sell" && itemNum === 0) {
				document.getElementById("storePrompt").innerHTML ="You cannot "+action+" your fists. ";
				return;
			}
		} else if (type === 2) {
			str = "armor";
			refresh = loadShopArmor;
		}
		if (action === "sell") {
			var salePrice = arr[itemNum].value;
			salePrice -= Math.ceil(salePrice/10);
			if (salePrice > currentShop.gold) {
				document.getElementById("storePrompt").innerHTML = currentShop.name+" does not have enough gold. ";
			} else {
				meToYou("sold")	
				document.getElementById("storePrompt").innerHTML += " for "+salePrice+" gold coins. "+shopPitch;
				player.gold += salePrice;
				currentShop.gold -= salePrice;
				refresh();
			}
		} else if (action === "buy") {
			var itemPrice = storeArr[itemNum].value;
			if (itemPrice > player.gold) {
				document.getElementById("storePrompt").innerHTML = "You do not have enough gold. ";
			} else {
				youToMe("bought")
				document.getElementById("storePrompt").innerHTML += " for "+itemPrice+" gold coins. "+shopPitch;
				player.gold -= itemPrice;	
				currentShop.gold += itemPrice;
				refresh();
			}
		} else if (action === "deposit") {
			meToYou("deposited")
			document.getElementById("storePrompt").innerHTML += ". "+bankPitch;
			refresh();
		} else if (action === "withdraw") {
			youToMe("withdrew")
			document.getElementById("storePrompt").innerHTML += ". "+bankPitch;
			refresh();
		}
		function meToYou(actionDone) {
			document.getElementById("storePrompt").innerHTML = "You "+actionDone+" "+amount+" "+arr[itemNum].name;
			addStuff(storeArr, storeArrQuantity, amount, arr[itemNum], str)
			if (arrQuantity[itemNum] < 2){
				removeStuff(arr, arrQuantity, itemNum, str);
			} else {arrQuantity[itemNum] -= amount;}
		}
		function youToMe(actionDone) {
			document.getElementById("storePrompt").innerHTML = "You "+actionDone+" "+amount+" "+storeArr[itemNum].name;
			addStuff(arr, arrQuantity, amount, storeArr[itemNum], str)	
			if (storeArrQuantity[itemNum] < 2){
				removeStuff(storeArr, storeArrQuantity, itemNum, str);
			} else {storeArrQuantity[itemNum] -= amount;}
		}
	}
	
	function checkArrayFull(arr) {
		if(arr.length < 24){
			return false;
		} else {return true;}
	}
	
	function checkQuantityFull(arr,arrQuantity,itemObj) {
		for (i=0; i<arr.length; i+=1) {
			if (arr[i] === itemObj) {
				if (arrQuantity[i] >= itemObj.max) {
					return true;
				}
			}
		}
		return checkArrayFull(arr);
	}
	
	function checkForStuff(arr, itemObj) {
		if (arr.length === 0) {
			return false;
		}
		for (i=0; i<arr.length; i+=1) {
			if (arr[i] === itemObj) {
				return i;
			} else if (i === arr.length-1 && arr[i] !== itemObj) {
				return false;
			}
		}
	}

	function addStuff(arr, arrQuantity, amount, itemObj, str) {
		var location = checkForStuff(arr, itemObj);
		if (location !== false) {
			if (arrQuantity !== 0) {
				if (arrQuantity[location]+amount >= arr[location].max) {
					return dropStuff(arr, arrQuantity, str);
				} else {
					arrQuantity[location] += amount;
				}	
			} else {
				goBack("You already know this spell. ");
			}
		} else {
			if (arr.length < 24) {
				arr.push(itemObj);
				if (arrQuantity !== 0) {
					arrQuantity.push(amount);
				}
				if (str === "armor") {
					player.armorIsEquipped.push(false);
				}
			}
		}
		delete location;
	}
	
function removeStuff(arr, arrQuantity, itemNum, str) {
	if (str === "item") {
		spliceStuff(itemNum)
		loadInventory();
	} else if (str === "weapon") {
		if (player.weaponEquipped === itemNum) {player.weaponEquipped = 0;}
		else if (player.weaponEquipped > itemNum && player.weaponEquipped !== 0) {player.weaponEquipped -= 1;}
		spliceStuff(itemNum)
		loadWeapons();
	} else if (str === "armor") {
		if (arr === player.armor) {
			for (i=0; i<player.armorTypeEquipped.length; i+=1) {
				if (player.armorTypeEquipped[i] === player.armor[itemNum].typeName) {
					player.armorTypeEquipped.splice(i,1)
				}
			}
			player.armorIsEquipped.splice(itemNum, 1);
		}
		spliceStuff(itemNum);
		loadArmor();
	}
	function spliceStuff(itemNum) {
		arr.splice(itemNum, 1);
		arrQuantity.splice(itemNum, 1);
	}
}
	
	function equipStuff(itemType) {
		if (itemType === 0) {
			equipWeapon();
		} else {
			equipArmor();
		}
		function equipWeapon() {
			goBack("Click the weapon you would like to equip.");
			if (combat.active === true) {
				buttonVarArray[0] = combat.displayAttacks;
			}
			loadWeapons();
			itemSet(weaponEquipped);
		}
		function equipArmor() {
			if (combat.active === true) {
				return;
			}
			goBack("Click the armor you would like to equip.");
			loadArmor();
			itemSet(armorEquipped);
		}
		function weaponEquipped(itemNum) {
			var ammo = player.weapons[itemNum].name === "arrow" || player.weapons[itemNum].name === "bolt" || player.weapons[itemNum].name === "bullet";
			var classLvl = checkClass(player.weapons[itemNum]);
			if (ammo === true) {
				document.getElementById("prompt").innerHTML = "You cannot equip ammo. ";
			} else if (typeof classLvl === "string") {
				document.getElementById("prompt").innerHTML = "You must be of the "+classLvl+" class to use this weapon. "
			} else if (typeof classLvl === "number") {
				document.getElementById("prompt").innerHTML = "You must be at least level "+classLvl+" to use this weapon. "
			} else if (player.weaponEquipped === itemNum) {
				if (itemNum === 0) {
					document.getElementById("prompt").innerHTML = "You cannot put your fists away. "
					return;
				}
				goBack("The "+player.weapons[itemNum].name+" was put away.");
				if (combat.active === true) {
					combat.turns[0] = true;
				}
				player.weaponEquipped = 0;
			} else {
				if (combat.active === true) {
					combat.playerAction = [4,itemNum];
					combat.startRound();
					return;
				} else {
					playerEquip(itemNum);
				}
			}
			loadWeapons();
			itemSet(weaponEquipped);
		}
		function armorEquipped(itemNum) {
			function alreadyWearing() {
				goBack("You are already wearing ");
				if (player.armor[itemNum].typeName === "buckler" || player.armor[itemNum].typeName === "shield") {
					document.getElementById("prompt").innerHTML += "a shield. "
				} else {document.getElementById("prompt").innerHTML += "something on your "+player.armor[itemNum].typeName+".";}
				itemSet(armorEquipped);
			}
			var classLvl = checkClass(player.armor[itemNum]);
			if (typeof classLvl === "string") {
				document.getElementById("prompt").innerHTML = "You must be of the "+classLvl+" class to use this weapon. "
				loadArmor();
				itemSet(armorEquipped);
				return;
			} else if (typeof classLvl === "number") {
				document.getElementById("prompt").innerHTML = "You must be at least level "+classLvl+" to use this weapon. "
				loadArmor();
				itemSet(armorEquipped);
				return;
			}
			if (player.armorIsEquipped[itemNum] !== true) {
				if (checkForStuff(player.armorTypeEquipped,player.armor[itemNum].typeName) === false) {
					if (player.armor[itemNum].typeName === "shield" && checkForStuff(player.armorTypeEquipped,"buckler") !== false) {
						alreadyWearing();
						return;
					} else if (player.armor[itemNum].typeName === "buckler" && checkForStuff(player.armorTypeEquipped,"shield") !== false) {
						alreadyWearing();
						return;
					}
					player.armorIsEquipped[itemNum] = true;
					player.armorTypeEquipped.push(player.armor[itemNum].typeName);
					goBack("The "+player.armor[itemNum].name+" was equipped. ");
					if (player.armor[itemNum].resistance !== false) {
						player.weakness.push(player.armor[itemNum].resistance)
					}
				} else {alreadyWearing();} 
			} else {
				player.armorIsEquipped[itemNum] = false;
				var location = checkForStuff(player.armorTypeEquipped,player.armor[itemNum].typeName);
				player.armorTypeEquipped.splice(location,1);
				goBack("The "+player.armor[itemNum].name+" was taken off. ");
				if (player.armor[itemNum].resistance !== false) {
					removeWeakness(player.armor[itemNum].resistance)
				}
			}
			if (player.weapons[player.weaponEquipped].twoHanded === true && checkForStuff(player.armorTypeEquipped,"shield") !== false) {
				player.weaponEquipped = 0;
				document.getElementById("prompt").innerHTML += "However, you had to put up your weapon to hold it.";
			}
			loadArmor();
			itemSet(armorEquipped);
		}
	}
	
	function playerEquip(itemNum) {
		goBack("The "+player.weapons[itemNum].name+" has been equipped. ");
		if (player.weapons[itemNum].twoHanded === true) {
			for (i=0; i<player.armor.length; i+=1) {
				if (player.armor[i].typeName === "shield" && player.armorIsEquipped[i] === true) {
					player.armorIsEquipped[i] = false;
					player.armorTypeEquipped.splice(checkForStuff(player.armorTypeEquipped,"shield"), 1)
					document.getElementById("prompt").innerHTML += "However, you had to take off your shield to hold it.";
					if (player.armor[i].resistance !== false) {
						removeWeakness(player.armor[i].resistance)
					}
					break;
				}
			}
		}
		player.weaponEquipped = itemNum;
		loadWeapons();
	}
	
	function removeWeakness(weak) {
		for (i=0; i<player.weakness.length; i+=1) {
			if (weak === player.weakness[i]) {
				player.weakness.splice(i,1);
			}
		}
	}
	
	function checkInfo(type, isShop) {	
		if (isShop === true) {
			document.getElementById("storePrompt").innerHTML = "Click the "+type+" you would like info on. ";
			setBuySellVars(checkShop, check)
		} else {
			goBack("Click the "+type+" you would like info on. ")
			itemSet(check);
		}
		function check(itemNum) {
			if (type === "item") {
				window.alert(player.items[itemNum].info)
			} else if (type === "weapon") {
				window.alert(player.weapons[itemNum].info)
			} else if (type === "armor") {
				window.alert(player.armor[itemNum].info)
			} else if (type === "effect spell") {
				window.alert(player.spells[itemNum].info)
			} else if (type === "attack spell") {
				window.alert(player.spellsAttack[itemNum].info)
			} else if (type === "quest") {
				if (player.questProgress[quests.find(itemNum)] >= quests.array[player.quests[itemNum]].length) {
					window.alert("Quest Complete: "+quests.nameArray[player.quests[itemNum]])
					return;
				} else {
					window.alert(quests.array[player.quests[itemNum]][player.questProgress[itemNum]])
				}
			}
		}
		function checkShop(itemNum) {
			if (type === "item") {
				window.alert(currentShop.items[itemNum].info)
			} else if (type === "weapon") {
				window.alert(currentShop.weapons[itemNum].info)
			} else if (type === "armor") {
				window.alert(currentShop.armor[itemNum].info)
			}
		}
	}
	
	function castSpell() {
		if (combat.active === true) {
			return;
		}
		loadEffectSpells();
		goBack("Click the effect spell you would like to cast. ")
		itemSet(cast);
		function cast(spellNum) {
			if (player.spells[spellNum].mannaCost>player.manna) {
				goBack("You do not have enough manna.")
			} else {
				player.spells[spellNum].use(player);
				displayChar();
			}
		}
	}
	
function checkClass(itemObj) {
	if (itemObj.class.length === 0) {
		return true;
	}
	for (i=0; i<itemObj.class.length; i+=1) {
		var cls = itemObj.class[i].toLowerCase();
		var lvl = parseInt(cls[cls.length-1]);
		cls = cls.slice(0, cls.length-1);
		if (cls === "any" || player.class.toLowerCase() === cls) {
			if (lvl === 0 || player.level === lvl) {
				return true;
			} else {
				return lvl;
			}
		} else if (i === itemObj.class.length-1 && player.class !== cls) {
			return cls;
		}
	}
}
	
	var items = new Object();
		
	items.potion = function(target, itemNum, statString, str, spellName) {
		var stat, statMax, statType, old, name;
		if (statString === "health") {stat = target.health; old = target.health; statMax = target.hitPoints; statType = "health";}
		else if (statString === "manna") {stat = target.manna; old = target.manna; statMax = target.mannaMax; statType = "manna";}
		if (target === player) {
			if (spellName === 0) {
				name = "You used a "+statType+" potion and"
			} else {
				name = "You cast a "+spellName+" spell and"
			}
		} else {
			if (spellName === 0) {
				name = combat.opponent.name+" used a "+statType+" potion and"
			} else {
				name = combat.opponent.name+" cast a "+spellName+" spell and"
			}
		}
		function boostStat(stat, statMax, statType, str) {
			var roll = rng(8) + 5;
			if (str === 0) {
				stat += roll;
			} else if (str === 1) {
				stat += 2*roll;
			} else if (str === 2) {
				stat += 4*roll;
			} else if (str === 3) {
				stat += 8*roll;
			}
			if (spellName !== 0) {
				if (str === 0) {
					if (spells.testManna(target, 10) !== false) {target.manna -= 10;}
				} else if (str === 1) {
					if (spells.testManna(target, 20) !== false) {target.manna -= 20;}
				} else if (str === 2) {
					if (spells.testManna(target, 30) !== false) {target.manna -= 30;}
				} else if (str === 3) {
					if (spells.testManna(target, 40) !== false) {target.manna -= 40;}
				}
			}
			if (stat > statMax){
				stat = statMax;
			}
			return stat;
		}
		if (statString === "health") {
			if (stat === statMax) {
				goBack("You're already at full " + statType + ".");
				if (combat.active === true) {
					buttonVarArray[0] = combat.displayAttacks;
				}
				loadInventory();
				itemSet(items.use);
				return;
			} else {
				target.health = boostStat(stat, statMax, statType, str);
				goBack(name+" gained "+(target.health-old)+" health points.");
				displayChar();
			}
		} else if (statString === "manna") {
			if (stat === statMax) {
				goBack("You're already at full " + statType + ".")
				if (combat.active === true) {
					buttonVarArray[0] = combat.displayAttacks;
				}
				loadInventory();
				itemSet(items.use);
				return;
			} else {
				target.manna = boostStat(stat, statMax, statType, str);
				goBack(name+" gained "+(target.manna-old)+" manna points.");
				displayChar();
			}
		}
		displayChar();
		if (spellName === 0) {
			items.useUp(target, itemNum);
		}
		loadInventory();
		itemSet(items.use);
	}
	
items.weakPotion = {
	name: "Weak Potion",
	use: function(target, itemNum) {items.potion(target, itemNum, "health", 0, 0);},
	info: "restores 6-13 health points",
	value: 20,
	max: 20
}
items.mediumPotion = {
	name: "Medium Potion",
	use: function(target, itemNum) {items.potion(target, itemNum, "health", 1, 0);},
	info: "restores 12-26 health points",
	value: 40,
	max: 20

}
items.strongPotion = {
	name: "Strong Potion",
	use: function(target, itemNum) {items.potion(target, itemNum, "health", 2, 0);},
	info: "restores 24-52 health points",
	value: 60,
	max: 20
}
items.veryStrongPotion = {
	name: "Very Strong Potion",
	use: function(target, itemNum) {items.potion(target, itemNum, "health", 3, 0);},
	info: "restores 48-104 health points",
	value: 80,
	max: 20
}
items.weakMannaPotion = {
	name: "Weak Manna Potion",
	use: function(target, itemNum) {items.potion(target, itemNum, "manna", 0, 0);},
	info: "restores 6-13 manna points",
	value: 20,
	max: 20
}
items.mediumMannaPotion = {
	name: "Medium Manna Potion",
	use: function(target, itemNum) {items.potion(target, itemNum, "manna", 1, 0);},
	info: "restores 12-26 manna points",
	value: 40,
	max: 20
}
items.strongMannaPotion = {
	name: "Strong Manna Potion",
	use: function(target, itemNum) {items.potion(target, itemNum, "manna", 2, 0);},
	info: "restores 24-52 manna points",
	value: 60,
	max: 20
}
items.veryStrongMannaPotion = {
	name: "Very Strong Manna Potion",
	use: function(target, itemNum) {items.potion(target, itemNum, "manna", 3, 0);},
	info: "restores 48-104 manna points",
	value: 80,
	max: 20
}
items.spellBookFireBall = {
	name: "Spell Book (Fire Ball)",
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.fireball, itemNum);},
	info: "teaches the spell Fireball",
	value: 30,
	max: 5
}
items.spellBookLightningBolt = {
	name: "Spell Book (Lightning Bolt)",
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.lightningBolt, itemNum);},
	info: "teaches the spell Lightning Bolt", 
	value: 40,
	max: 5
}
items.spellBookGust = {
	name: "Spell Book (Gust)", 
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.gust, itemNum);},
	info: "teaches the spell Gust",
	value: 20,
	max: 5
}
items.spellBookFrost = {
	name: "Spell Book (Frost Beam)",
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.frostBeam, itemNum);},
	info: "teaches the spell Frost Beam",
	value: 30,
	max: 5
}
items.spellBookBlizzard = {
	name: "Spell Book (Blizzard)",
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.blizzard, itemNum);},
	info: "teaches the spell Blizzard",
	value: 60,
	max: 5
}
items.spellBookHurricane = {
	name: "Spell Book (Hurricane)",
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.hurricane, itemNum);},
	info: "teaches the spell Hurricane",
	value: 50,
	max: 5
}
items.spellBookSunBurst = {
	name: "Spell Book (Sun Burst)", 
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.sunBurst, itemNum);},
	info: "teaches the spell Sun Burst",
	value: 60,
	max: 5
}
items.spellBookInferno = {
	name: "Spell Book (Inferno)",
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.inferno, itemNum);},
	info: "teaches the spell Inferno", 
	value: 75,
	max: 5
}
items.spellBookDeathRay = {
	name: "Spell Book (Death Ray)", 
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.deathRay, itemNum);},
	info: "teaches the spell Death Ray", 
	value: 60,
	max: 5
}
items.spellBookPoisonSlash = {
	name: "Spell Book (Poison Slash)",
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.poisonSlash, itemNum);},
	info: "teaches the spell Poison Slash",
	value: 60,
	max: 5
}
items.spellBookEntangle = {
	name: "Spell Book (Entangle)",
	use: function(target, itemNum) {items.spellBook(player.spellsAttack, spells.attack.entangle, itemNum);},
	info: "teaches the spell Engangle", 
	value: 50,
	max: 5
}
items.spellBookWeakHealing = {
	name: "Spell Book (Weak Healing)",
	use: function(target, itemNum) {items.spellBook(player.spells, spells.weakHealing, itemNum);},
	info: "teaches the spell Weak Healing",
	value: 40,
	max: 5
}
items.spellBookMediumHealing = {
	name: "Spell Book (Medium Healing)",
	use: function(target, itemNum) {items.spellBook(player.spells, spells.mediumHealing, itemNum);},
	info: "teaches the spell Medium Healing",
	value: 60,
	max: 5
}
items.spellBookStrongHealing = {
	name: "Spell Book (Strong Healing)",
	use: function(target, itemNum) {items.spellBook(player.spells, spells.strongHealing, itemNum);},
	info: "teaches the spell Strong Healing",
	value: 80,
	max: 5
}
items.spellBookVeryStrongHealing = {
	name: "Spell Book (Very Strong Healing)",
	use: function(target, itemNum) {items.spellBook(player.spells, spells.veryStrongHealing, itemNum);},
	info: "teaches the spell Very Strong Healing",
	value: 100,
	max: 5
}
items.spellBookBullStrength = {
	name: "Spell Book (Bull Strength)",
	use: function(target, itemNum) {items.spellBook(player.spells, spells.bullStrength, itemNum);},
	info: "teaches the spell Bull Strength",
	value: 50,
	max: 5
}
items.spellBookFocus = {
	name: "Spell Book (Focus)", 
	use: function(target, itemNum) {items.spellBook(player.spells, spells.focus, itemNum);},
	info: "teaches the spell Focus",
	value: 50,
	max: 5
}
items.spellBookConcentration = {
	name: "Spell Book (Concentration)", 
	use: function(target, itemNum) {items.spellBook(player.spells, spells.concentration, itemNum);},
	info: "teaches the spell Concentration", 
	value: 50,
	max: 5
}
items.spellBookMageArmor = {
	name: "Spell Book (Mage Armor)", 
	use: function(target, itemNum) {items.spellBook(player.spells, spells.mageArmor, itemNum);},
	info: "teaches the spell Mage Armor",
	value: 50,
	max: 5
}
items.spellBookRestoration = {
	name: "Spell Book (Restoration)", 
	use: function(target, itemNum) {items.spellBook(player.spells, spells.restoration, itemNum);},
	info: "teaches the spell Restoration",
	value: 50,
	max: 5
}
items.potionOfRestoration = {
	name: "Potion Of Restoration",
	use: function(target, itemNum) {
		if (target.status.length === 0) {
			goBack("You do not need to be restored. ")
			if (combat.active === true) {
				buttonVarArray[0] = combat.displayEffectSpells;
			}
		} else {
			target.status = []
			target.statusRounds = []
			goBack("You have been restored. ")
			if (itemNum !== "spell") {
				items.useUp(target, itemNum);
			}
			if (combat.active === true) {
				if (target === player) {
					combat.turns[0] = true;
				} else {
					combat.turns[1] = true;
				}
			}
		}
	},
	info: "cures any status effects",
	value: 40,
	max: 20
}
items.spellBook = function(arr, spellObj, itemNum) {
	if (items.combatCancel()) {return;}
	if (checkForSpell() !== true) {
		goBack("You just learned the "+spellObj.name+" spell. The Spell Book has burned up. ");
		addStuff(arr, 0, 0, spellObj, "spell");
		items.useUp(player, itemNum);
		loadInventory();
		itemSet(items.use);
	}
	function checkForSpell() {
		for (i=0.; i<24; i+=1) {
			if (arr[i] === spellObj) {
				goBack("You already learned the "+spellObj.name+" spell.");
				return true;
			}
		}
	}
}	
items.fatsosPurse = {
	name: "Fatso's Purse",
	use: function() {
		if (items.combatCancel()) {return;}
		goBack("You open Fatso's purse and find 150 gold coins. ")
		player.gold += 150;
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.fatsosPurse), "item");
		displayChar();
		loadInventory();
	},
	info: "A coin bag you stole from Fatso. It probably has gold coins in it.",
	value: 0,
	max: 5
}
items.commonHerbs = {
	name: "Common Herbs", 
	use: function(){},
	info: "A jar of common herbs.", 
	value: 3,
	max: 10
}
items.modRareHerbs = {
	name: "Moderately Rare Herbs",
	use: function(){},
	info: "A jar of somewhat rare herbs.", 
	value: 10,
	max: 10
}
items.rareHerbs = {
	name: "Very Rare Spices",
	use: function(){},
	info: "A jar of extremely rare spices spices.",
	value: 25,
	max: 10
}
items.cayenne = {
	name: "Cayenne Pepper",
	use: function(){},
	info: "A jar of cayenne pepper.", 
	value: 25,
	max: 10
}
items.emptyJar = {
	name: "Empty Jar",
	use: function(){},
	info: "An empty jar.",
	value: 1,
	max: 10
}
items.burnOintment = {
	name: "Jar of Burn Ointment", 
	use: function(target, itemNum) {
		if (checkForStuff(player.status, "burned") !== false) {
			goBack("Your burns have been healed.")
			combat.removeStatus(player, "burned")
			removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.burnOintment), "item");
			displayChar();
			loadInventory();
		} else {
			goBack("There's no reason for you to use this right now.")
		}
	},
	info: "A jar of burn ointment. Cures burn status. This is Fatso's special blend. You probably should not sell this at a regular store.", 
	value: 0,
	max: 10
}
items.rareWine = {
	name: "Rare Wine",
	use: function(target, itemNum) {
		if (items.combatCancel()) {return;}
		goBack("You drink the wine ")
		if (rng(20) > 15) {
			document.getElementById("prompt").innerHTML += "and get a little drunk."
			combat.boostTempStat(0, -3, 5, 1);
			combat.boostTempStat(0, -3, 5, 2);
		} else {
			document.getElementById("prompt").innerHTML += "and handle it pretty well. "
		}
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.rareWine), "item");
	},
	info: "A rare bottle of vintage wine. It is very rare, and it is likely that no one in town but Fatso has it. You probably should not sell this at a regular store.",
	value: 0,
	max: 5
}
items.tapestry = {
	name: "Tapestry", 
	use: function(){},
	info: "A finely woven tapestry. It was obviously stolen from Fatso. You probably should not sell this at a regular store.", 
	value: 0,
	max: 2
}
items.hookah = {
	name: "Hookah",
	use: function(){},
	info: "A rusty and well used hookah.", 
	value: 15,
	max: 5
}
items.goldKey = {
	name: "Gold Key",
	use: function(){},
	info: "A golden key engraved with Fatso's monogram. You probably should not sell this at a regular store.",
	value: 0,
	max: 15
}
items.pillow = {
	name:"Pillow", 
	use: function(){},
	info: "A fancy silk pillow.",
	value: 25,
	max: 5
}
items.teaService = {
	name: "Porcelain Tea Service",
	use: function(){},
	info: "A porcelain tea service including a teapot, four cups, four saucers, and a porcelain sugar jar. ", 
	value: 100,
	max: 3
}
items.brokenTeaService = {
	name: "Tea Service (broken)",
	use: function(){},
	info: "This tea service has been smashed to pieces in your bag. It's worthless now.", 
	value: 0,
	max: 5
}
items.spoon = {
	name: "Spoon", 
	use: function(){},
	info: "A decorative spoon with an engraving on it. You probably should not sell this at a regular store.",
	value: 0,
	max: 15
}
items.oilyBag = {
	name: "Oily Bag",
	use: function() {
		if (items.combatCancel()) {return;}
		goBack("You open the oily bag and find a bunch of brightly colored gems. ")
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.oilyBag), "item");
		addStuff(player.items, player.itemsQuantity, 1, items.oilyBag, "item");
		loadInventory();
	},
	info: "An oily bag with a seal on it. You haven't opened it yet. ", 
	value: 0,
	max: 10
}
items.bagOfGems = {
	name: "Bag of Gems",
	use: function(){},
	info: "A bag of brightly colored gems. Each gem has an engraving on it. You probably should not sell this at a regular store.",
	value: 0,
	max: 10
}
items.candleStick = {
	name: "Candle Stick",
	use: function(){},
	info: "A source of light for navigating dark places. ",
	value: 5,
	max: 15
}
items.fatsosPapers = {
	name: "Fatso's Papers",
	use: function(){},
	info: "A stack of papers you stole from Fatso's house. They contain old love letters, a pedigree for a canary, 100 shares in a corporation long dead, a collection of bawdy limericks, and a good citizenship award. You probably should not show these around. Somebody might recognize who they're for.",
	value: 0,
	max: 2
}
items.combatCancel = function() {
	if (combat.active === true) {
		goBack("You cannot use this item during combat.");
		buttonVarArray[0] = useItem;
		return true;
	}
}	
items.array = [
	items.weakPotion, items.mediumPotion, items.strongPotion, items.veryStrongPotion, items.weakMannaPotion, items.mediumMannaPotion, items.strongMannaPotion,		//0-6
	items.veryStrongMannaPotion, items.potionOfRestoration, items.spellBookFireBall, items.spellBookLightningBolt, items.spellBookGust, items.spellBookFrost,		//7-12
	items.spellBookWeakHealing,items.spellBookMediumHealing, items.spellBookStrongHealing, items.spellBookVeryStrongHealing, items.spellBookBullStrength,			//13-17
	items.spellBookFocus, items.spellBookConcentration, items.spellBookMageArmor, items.spellBookRestoration, items.spellBookBlizzard, items.spellBookHurricane,	//18-23
	items.spellBookSunBurst, items.spellBookInferno, items.spellBookDeathRay, items.spellBookPoisonSlash, items.spellBookEntangle, items.fatsosPurse, 				//24-29
	items.rareWine, items.commonHerbs, items.modRareHerbs, items.rareHerbs, items.cayenne, items.emptyJar, items.burnOintment, items.tapestry, items.hookah, 		//30-38
	items.goldKey, items.pillow, items.teaService, items.brokenTeaService, items.spoon, items.oilyBag, items.bagOfGems, items.candleStick, items.fatsosPapers		//39-47
];
items.use = function(itemNum) {player.items[itemNum].use(player, itemNum);}
items.useUp = function(target, itemNum) {
	if (target.itemsQuantity[itemNum] > 1) {
		target.itemsQuantity[itemNum] -= 1;
	} else if (target.itemsQuantity[itemNum] === 1){
		removeStuff(target.items, target.itemsQuantity, itemNum, "item");
	} 
}
function useItem() {
	goBack("Click the item you would like to use.");
	loadInventory();
	if (combat.active === true) {
		buttonVarArray[0] = combat.displayAttacks;
		itemSet(setItemNum);		
	} else {
		itemSet(items.use);
	}
	function setItemNum(itemNum) {
		combat.playerAction = [3, itemNum];
		combat.startRound();
	}
}

var weapons = new Object();

weapons.base = function() {
	var e = new Object();
	e.effect = false;
	e.effectChance = 0;
	e.projectile = false;
	e.twoHanded = false;
	e.enemyAtk = false;
	e.class = [];
	return e;
}

//projectiles have to be listed first so that other weapons can have pointers to them.

weapons.arrow = {
	name: "arrow",
	use: function() {},
	bonus: false,
	dmgType: "piercing",
	effect: false,
	effectChance: 0,
	projectile: false,
	twoHanded: true,
	enemyAtk: false,
	info: "Ammo for bow and longbow.",
	value: 1,
	max: 100
}
weapons.bolt = {
	name: "bolt",
	use: function() {},
	bonus: false,
	dmgType: "piercing",
	effect: false,
	effectChance: 0,
	projectile: false,
	twoHanded: true,
	enemyAtk: false,
	info: "Ammo for crossbow",
	value: 1,
	max: 100
}
weapons.bullet = {
	name: "bullet",
	use: function() {},
	bonus: false,
	dmgType: "bludgeoning",
	effect: false,
	effectChance: 0,
	projectile: false,
	twoHanded: true,
	enemyAtk: false,
	info: "Ammo for slingshot",
	value: 1,
	max: 100
}
weapons.throwingKnife = {
	name: "throwing knife",
	use: function() {return rng(6);},
	bonus: 1,
	dmgType: "piercing",
	effect: false,
	effectChance: 0,
	projectile: false,
	twoHanded: false,
	enemyAtk: false,
	info: "Small throwing knives. Deals up to 6 piercing damage plus DEX modifier.",
	value: 3,
	max: 100
}

weapons.fist = weapons.base();
weapons.fist.name = "fist";
weapons.fist.use = function() {return rng(3)};
weapons.fist.bonus = 0;
weapons.fist.dmgType = "bludgeoning";
weapons.fist.info = "Your fists. Deals up to 3 bludgeoning damage plus STR modifier.";
weapons.fist.value = 0;
weapons.fist.max = 2;

weapons.dagger = weapons.base();
weapons.dagger.name = "dagger";
weapons.dagger.use = function() {return rng(4)};
weapons.dagger.bonus = 0;
weapons.dagger.dmgType = "piercing";
weapons.dagger.info = "A small dagger with 1ft sharp edge. Deals up to 4 piercing damage plus STR modifier.";
weapons.dagger.value = 20;
weapons.dagger.max = 10;
weapons.dagger.class = ["rogue1","warrior3","mage4"];

weapons.shortsword = weapons.base();
weapons.shortsword.name = "shortsword";
weapons.shortsword.use = function() {return rng(6);};
weapons.shortsword.bonus = 0;
weapons.shortsword.dmgType = "slashing";
weapons.shortsword.info = "Single-edged shortsword. Deals up to 6 slashing damage plus STR modifier.";
weapons.shortsword.value = 40;
weapons.shortsword.max = 8;

weapons.longsword = weapons.base();
weapons.longsword.name = "longsword";
weapons.longsword.use = function() {return rng(8);};
weapons.longsword.bonus = 0;
weapons.longsword.dmgType = "slashing";
weapons.longsword.info = "Single-edged longsword. Deals up to 8 slashing damage plus STR modifier.";
weapons.longsword.value = 75;
weapons.longsword.max = 5;

weapons.greatsword = weapons.base();
weapons.greatsword.name = "greatsword";
weapons.greatsword.use = function() {return rng(10);};
weapons.greatsword.bonus = 0;
weapons.greatsword.dmgType = "slashing";
weapons.greatsword.twoHanded = true;
weapons.greatsword.info = "Double-edged greatsword. Two-Handed. Deals up to 10 slashing damage plus STR modifier.";
weapons.greatsword.value = 100;
weapons.greatsword.max = 5;

weapons.axe = weapons.base();
weapons.axe.name = "axe";
weapons.axe.use = function() {return rng(6);};
weapons.axe.bonus = 0;
weapons.axe.dmgType = "slashing";
weapons.axe.info = "Small single-sided axe. Deals up to 6 slashing damage plus STR modifier.";
weapons.axe.value = 60;
weapons.axe.max = 5;

weapons.greataxe = weapons.base();
weapons.greataxe.name = "greataxe";
weapons.greataxe.use = function() {return rng(12);};
weapons.greataxe.bonus = 0;
weapons.greataxe.dmgType = "slashing";
weapons.greataxe.twoHanded = true;
weapons.greataxe.info = "Double-sided battleaxe. Two-Handed. Deals up to 12 slashing damage plus STR modifier.";
weapons.greataxe.value = 120;
weapons.greataxe.max = 5;

weapons.maul = weapons.base();
weapons.maul.name = "maul";
weapons.maul.use = function() {return rng(6);};
weapons.maul.bonus = 0;
weapons.maul.dmgType = "bludgeoning";
weapons.maul.effect = "prone";
weapons.maul.effectChance = 0.2;
weapons.maul.info = "Weighed unspiked mace. Deals up to 6 bludgeoning damage plus STR modifier.";
weapons.maul.value = 50;
weapons.maul.max = 5

weapons.warhammer = weapons.base();
weapons.warhammer.name = "warhammer";
weapons.warhammer.use = function() {return rng(12);};
weapons.warhammer.bonus = 0;
weapons.warhammer.dmgType = "bludgeoning";
weapons.warhammer.effect = "unconscious";
weapons.warhammer.effectChance = 0.2;
weapons.warhammer.twoHanded = true;
weapons.warhammer.info = "Large warhammer. Two-Handed. Deals up to 12 bludgeoning damage plus STR modifier.";
weapons.warhammer.value = 110;
weapons.warhammer.max = 5

weapons.spear = weapons.base();
weapons.spear.name = "spear";
weapons.spear.use = function() {return rng(6);};
weapons.spear.bonus = 1;
weapons.spear.dmgType = "piercing";
weapons.spear.info = "6ft spear. Deals up to 6 piercing damage plus DEX modifier.";
weapons.spear.value = 50;
weapons.spear.max = 5;

weapons.bow = weapons.base();
weapons.bow.name = "bow";
weapons.bow.use = function() {return rng(6);};
weapons.bow.bonus = 1;
weapons.bow.dmgType = "piercing";
weapons.bow.projectile = weapons.arrow;
weapons.bow.twoHanded = true;
weapons.bow.info = "Wooden bow. Two-Handed. Deals up to 6 piercing damage plus DEX modifier.";
weapons.bow.value = 60;
weapons.bow.max = 5;

weapons.longbow = weapons.base();
weapons.longbow.name = "longbow";
weapons.longbow.use = function() {return rng(8);};
weapons.longbow.bonus = 1;
weapons.longbow.dmgType = "piercing";
weapons.longbow.projectile = weapons.arrow;
weapons.longbow.twoHanded = true;
weapons.longbow.info = "Wooden longbow. Two-Handed. Deals up to 8 piercing damage plus DEX modifier.";
weapons.longbow.value = 80;
weapons.longbow.max = 5;

weapons.crossbow = weapons.base();
weapons.crossbow.name = "crossbow";
weapons.crossbow.use = function() {return rng(10);};
weapons.crossbow.bonus = 1;
weapons.crossbow.dmgType = "piercing";
weapons.crossbow.projectile = weapons.bolt;
weapons.crossbow.twoHanded = true;
weapons.crossbow.info = "Wooden crossbow. Two-Handed. Deals up to 10 piercing damage plus DEX modifier.";
weapons.crossbow.value = 100;
weapons.crossbow.max = 5;

weapons.slingShot = weapons.base();
weapons.slingShot.name = "sling shot";
weapons.slingShot.use = function() {return rng(4);};
weapons.slingShot.bonus = 1;
weapons.slingShot.dmgType = "bludgeoning";
weapons.slingShot.effect = "blinded";
weapons.slingShot.effectChance = 0.2;
weapons.slingShot.projectile = weapons.bullet;
weapons.slingShot.twoHanded = true;
weapons.slingShot.info = "Wooden sling shot. Two-Handed. Deals up to 4 bludgeoning damage plus DEX modifier.";
weapons.slingShot.value = 40;
weapons.slingShot.max = 10;

weapons.flail = weapons.base();
weapons.flail.name = "flail";
weapons.flail.use = function() {return rng(6);};
weapons.flail.bonus = 0;
weapons.flail.dmgType = "bludgeoning";
weapons.flail.info = "Several spiked balls on chains. Deals up to 6 bludgeoning damage plus STR modifier.";
weapons.flail.value = 50;
weapons.flail.max = 5;

weapons.scimitar = weapons.base();
weapons.scimitar.name = "scimitar";
weapons.scimitar.use = function() {return rng(6);};
weapons.scimitar.bonus = 1;
weapons.scimitar.dmgType = "slashing";
weapons.scimitar.info = "A sword with a curved blade and weighted tip. Deals up to 6 slashing damage plus DEX modifier.";
weapons.scimitar.value = 75;
weapons.scimitar.max = 5;

weapons.glaive = weapons.base();
weapons.glaive.name = "glaive";
weapons.glaive.use = function() {return rng(8);};
weapons.glaive.bonus = 1;
weapons.glaive.dmgType = "piercing";
weapons.glaive.twoHanded = true;
weapons.glaive.info = "A 1ft blade on a 6ft pole. Deals up to 8 piercing damage plus DEX modifier.";
weapons.glaive.value = 90;
weapons.glaive.max = 5;

weapons.ironSkillet = weapons.base();
weapons.ironSkillet.name = "iron skillet";
weapons.ironSkillet.use = function() {return rng(6);};
weapons.ironSkillet.bonus = 0;
weapons.ironSkillet.dmgType = "bludgeoning";
weapons.ironSkillet.effect = "unconscious";
weapons.ironSkillet.effectChance = 0.2;
weapons.ironSkillet.info = "A heavy iron skillet. Deals up to 6 bludgeoning damage plus STR modifier.";
weapons.ironSkillet.value = 10;
weapons.ironSkillet.max = 4;

weapons.pan = weapons.base();
weapons.pan.name = "pan";
weapons.pan.use = function() {return rng(4);};
weapons.pan.bonus = 0;
weapons.pan.dmgType = "bludgeoning";
weapons.pan.info = "an ordinary cooking pan. Deals up to 4 bludgeoning damage plus STR modifier.";
weapons.pan.value = 5;
weapons.pan.max = 15;

weapons.swordOfEmbers = weapons.base();
weapons.swordOfEmbers.name = "Sword of Embers";
weapons.swordOfEmbers.use = function() {return rng(10);};
weapons.swordOfEmbers.bonus = 0;
weapons.swordOfEmbers.dmgType = "fire";
weapons.swordOfEmbers.effect = "burned";
weapons.swordOfEmbers.effectChance = 0.2;
weapons.swordOfEmbers.info = "The legendary Sword of Embers. Deals up to 10 fire damage plus STR modifier with a 20% chance of causing a burn.";
weapons.swordOfEmbers.value = 750;
weapons.swordOfEmbers.max = 5;

weapons.bite = weapons.base();
weapons.bite.name = "bite";
weapons.bite.use = function() {return rng(4);};
weapons.bite.bonus = 0;
weapons.bite.dmgType = "piercing";
weapons.bite.enemyAtk = true;
weapons.bite.info = "Bite";
weapons.bite.value = 0;
weapons.bite.max = 0;

weapons.poisonFang = weapons.base();
weapons.poisonFang.name = "poison fang";
weapons.poisonFang.use = function() {return rng(4);};
weapons.poisonFang.bonus = 0;
weapons.poisonFang.dmgType = "piercing";
weapons.poisonFang.effect = "poisoned";
weapons.poisonFang.effectChance = 0.2;
weapons.poisonFang.enemyAtk = true;
weapons.poisonFang.info = "Poison Fang";
weapons.poisonFang.value = 0;
weapons.poisonFang.max = 0;

weapons.scratch = weapons.base();
weapons.scratch.name = "scratch";
weapons.scratch.use = function() {return rng(4);};
weapons.scratch.bonus = 1;
weapons.scratch.dmgType = "slashing";
weapons.scratch.enemyAtk = true;
weapons.scratch.info = "Scratch";
weapons.scratch.value = 0;
weapons.scratch.max = 0;

weapons.claw = weapons.base();
weapons.claw.name = "claw";
weapons.claw.use = function() {return rng(6);};
weapons.claw.bonus = 0;
weapons.claw.dmgType = "slashing";
weapons.claw.enemyAtk = true;
weapons.claw.info = "Claw";
weapons.claw.value = 0;
weapons.claw.max = 0;

weapons.bash = weapons.base();
weapons.bash.name = "bash";
weapons.bash.use = function() {return rng(6);};
weapons.bash.bonus = 0;
weapons.bash.dmgType = "bludgeoning";
weapons.bash.effect = "unconscious";
weapons.bash.effectChance = 0.2;
weapons.bash.enemyAtk = true;
weapons.bash.info = "Bash";
weapons.bash.value = 0;
weapons.bash.max = 0;

weapons.projectile = function(target, wpn) {
	if (wpn.projectile === false) {return;}
	for (let i=0; i<target.weapons.length; i+=1) {
		if (target.weapons[i] === wpn.projectile) {
			if (target.weaponsQuantity[i] > 1) {
				target.weaponsQuantity[i] -= 1;
				loadWeapons();
				return;
			} else {
				removeStuff(target.weapons, target.weaponsQuantity, i, "weapon");
				loadWeapons();
				return;
			}
		} else if (i === target.weapons.length-1 && i !== wpn.projectile) {
			return false;
		}
	}
}
weapons.array = [
	weapons.fist,weapons.dagger,weapons.shortsword,weapons.longsword,weapons.greatsword,weapons.axe,weapons.greataxe,weapons.maul,weapons.warhammer,weapons.spear,
	weapons.bow,weapons.longbow,weapons.crossbow,weapons.slingShot,weapons.arrow,weapons.bolt,weapons.bullet,weapons.throwingKnife,weapons.flail,weapons.scimitar,
	weapons.glaive,weapons.ironSkillet,weapons.pan,weapons.swordOfEmbers,weapons.bite,weapons.poisonFang,weapons.scratch,weapons.claw,weapons.bash
];
	
var armor = new Object();
armor.hideArmor = {
	name: "Hide Armor",
	stat: 2,
	typeName: "body",
	resistance: false,
	info: "Leather hide armor. Body. +2 to AC.",
	class: [],
	value: 10,
	max: 8,
}
armor.chainmail = {
	name: "Chainmail",
	stat: 3,
	typeName: "body",
	resistance: false,
	info: "Armor made of chain rings. Body. +3 to AC.",
	class: [],
	value: 40,
	max: 5,
}
armor.bronzeFullPlate = {
	name: "Bronze Full Plate",
	stat: 6,
	typeName: "body",
	resistance: false,
	info: "Bronze Armor. Body. +6 to AC.",
	class: [],
	value: 80,
	max: 3,
}
armor.steelFullPlate = {
	name: "Steel Full Plate",
	stat: 8,
	typeName: "body",
	resistance: false,
	info: "Steel Armor. Body. +8 to AC.",
	class: [],
	value: 150,
	max: 3,
}
armor.leatherGauntlet = {
	name: "Leather Gauntlet",
	stat: 1,
	typeName: "hands",
	resistance: false,
	info: "Leather gauntlets. Hands. +1 to AC.",
	class: [],
	value: 5,
	max: 10,
}
armor.bronzeGauntlet = {
	name: "Bronze Gauntlet",
	stat: 2,
	typeName: "hands",
	resistance: false,
	info: "Bronze plated gauntlets. Hands. +2 to AC.",
	class: [],
	value: 30,
	max: 8,
}
armor.steelGauntlet = {
	name: "Steel Gauntlet",
	stat: 3,
	typeName: "hands",
	resistance: false,
	info: "Steel plated gauntlets. Hands. +3 to AC.",
	class: [],
	value: 60,
	max: 8,
}
armor.leatherBoots = {
	name: "Leather Boots",
	stat: 1,
	typeName: "feet",
	resistance: false,
	info: "Leather boots. Feet. +1 to AC.",
	class: [],
	value: 5,
	max: 10,
}
armor.bronzeBoots = {
	name: "Bronze Boots",
	stat: 2,
	typeName: "feet",
	resistance: false,
	info: "Bronze plated boots. Feet. +2 to AC.",
	class: [],
	value: 30,
	max: 8,
}
armor.steelBoots = {
	name: "Steel Boots",
	stat: 3,
	typeName: "feet",
	resistance: false,
	info: "Steel plated boots. Feet. +3 to AC.",
	class: [],
	value: 60,
	max: 8,
}
armor.chainmailCoif = {
	name: "Chainmail Coif",
	stat: 1,
	typeName: "head",
	resistance: false,
	info: "Chainmail head piece. Head. +1 to AC.",
	class: [],
	value: 15,
	max: 8,
}
armor.bronzeHelmet = {
	name: "Bronze Helmet",
	stat: 2,
	typeName: "head",
	resistance: false,
	info: "Bronze helmet. Head. +2 to AC.",
	class: [],
	value: 40,
	max: 5,
}
armor.steelHelmet = {
	name: "Steel Helmet",
	stat: 3,
	typeName: "head",
	resistance: false,
	info: "Steel helmet. Head. +3 to AC.",
	class: [],
	value: 75,
	max: 5,
}
armor.woodenShield = {
	name: "Wooden Shield",
	stat: 3,
	typeName: "shield",
	resistance: false,
	info: "Wooden Shield. Shield. One-Handed weapons only. +3 to AC.",
	class: [],
	value: 20,
	max: 3,
}
armor.bronzeShield = {
	name: "Bronze Shield",
	stat: 4,
	typeName: "shield",
	resistance: false,
	info: "Bronze Shield. Shield. One-Handed weapons only. +4 to AC.",
	class: [],
	value: 40,
	max: 3,
}
armor.steelShield = {
	name: "Steel Shield",
	stat: 5,
	typeName: "shield",
	resistance: false,
	info: "Steel Shield. Shield. One-Handed weapons only. +5 to AC.",
	class: [],
	value: 80,
	max: 3,
}
armor.woodenBuckler = {
	name: "Wooden Buckler",
	stat: 1,
	typeName: "buckler",
	resistance: false,
	info: "Wooden buckler. Straps to arm. Buckler. +1 to AC.",
	class: [],
	value: 15,
	max: 5
}
armor.bronzeBuckler = {
	name: "Bronze Buckler",
	stat: 2,
	typeName: "buckler",
	resistance: false,
	info: "Bronze buckler. Straps to arm. Buckler. +2 to AC.",
	class: [],
	value: 30,
	max: 5
}
armor.steelBuckler = {
	name: "Steel Buckler",
	stat: 3,
	typeName: "buckler",
	resistance: false,
	info: "Steel buckler. Straps to arm. Buckler. +3 to AC.",
	class: [],
	value: 70,
	max: 5
}
armor.braceletOfFireResistance = {
	name: "Bracelet of Fire Resistance",
	stat: 0,
	typeName: "wrist",
	resistance: "fire1",
	info: "Magical bracelet that cuts damage from fire in half. Wrist.",
	class: [],
	value: 100,
	max: 10
}
armor.ringOfFrostProtection = {
	name: "Ring of Frost Protection",
	stat: 0,
	typeName: "finger",
	resistance: "frost1",
	info: "Magical ring that cuts damage from frost in half. Finger.",
	class: [],
	value: 100,
	max: 10
}
armor.amuletOfThunder = {
	name: "Amulet of Thunder",
	stat: 0,
	typeName: "neck",
	resistance: "lightning1",
	info: "Magical amulet that cuts damage from lightning in half. Neck.",
	class: [],
	value: 100,
	max: 10
}
armor.unpiercableChainmail = {
	name: "Unpiercable Chainmail",
	stat: 3,
	typeName: "body",
	resistance: "piercing0",
	info: "Magical chainmail armor that makes you immune to piercing damage. Body. +3 to AC.",
	class: [],
	value: 100,
	max: 5
}
armor.woodenShieldOfDeflecting = {
	name: "Wooden Shield of Deflecting",
	stat: 3,
	typeName: "shield",
	resistance: "bludgeoning0",
	info: "Magical wooden shield that makes you immune to bludgeoning damage. Shield. One-Handed weapons only. +3 to AC.",
	class: [],
	value: 150,
	max: 3
}
armor.array = [
	armor.hideArmor,armor.chainmail,armor.bronzeFullPlate,armor.steelFullPlate,armor.leatherGauntlet,armor.bronzeGauntlet,armor.steelGauntlet,armor.leatherBoots,
	armor.bronzeBoots,armor.steelBoots,armor.chainmailCoif,armor.bronzeHelmet,armor.steelHelmet,armor.woodenShield,armor.bronzeShield,armor.steelShield,
	armor.woodenBuckler,armor.bronzeBuckler,armor.steelBuckler,armor.braceletOfFireResistance,armor.ringOfFrostProtection,armor.amuletOfThunder,
	armor.unpiercableChainmail,armor.woodenShieldOfDeflecting
];

var quests = new Object();
quests.add = function(questNum) {
	if (quests.find(questNum) === false) {
		player.quests.push(questNum);
		player.questProgress.push(0);
		window.alert("You accepted the quest "+quests.nameArray[questNum]+". First Objective: "+quests.array[questNum][player.questProgress[quests.find(questNum)]]);
		loadQuests();
	}
}
quests.find = function(questNum) {							//takes questNum in quests.array order and returns itemNum in player.quests
	for (i=0; i<player.quests.length; i+=1) {
		if (player.quests[i] === questNum) {
			return i;
		}
	}
	return false;
}

quests.findProgress = function(questNum) {
	if (player.questProgress[quests.find(questNum)] >= 0) {return player.questProgress[quests.find(questNum)]} else {return false;}
}

quests.update = function(questNum) {
	if (player.questProgress[quests.find(questNum)] >= quests.array[questNum].length) {
		window.alert("Quest Complete: "+quests.nameArray[questNum])
		return;
	}
	player.questProgress[quests.find(questNum)] += 1;
	if (player.questProgress[quests.find(questNum)] === quests.array[questNum].length) {
		window.alert("Quest Complete: "+quests.nameArray[questNum]+" You gained "+quests.experienceArray[questNum]+" experience points. ");
		player.experience += quests.experienceArray[questNum];
		displayChar();
		if (levelUpExpCheck() <= player.experience) {
			buttonVarArray[0] = levelUp;
		}
	} else {
		window.alert("Quest Update: "+quests.nameArray[questNum]+". Next Objective: "+quests.array[questNum][player.questProgress[quests.find(questNum)]]);
	}
}
quests.allInANightsWork = ["Travel to the house at the end of the road.","Climb in through the window. ","Steal what you can.","Return to stranger."];
quests.oakloftTournament = ["Visit the king's steward to sign up for the tournament.","Report to the arena","Win the tournament."]
quests.array = [quests.allInANightsWork, quests.oakloftTournament];
quests.nameArray = ["All in a Night's Work", "Oakloft Tournament"];
quests.experienceArray = [250, 350];

var spells = new Object();
spells.attack = {};
spells.testManna = function(target, mannaCost) { 
	if (mannaCost > target.manna) {
		goBack("You do not have enough manna.")
		buttonVarArray[0] = combat.displayEffectSpells;
		combat.turns[0] = false;
		return false;
	}
}
spells.attack.fireball = {
	name: "Fireball",
	use: function() {return rng(6);},
	info: "Causes up to 6 points of fire damage. Manna cost: 8",
	effect: false,
	effectChance: 0,
	mannaCost: 8,
	dmgType: "fire"
}
spells.attack.lightningBolt = {
	name: "Lightning Bolt",
	use: function() {return rng(12);},
	info: "Causes up to 12 points of lightning damage with a 20% chance of causing paralysis. Manna cost: 15",
	effect: "paralyzed",
	effectChance: 0.2,
	mannaCost: 15,
	dmgType: "lightning"
}
spells.attack.gust = {
	name: "Gust",
	use: function() {return rng(4);},
	info: "Causes up to 4 points of wind damage. Manna cost: 5",
	effect: false,
	effectChance: 0,
	mannaCost: 5,
	dmgType: "wind"
}
spells.attack.frostBeam = {
	name: "Frost Beam",
	use: function() {return rng(10);},
	info: "Causes up to 10 points of frost damage. Manna cost: 8",
	effect: false,
	effectChance: 0,
	mannaCost: 8,
	dmgType: "frost"
}
spells.attack.blizzard = {
	name: "Blizzard",
	use: function() {return rng(15);},
	info: "Causes up to 15 points of frost damage with a 20% chance of causing frostbite. Manna cost: 15",
	effect: "frostbitten",
	effectChance: 0.2,
	mannaCost: 15,
	dmgType: "frost"
}
spells.attack.hurricane = {
	name: "Hurricane",
	use: function() {return rng(12);},
	info: "Causes up to 12 points of wind damage with a 20% chance of knocking the enemy prone. Manna cost: 10",
	effect: "prone",
	effectChance: 0.2,
	mannaCost: 10,
	dmgType: "wind"
}
spells.attack.sunBurst = {
	name: "Sun Burst",
	use: function() {return rng(15);},
	info: "Causes up to 15 points of radiant damage with a 30% chance of blinding the enemy. Manna cost: 15",
	effect: "blinded",
	effectChance: 0.3,
	mannaCost: 15,
	dmgType: "radiant"
}
spells.attack.inferno = {
	name: "Inferno",
	use: function() {return rng(12);},
	info: "Causes up to 12 points of fire damage with a 30% chance of causing a burn. Manna cost: 15",
	effect: "burned",
	effectChance: 0.3,
	mannaCost: 15,
	dmgType: "fire"
}
spells.attack.deathRay = {
	name: "Death Ray",
	use: function() {return rng(12);},
	info: "Causes up to 12 points of necrotic damage. Manna cost: 10",
	effect: false,
	effectChance: 0,
	mannaCost: 10,
	dmgType: "necrotic"
}
spells.attack.poisonSlash = {
	name: "Poison Slash",
	use: function() {return rng(8);},
	info: "Causes up to 8 points of poison damage with a 20% chance of poisoning the enemy. Manna cost: 10",
	effect: "poisoned",
	effectChance: 0.2,
	mannaCost: 10,
	dmgType: "poison"
}
spells.attack.entangle = {
	name: "Entangle",
	use: function() {return rng(6);},
	info: "Causes up to 6 points of radiant damage with a 30% chance of constricting the enemy. Manna cost: 8",
	effect: "constricted",
	effectChance: 0.3,
	mannaCost: 8,
	dmgType: "bludgeoning"
}
spells.attack.fireBreath = {
	name: "Fire Breath",
	use: function() {return rng(6);},
	info: "Causes up to 6 points of fire damage. Manna cost: 0",
	effect: false,
	effectChance: 0,
	mannaCost: 0,
	dmgType: "fire"
}
spells.attack.array = [
	spells.attack.fireball,spells.attack.lightningBolt,spells.attack.gust,spells.attack.frostBeam,spells.attack.blizzard,spells.attack.hurricane,spells.attack.sunBurst,
	spells.attack.inferno,spells.attack.deathRay,spells.attack.poisonSlash,spells.attack.entangle,spells.attack.fireBreath
];


spells.weakHealing = {
	name: "Weak Healing",
	use: function(target) {if (spells.testManna(target, 2) === false) {return}; items.potion(target, 0, "health", 0, this.name);},
	info: "Restores 6-13 health points. Manna cost: 10",
	mannaCost: 10
}
spells.mediumHealing = {
	name: "Medium Healing",
	use: function(target) {if (spells.testManna(target, 5) === false) {return};items.potion(target, 0, "health", 1, this.name);},
	info: "Restores 12-26 health points. Manna cost: 20",
	mannaCost: 20
}
spells.strongHealing = {
	name: "Strong Healing",
	use: function(target) {if (spells.testManna(target, 8) === false) {return};items.potion(target, 0, "health", 2, this.name);},
	info: "Restores 24-52 health points. Manna cost: 30",
	mannaCost: 30
}
spells.veryStrongHealing = {
	name: "Very Strong Healing",
	use: function(target) {if (spells.testManna(target, 10) === false) {return};items.potion(target, 0, "health", 3, this.name);},
	info: "Restores 48-104 health points. Manna cost: 40",
	mannaCost: 40
}
spells.bullStrength = {
	name: "Bull Strength",
	use: function(target) {spells.statBoost(target, 0, 5, 5, 10, "strength");},
	info: "Increases strength by 5 points for 5 rounds. Manna cost: 10", 
	mannaCost: 10
}
spells.focus = {
	name: "Focus",
	use: function(target) {spells.statBoost(target, 1, 5, 5, 10, "dexterity");},
	info: "Increases dexterity by 5 points for 5 rounds. Manna cost: 10",
	mannaCost: 10
}
spells.concentration = {
	name: "Concentration",
	use: function(target) {spells.statBoost(target, 2, 5, 5, 10, "IQ");},
	info: "Increases IQ by 5 points for 5 rounds. Manna cost: 10",
	mannaCost: 10
}
spells.mageArmor = {
	name: "Mage Armor",
	use: function(target) {spells.statBoost(target, 3, 5, 5, 10, "armor class");},
	info: "Increases Armor Class by 5 points for 5 rounds. Manna cost: 10",
	mannaCost: 10
}
spells.restoration = {
	name: "Restoration",
	use: function(target) {
		if (target.status.length === 0) {
			goBack("You do not need to be restored. ")
			if (combat.active === true) {
				buttonVarArray[0] = combat.displayEffectSpells;
			}
		} else {
			if (spells.testManna(target, 20) === false) {return};
			items.potionOfRestoration(target, "spell")
			target.manna -= 20;
			if (combat.active === true) {
				combat.turns[0] = true;
			}
		}
	},
	info: "Cures you of any status effects. Manna cost: 20",
	mannaCost: 20
}
spells.statBoost = function(target, stat, amount, rounds, mannaCost, statString) {
	if (combat.active === false) {
		goBack("You cannot use this spell outside of combat. ")
		return;
	}
	if (spells.testManna(target, 10) === false) {return};
	if (target === player) {target = 0;} else {target = 1;}
	combat.boostTempStat(target, amount, rounds, stat);
	combat.turns[0] = true;
	goBack("Your "+statString+" has been boosted. ")
	target.manna -= mannaCost;
}
spells.array = [
	spells.weakHealing,spells.mediumHealing,spells.strongHealing,spells.veryStrongHealing,spells.bullStrength,spells.focus,spells.concentration,spells.mageArmor,
	spells.restoration
];

	var homeInventory = new Object();
	homeInventory.type = "bank"
	homeInventory.name = "Inventory Chest"
	homeInventory.items = [items.weakPotion,items.mediumPotion,items.spoon,items.candleStick,items.spellBookGust,];
	homeInventory.weapons = [weapons.shortsword];
	homeInventory.armor = [armor.hideArmor,armor.leatherBoots,armor.leatherGauntlet];
	homeInventory.itemsQuantity = [2,1,3,2,1];
	homeInventory.weaponsQuantity = [1];
	homeInventory.armorQuantity = [1,1,1];
	homeInventory.gold = 150;
	
	var townShop = new Object();
	townShop.type = "shop"
	townShop.name = "General Store"
	townShop.items = [
		items.weakPotion, items.mediumPotion, items.strongPotion, items.veryStrongPotion, items.weakMannaPotion, items.mediumMannaPotion, items.strongMannaPotion,
		items.veryStrongMannaPotion, items.potionOfRestoration, items.spellBookFireBall, items.spellBookLightningBolt, items.spellBookGust, items.spellBookFrost,
		items.spellBookWeakHealing,items.spellBookMediumHealing, items.spellBookStrongHealing, items.spellBookVeryStrongHealing, items.spellBookBullStrength,
		items.spellBookFocus, items.spellBookConcentration, items.spellBookMageArmor, items.spellBookRestoration, items.spellBookBlizzard, items.spellBookHurricane,
		items.spellBookSunBurst, items.spellBookInferno, items.spellBookDeathRay, items.spellBookPoisonSlash, items.spellBookEntangle,items.candleStick,
	];
	townShop.weapons = [
		weapons.dagger,weapons.shortsword,weapons.longsword,weapons.greatsword,weapons.axe,weapons.greataxe,weapons.maul,weapons.warhammer,weapons.spear,weapons.bow,
		weapons.longbow,weapons.crossbow,weapons.slingShot,weapons.arrow,weapons.bolt,weapons.bullet,weapons.throwingKnife,weapons.flail,weapons.scimitar,weapons.glaive,
		weapons.ironSkillet,weapons.pan
	];
	townShop.armor = [
		armor.hideArmor,armor.chainmail,armor.bronzeFullPlate,armor.steelFullPlate,armor.leatherGauntlet,armor.bronzeGauntlet,armor.steelGauntlet,armor.leatherBoots,
		armor.bronzeBoots,armor.steelBoots,armor.chainmailCoif,armor.bronzeHelmet,armor.steelHelmet,armor.woodenShield,armor.bronzeShield,armor.steelShield,
		armor.woodenBuckler,armor.bronzeBuckler,armor.steelBuckler
	];
	townShop.itemsQuantity = [5,5,5,5,5,5,5,5,5,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
	townShop.weaponsQuantity = [9,3,2,2,4,7,3,3,5,5,2,2,10,10,10,10,10,3,5,5,2,2,1,1,1,1];
	townShop.armorQuantity = [2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
	townShop.gold = 2000;
	
	var townBank = new Object();
	townBank.type = "bank";
	townBank.name = "General Bank";
	townBank.items = [items.pillow,items.weakPotion,items.mediumPotion,items.spellBookWeakHealing];
	townBank.weapons = [weapons.dagger,weapons.shortsword,weapons.spear,weapons.bow,weapons.arrow,weapons.pan];
	townBank.armor = [armor.chainmail,armor.chainmailCoif,armor.woodenShield];
	townBank.itemsQuantity = [1,2,1,1];
	townBank.weaponsQuantity = [3,3,5,20,2,1];
	townBank.armorQuantity = [1,1,1];
	townBank.gold = 200;
	
	var currentShop = homeInventory;


var enemy = new Object();

enemy.create = function(create, lvl) {
	create.level = lvl;
	create.experience = Math.floor(lvl*create.baseYield/5)
	create.status = [];
	create.statusRounds = [];
	create.hitPoints = 30;
	create.mannaMax = 30;
	if (create.class === "warrior") {
		create.class = warrior;
	} else if (create.class === "mage") {
		create.class = mage;
	} else if (create.class === "rogue") {
		create.class = rogue;
	} else if (create.class === "paladin") {
		create.class = paladin;
	} else if (create.class === "beast") {
		create.class = beast;
	} else if (create.class === "tank") {
		create.class = tank;
	} else if (create.class === "even") {
		create.class = even;
	}
	var max = create.level*10
	var spread = Math.floor((lvl/6)*10);
	var leftOver = max-(spread);
	var statArray = [10,10,10,10,10,10];
	var unfav = [0,1,2,3,4,5];
	for (i=1; i<=lvl; i+=1) {
		statArray[4] += i;
		statArray[5] += i;
	}
	function evenSpread() {
		for (i=0; i<6; i+=1) {
				statArray[i] += spread;
			}
		}
		function randomStat() {
			var roll = rng(6);
			if (leftOver !== 0) {
				statArray[roll-1] += 1;
				leftOver -= 1;
				randomStat();
			}
		}
		function favoredStat(fav) {
			var roll = rng(10);
			unfav = [0,1,2,3,4,5];
			unfav.splice(fav,1);
			if (leftOver !== 0) {
				if (roll === 1) {
					statArray[unfav[0]] += 1;
				} else if (roll === 2) {
					statArray[unfav[1]] += 1;
				} else if (roll === 3) {
					statArray[unfav[2]] += 1;
				} else if (roll === 4) {
					statArray[unfav[3]] += 1;
				} else if (roll === 5) {
					statArray[unfav[4]] += 1;
				} else if (roll > 5) {
					statArray[fav] += 1;
				}
				leftOver -= 1;
				favoredStat(fav);
			}
		}
		function twoFavoredStats(fav1, fav2) {
			var roll = rng(15);
			for (i=0; i<6; i+=1) {
				if (unfav[i] === fav1 || unfav[i] === fav2) {
					unfav.splice(i, 1);
				}
			}
			if (leftOver !== 0) {
				if (roll === 1) {
					statArray[unfav[0]] += 1;
				} else if (roll === 2) {
					statArray[unfav[1]] += 1;
				} else if (roll === 3) {
					statArray[unfav[2]] += 1;
				} else if (roll === 4) {
					statArray[unfav[3]] += 1;
				} else if (roll>=5 && roll<=10) {
					statArray[fav1] += 1;
				} else if (roll>=11 && roll<=15) {
					statArray[fav2] += 1;
				}
				leftOver -= 1;
				twoFavoredStats(fav1, fav2);
			}
		}
		function threeFavoredStats(fav1, fav2, fav3) {
			var roll = rng(21);
			for (i=0; i<6; i+=1) {
				if (unfav[i] === fav1 || unfav[i] === fav2 || unfav[i] === fav3) {
					unfav.splice(i, 1);
				}
			}
			if (leftOver !== 0) {
				if (roll === 1) {
					statArray[unfav[0]] += 1;
				} else if (roll === 2) {
					statArray[unfav[1]] += 1;
				} else if (roll === 3) {
					statArray[unfav[2]] += 1;
				} else if (roll>=4 && roll<=9) {
					statArray[fav1] += 1;
				} else if (roll>=9 && roll<=15) {
					statArray[fav2] += 1;
				} else if (roll>=16 && roll<=21) {
					statArray[fav3] += 1;
				}
				leftOver -= 1;
				threeFavoredStats(fav1, fav2, fav3);
			}
		}
		function warrior() {evenSpread(); threeFavoredStats(0,3,4); finish();}
		function mage() {evenSpread(); twoFavoredStats(2,5); finish();}
		function rogue() {evenSpread(); twoFavoredStats(1,4); finish();}
		function paladin() {evenSpread(); threeFavoredStats(0,2,5); finish();}
		function beast() {evenSpread(); favoredStat(0); finish();}
		function tank() {evenSpread(); favoredStat(4); finish();}
		function even() {evenSpread(); randomStat(); finish();}
		function finish() {
			create.strength = statArray[0];
			create.dexterity = statArray[1];
			create.iq = statArray[2];
			create.armorClass = statArray[3];
			create.hitPoints = statArray[4];
			create.mannaMax = statArray[5];
			create.health = create.hitPoints;
			create.manna = create.mannaMax;
			for (let i=0; i<create.armor.length; i+=1) {
				create.armorClass += create.armor[i].stat;
			}
		}
		create.class();
		return create;
	}
	
	enemy.lvlRange = function() {
		var roll = rng(5);
		var lvl = (player.level-3)+roll
		if (lvl<1) {
			lvl = 1;
		}
		return lvl;
	}
	
	enemy.lvlGreaterThan = function() {
		var roll = rng(3);
		var lvl = player.level+roll
		return lvl;
	}
	
	enemy.lvlLessThan = function() {
		var roll = rng(3);
		var lvl = (player.level-3)+roll
		if (lvl<1) {
			lvl = 1;
		}
		return lvl;
	}

//	baseYield is between 30 and 100 depending on difficulty

enemy.goblin = function() {
	var e = {
		name: "Goblin",
		gold: rng(5)+10,
		items: [],
		itemsQuantity: [],
		weapons: [weapons.spear],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [armor.hideArmor],
		armorQuantity: [1],
		spells: [],
		spellsAttack: [],
		weakness: ["fire1"],
		class: "warrior",
		AI: enemy.simpleAI,
		atkString: "A goblin runs up to you with its weapon drawn shouting jibberish. ",
		baseYield: 30
	}
	return e;
}
enemy.guard = function() {
	var e = {
		name: "Palace Guard",
		gold: rng(15)+30,
		items: [items.weakPotion],
		itemsQuantity: [2],
		weapons: [weapons.longsword,weapons.glaive],
		weaponsQuantity: [1,1],
		weaponEquipped: 0,
		armor: [armor.chainmail,armor.leatherGauntlet,armor.leatherBoots],
		armorQuantity: [1,1,1],
		spells: [spells.weakHealing],
		spellsAttack: [spells.attack.fireball,spells.attack.gust,spells.attack.frostBeam],
		weakness: [],
		class: "paladin",
		AI: enemy.genericAI,
		atkString: "A palace guard is trying to arrest you. ",
		baseYield: 60
	}
	return e;
}
enemy.giantRat = function() {
	var e = {
		name: "Giant Rat",
		gold: 0,
		items: [],
		itemsQuantity: [],
		weapons: [weapons.bite],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [],
		armorQuantity: [],
		spells: [],
		spellsAttack: [],
		weakness: [],
		class: "even",
		AI: enemy.simpleAI,
		atkString: "A giant rat races up to you and lunges at you. ",
		baseYield: 30
	}
	return e;
}
enemy.giantSpider = function() {
	var e = {
		name: "Giant Spider",
		gold: 0,
		items: [],
		itemsQuantity: [],
		weapons: [weapons.poisonFang],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [],
		armorQuantity: [],
		spells: [],
		spellsAttack: [],
		weakness: ["fire2"],
		class: "even",
		AI: enemy.simpleAI,
		atkString: "A giant spider crawls toward you with its fangs out. ",
		baseYield: 40
	}
	return e;
}
enemy.frostSpider = function() {
	var e = {
		name: "Frost Spider",
		gold: 0,
		items: [],
		itemsQuantity: [],
		weapons: [weapons.poisonFang],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [],
		armorQuantity: [],
		spells: [],
		spellsAttack: [spells.attack.frostBeam],
		weakness: ["fire2"],
		class: "even",
		AI: enemy.genericAI,
		atkString: "A frost spider crawls toward you with its fangs out. ",
		baseYield: 50
	}
	return e;
}
enemy.wizard = function() {
	var e = {
		name: "Wizard",
		gold: rng(20)+50,
		items: [],
		itemsQuantity: [],
		weapons: [weapons.fist],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [],
		armorQuantity: [],
		spells: [0,1],
		spellsAttack: [
			spells.attack.fireball,spells.attack.inferno,spells.attack.hurricane,spells.attack.sunBurst,spells.attack.deathRay,spells.attack.lightningBolt,
			spells.attack.blizzard
		],
		weakness: [],
		class: "mage",
		AI: enemy.genericAI,
		atkString: "A wizard is preparing to cast a spell on you. ",
		baseYield: 80
	}
	return e;
}
enemy.babyDragon = function() {
	var e = {
		name: "Baby Dragon",
		gold: rng(15)+30,
		items: [],
		itemsQuantity: [],
		weapons: [weapons.claw],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [],
		armorQuantity: [],
		spells: [],
		spellsAttack: [spells.attack.fireBreath,spells.attack.fireball,spells.attack.inferno],
		weakness: [],
		class: "paladin",
		AI: enemy.cantripAI,
		atkString: "A baby dragon is trying to defend its treasure. ",
		baseYield: 60
	}
	return e;
}
enemy.wolf = function() {
	var e = {
		name: "Wolf",
		gold: 0,
		items: [],
		itemsQuantity: [],
		weapons: [weapons.bite],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [],
		armorQuantity: [],
		spells: [],
		spellsAttack: [],
		weakness: [],
		class: "beast",
		AI: enemy.simpleAI,
		atkString: "A wolf is trying to defend its territory. ",
		baseYield: 40
	}
	return e;
}

enemy.donkeyKong = function() {
	var e = {
		name: "Donkey Kong",
		gold: 0,
		items: [],
		itemsQuantity: [],
		weapons: [weapons.bash],
		weaponsQuantity: [],
		weaponEquipped: 0,
		armor: [],
		armorQuantity: [],
		spells: [],
		spellsAttack: [],
		weakness: [],
		class: "beast",
		AI: enemy.simpleAI,
		atkString: "",
		baseYield: 60
	}
	return e;
}
enemy.mrMeeseeks = function() {
	var e = {
		name: "Mr. Meeseeks",
		gold: 0,
		items: [],
		itemsQuantity: [],
		weapons: [weapons.fist],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [],
		armorQuantity: [],
		spells: [],
		spellsAttack: [],
		weakness: [],
		class: "even",
		AI: enemy.simpleAI,
		atkString: "",
		baseYield: 30
	}
	return e;
}
enemy.charizard = function() {
	var e = {
		name: "Charizard",
		gold: 0,
		items: [],
		itemsQuantity: [],
		weapons: [weapons.bite],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [],
		armorQuantity: [],
		spells: [],
		spellsAttack: [spells.attack.fireBreath,spells.attack.fireball,spells.attack.inferno],
		weakness: ["frost2"],
		class: "paladin",
		AI: enemy.cantripAI,
		atkString: "",
		baseYield: 60
	}
	return e;
}
enemy.obiWanShinobi = function() {
	var e = {
		name: "Obi Wan Shinobi",
		gold: 30,
		items: [items.weakPotion],
		itemsQuantity: [2],
		weapons: [weapons.dagger],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [],
		armorQuantity: [],
		spells: [],
		spellsAttack: [spells.attack.gust,spells.attack.blizzard,spells.attack.hurricane,spells.attack.fireBreath,spells.attack.inferno,spells.attack.sunBurst],
		weakness: [],
		class: "mage",
		AI: enemy.genericAI,
		atkString: "",
		baseYield: 50
	}
	return e;
}
enemy.ganondorf = function() {
	var e = {
		name: "Ganondorf",
		gold: 0,
		items: [items.weakPotion,items.mediumPotion],
		itemsQuantity: [1,1],
		weapons: [weapons.axe,weapons.greatsword],
		weaponsQuantity: [1,1],
		weaponEquipped: 0,
		armor: [armor.chainmail,armor.leatherGauntlet,armor.leatherBoots],
		armorQuantity: [1,1,1],
		spells: [],
		spellsAttack: [spells.attack.lightningBolt,spells.attack.gust,spells.attack.deathRay],
		weakness: ["radiant2"],
		class: "paladin",
		AI: enemy.genericAI,
		atkString: "",
		baseYield: 60
	}
	return e;
}
enemy.link = function() {
	var e = {
		name: "Link",
		gold: 0,
		items: [items.weakPotion],
		itemsQuantity: [1],
		weapons: [weapons.longsword],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [armor.chainmail,armor.leatherGauntlet,armor.leatherBoots,armor.steelShield],
		armorQuantity: [1,1,1,1],
		spells: [],
		spellsAttack: [],
		weakness: ["radiant0"],
		class: "paladin",
		AI: enemy.genericAI,
		atkString: "",
		baseYield: 50
	}
	return e;
}
enemy.tanjiro = function() {
	var e = {
		name: "Tanjiro",
		gold: 0,
		items: [items.weakPotion,items.mediumPotion],
		itemsQuantity: [1,1],
		weapons: [weapons.longsword],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [armor.hideArmor],
		armorQuantity: [1],
		spells: [],
		spellsAttack: [],
		weakness: ["necrotic2"],
		class: "warrior",
		AI: enemy.genericAI,
		atkString: "",
		baseYield: 40
	}
	return e;
}
enemy.ulfricStormcloak = function() {
	var e = {
		name: "Ulfric Stormcloak",
		gold: rng(30)+10,
		items: [items.weakPotion,items.mediumPotion],
		itemsQuantity: [1,1],
		weapons: [weapons.greataxe],
		weaponsQuantity: [1],
		weaponEquipped: 0,
		armor: [armor.chainmail,armor.leatherGauntlet,armor.leatherBoots],
		armorQuantity: [1,1,1],
		spells: [],
		spellsAttack: [],
		weakness: [],
		class: "paladin",
		AI: enemy.genericAI,
		atkString: "",
		baseYield: 50
	}
	return e;
}

enemy.testManna = function() {
	var choices = [];
	for (i=0; i<combat.opponent.spellsAttack.length; i+=1) {
		if (combat.opponent.spellsAttack[i].mannaCost <= combat.opponent.manna) {
			choices.push(i);
		}	
	}
	if (choices.length === 0) {
		combat.checkStatus(combat.opponent, 0, atk)
	}
	var num = choices[(rng(choices.length)-1)];
	return num;
}
function atk() {combat.opponentAttacks(0, 0);}
function spl() {combat.opponentAttacks(1, enemy.testManna());}

	
	enemy.genericAI = function() {
		if (combat.opponent.health > (combat.opponent.hitPoints/10) || combat.opponent.health > 10) {
			if (combat.opponent.manna > 5 && combat.opponent.spellsAttack.length !== 0) {
				combat.checkStatus(combat.opponent, 0, spl);
			} else {
				combat.checkStatus(combat.opponent, 0, atk);
			} 
		} else {
			if (combat.opponent.items.length !== 0) {
				useAnItem();
			} else {
				combat.checkStatus(combat.opponent, 0, atk);
			}
		}
		function useAnItem() {
			var choices = [];
			for (i=0; i<combat.opponent.items.length; i+=1) {
				if (combat.opponent.items[i] === items.weakHealing || combat.opponent.items[i] === items.mediumHealing || combat.opponent.items[i] === items.strongHealing || combat.opponent.items[i] === items.veryStrongHealing) {
					if (combat.opponent.itemsQuantity[i] > 0) {
						choices.push(i);
					}
				}
			}
			var num = choices[(rng(choices.length)-1)];
			var use = function() {combat.opponentUseItem(combat.opponent.items[num])};
			combat.checkStatus(combat.opponent, 0, use);
		}
	}
	
	enemy.simpleAI = function() {
		combat.checkStatus(combat.opponent, 0, atk);
	}
	
	enemy.cantripAI = function() {
		var roll = Math.random()
		if (combat.opponent.manna > 5 && combat.opponent.spellsAttack.length !== 0 && roll > 0.5) {
			combat.checkStatus(combat.opponent, 0, spl);
		} else {
			combat.checkStatus(combat.opponent, 0, atk);
		}
	}
	var combat = new Object();
	combat.active = false;
	combat.round = 1;
	combat.playerAction = [0,0];								//0=action, 1=spellNum, itemNum, or weaponNum
	combat.opponent = {};
	combat.opponent.status = [];
	combat.opponent.statusRounds = [];
	combat.tempStatBoost = [0,0,0,0];
	combat.opponentTempStatBoost = [0,0,0,0];
	combat.tempStatBoostRounds = ["a","a","a","a"];
	combat.opponentTempStatBoostRounds = ["a","a","a","a"];
	combat.turns = [false, false];								//first item is player turn. second item is enemy turn.
	combat.cannotRun = false;
	combat.blocking = false;
//	combat.dmgTypeArray = ["piercing","slashing","bludgeoning","fire","frost","lightning","wind","necrotic","poison","radiant"];
//	combat.statusTypeArray = ["poisoned", "burned", "frostbite", "blinded", "paralyzed", "constricted", "prone", "unconscious"];
	combat.bonus = function(stat) {return Math.floor((stat-10)/2)};
	combat.statusDefeat = false;			//player status that causes defeat
	combat.statusVictory = false;			//opponent status that causes victory
	combat.statusDefeatFunc = false;
	combat.statusVictoryFunc = false;
	combat.defeatFunc = gameOver;
	combat.victoryFunc = 0;

	combat.challenge = function() {
		combat.active = true;
		if (combat.opponent.atkString === "") {
			document.getElementById("prompt").innerHTML = "You are being challenged by a "+combat.opponent.name+" (Level "+combat.opponent.level+"). What would you "+
			"like to do?"
		} else {
			document.getElementById("prompt").innerHTML = combat.opponent.atkString+" (Level "+combat.opponent.level+"). What would you like to do?"
		}
		buttonReset();
		setButton(0, "Fight", combat.displayAttacks);
		setButton(1, "Flee", combat.flee);
	}

	combat.flee = function() {
		var runAway = combat.checkDex();
		if (combat.cannotRun || runAway === false) {
			document.getElementById("prompt").innerHTML = "You tried to run away, but couldn't."
			buttonReset();
			combat.turns[0] = true;
			setButton(0, "Okay.", combat.checkRound);
		} else if (runAway) {
			document.getElementById("prompt").innerHTML = "You got away from the "+combat.opponent.name+"."
			buttonReset();
			setButton(0, "Okay.", data[player.progress]);
			combat.active = false;
		}
	}
	
	combat.statusExit = function() {
		for (i=0; i<player.status.length; i+=1) {
			if (player.status[i] === combat.statusDefeat) {
				combat.statusDefeatFunc();
				return true;
			}
		}
		for (i=0; i<combat.opponent.status.length; i+=1) {
			if (combat.opponent.status[i] === combat.statusVictory) {
				combat.statusVictoryFunc();
				return true;
			}
		}
	}
	
	combat.startRound = function() {
		if (combat.statusExit() === true) {
			return;
		}
		combat.round += 1;
		combat.turns = [false, false];
		for (i=0; i<4; i+=1) {
			if (combat.opponentTempStatBoostRounds[i] !== "a") {
				combat.opponentTempStatBoostRounds[i] -= 1;
			}
			if (combat.tempStatBoostRounds[i] !== "a") {
				combat.tempStatBoostRounds[i] -= 1;
			}
		}

		var playerFirst = combat.checkDex();
		if (playerFirst === true || combat.block === true) {
			combat.startPlayerAction();
		} else {
			combat.opponent.AI();
		}
	}
	
	combat.checkRound = function() {
		if (combat.statusExit() === true) {
			return;
		}
		if (combat.turns[0] === true && combat.turns[1] === true) {
			combat.displayAttacks();
		} else if (combat.turns[0] === true && combat.turns[1] === false) {
			combat.checkTempStat(player, combat.tempStatBoost, combat.tempStatBoostRounds, combat.opponent.AI);
		} else if (combat.turns[0] === false && combat.turns[1] === true) {
			combat.checkTempStat(player, combat.tempStatBoost, combat.tempStatBoostRounds, combat.startPlayerAction);
		}
	}
	
	combat.checkDex = function() {
		var playerSpeed = rng(20) + combat.bonus(player.dexterity);
		var enemySpeed = rng(20) + combat.bonus(combat.opponent.dexterity);
		if (playerSpeed === enemySpeed) {
			if (Math.random() > 0.5) {
				return true;
			} else {return false;}
		} else if (playerSpeed > enemySpeed) {
			return true;
		} else {return false;}
	}
	
	combat.checkStatus = function(target, count, atkFunc) {
		if (target.statusRounds[count] === 0) {
			combat.removeStatus(target, target.status[count])
		}		
		if (target.status.length === 0 || count >= target.status.length) {
			atkFunc();
		} else {
			combat.statusEffect(target, target.status[count], count, atkFunc)
		}
	}
	
	combat.checkStatusPos = function(target, status) {
		for (i=0; i<target.status.length; i+=1) {
			if (target.status[i] === status) {
				return i;
			}
		}
		return false;
	}
	
	combat.setStatus = function (target, status, roundCount) {
		if (combat.checkStatusPos(target, status) === false) {
			target.status.push(status)
			target.statusRounds.push(roundCount)
		}
	}
	
	combat.removeStatus = function (target, status) {
		for (i=0; i<target.status.length; i+=1) {
			if (target.status[i] === status) {
				target.status.splice(i,1)
				target.statusRounds.splice(i,1)
				count -= 1;
				displayChar();
				return;
			}
		}
		return;
	}
	
	combat.effect = function(target, status, chance) {
		var roll = Math.random();
		var effectStr,targetName;
		if (target === player) {
			targetName = "You were "
		} else {targetName = combat.opponent.name+" was "}
		if (roll < chance) {
			if (status === "prone" || status === "unconscious") {
				effectStr = "knocked " + status + ". "
			} else {
				effectStr = status+". "
			}
			document.getElementById("prompt").innerHTML = targetName+effectStr;
			combat.setStatus(target, status, 5);
			buttonReset();
			setButton(0,"Okay.", combat.checkRound)
		} else {combat.checkRound()}
	};
	
	combat.statusEffect = function(target, status, statusPos, atkFunc) {
		var count = statusPos;
		var plural, cureMsg;
		if (target === player) {
			targetName = "You"
			plural = " are"
			targetRound = 0;
		} else {
			targetName = target.name; 
			targetRound = 1;
			plural = " is"
		};
		var dmgString0 = targetName+" received damage from the "
		var dmgString1 = " and lost "+Math.floor(target.hitPoints/16)+" health points. ";
		if (status === "poisoned") {
			document.getElementById("prompt").innerHTML = dmgString0+"poison"+dmgString1
			buttonReset();
			if (count >= target.status.length-1) {
				setButton(0, "Okay.", atkFunc);
			} else {
				setButton(0, "Okay.", checkStat);
			}
			statusDamage(target, "poisoned")
			checkCured(target, "poisoned", "poison")
		} else if (status === "burned") {
			document.getElementById("prompt").innerHTML = dmgString0+"burn"+dmgString1
			buttonReset();
			if (count >= target.status.length-1) {
				setButton(0, "Okay.", atkFunc);
			} else {
				setButton(0, "Okay.", checkStat);
			}
			statusDamage(target, "burned")
			checkCured(target, "burned", "burn", 0)
		} else if (status === "frostbitten") {
			document.getElementById("prompt").innerHTML = dmgString0+"frostbite"+dmgString1
			buttonReset();
			if (count >= target.status.length-1) {
				setButton(0, "Okay.", atkFunc);
			} else {
				setButton(0, "Okay.", checkStat);
			}
			statusDamage(target, "frostbitten")
			checkCured(target, "frostbitten", "frostbite", 0)
		} else if (status === "blinded") {
			document.getElementById("prompt").innerHTML = targetName+plural+" blinded and cannot see. "
			buttonReset();
			setButton(0, "Okay.", checkStat);
			if (target === player) {
				cureMsg = "Your "
			} else {cureMsg = targetName+"'s "}
			cureMsg += "vision has been restored. "
			checkCured(target, "blinded", 0, cureMsg)
		} else if (status === "paralyzed") {
			document.getElementById("prompt").innerHTML = targetName+plural+" paralyzed and cannot move. "
			atkFunc = combat.checkRound;
			buttonReset();
			setButton(0, "Okay.", checkStat);
			checkCured(target, "paralyzed", "paralysis", 0)
			combat.turns[targetRound] = true;
		} else if (status === "constricted") {
			document.getElementById("prompt").innerHTML = targetName+plural+" constricted and cannot move. "
			buttonReset();
			setButton(0, "Okay.", checkStat);
			combat.turns[targetRound] = true;
			statusDamage(target, "constricted") 
			document.getElementById("prompt").innerHTML += dmgString0+"frostbite"+dmgString1;
			cureMsg += targetName+plural+" no longer constricted. "
			checkCured(target, "constricted", 0, cureMsg)
			atkFunc = combat.checkRound;
		} else if (status === "prone") {
			document.getElementById("prompt").innerHTML = targetName+" got up off the ground. "
			buttonReset();
			if (count >= target.status.length-1) {
				setButton(0, "Okay.", combat.checkRound);
			} else {
				setButton(0, "Okay.", checkStat);
			}
			combat.turns[targetRound] = true;
			combat.removeStatus(target, "prone")
		} else if (status === "unconscious") {
			document.getElementById("prompt").innerHTML = targetName+plural+" unconscious and cannot attack. "
			buttonReset();
			setButton(0, "Okay.", checkStat);
			combat.turns[targetRound] = true;
			cureMsg = targetName+" regained consciousness. "
			checkCured(target, "unconscious", 0, cureMsg)
			atkFunc = combat.checkRound;
		}
		function statusDamage(target, type) {
			var dmg = Math.ceil(target.hitPoints/16);
			if (combat.damageresistance(target, type) === 2) {
			dmg *= 2;
			} else if (combat.damageresistance(target, type) === 0.5) {
				dmg = dmg/2;
			}
			target.health -= dmg;
		}
		function checkCured(target, status, statusType, cureString) {
			target.statusRounds[statusPos] -= 1;
			var cureCheck = target.statusRounds[statusPos];
			if (target.statusRounds[statusPos] === 0 ){	//	|| cureCheck >= target.statusRounds[statusPos]) {
				if (statusType !== 0) {
					document.getElementById("prompt").innerHTML += "The effects of the "+statusType+" wore off. "
				} else {
					document.getElementById("prompt").innerHTML += cureString;
				}
				combat.removeStatus(target, status)
			}
		}
		function checkStat() {
			count += 1;
			combat.checkStatus(target, count, atkFunc)
		}
		displayChar();
	}
	
	combat.startPlayerAction = function() {
		if (combat.playerAction[0] === 0) {
			combat.checkStatus(player, 0, atk)
			function atk() {combat.displayDamage(0,0);}
		} else if (combat.playerAction[0] === 1) {
			combat.checkStatus(player, 0, atkspl);
			function atkspl() {combat.displayDamage(1,combat.playerAction[1])}
		} else if (combat.playerAction[0] === 2) {
			combat.checkStatus(player, 0, splfunc);
			function splfunc() {
				combat.turns[0] = true;
				player.spells[combat.playerAction[1]].use(player);
				displayChar();
			}
		} else if (combat.playerAction[0] === 3) {
			combat.checkStatus(player, 0, item);
			function item() {
				player.items[combat.playerAction[1]].use(player, combat.playerAction[1]);
				combat.turns[0] = true;
				displayChar();
			}
		} else if (combat.playerAction[0] === 4) {
			combat.checkStatus(player, 0, swap);
			function swap() {
				combat.turns[0] = true;
				playerEquip(combat.playerAction[1]);
			}
		} else if (combat.playerAction[0] === 5) {
			combat.turns[0] = true;
			combat.checkStatus(player, 0, combat.flee);
		} else if (combat.playerAction[0] === 6) {
			combat.checkStatus(player, 0, combat.block);
		}
		itemSet(0)
		combat.turns[0] = true;
	}
	
	combat.block = function() {
		combat.turns[0] = true;
		document.getElementById("prompt").innerHTML = "You hold up your shield and brace for the enemy's attack. ";
		buttonReset();
		setButton(0, "Okay.", combat.checkRound);
	}
	
	combat.displayAttacks = function() {
		document.getElementById("prompt").innerHTML = "Round: "+combat.round+". What would you like to do?";
		buttonReset();
		var b = 3;
		setButton(0, "Attack with " + player.weapons[player.weaponEquipped].name, wpn);
		setButton(1, "Cast Attack Spell", combat.displaySpells);
		setButton(2, "Cast Effect Spell", combat.displayEffectSpells);
		if (checkForStuff(player.armorTypeEquipped, "shield") || checkForStuff(player.armorTypeEquipped, "buckler")) {
			setButton(b, "Block with shield", shield);
			b += 1;
		}
		setButton(b, "Use Item", useItem);
		setButton(b+1, "Swap Weapon", equip);
		setButton(b+2, "Flee", flee);
		
		function wpn() {
			if (player.weapons[player.weaponEquipped].projectile !== false) {
				if (checkForStuff(player.weapons, player.weapons[player.weaponEquipped].projectile) === false) { 
					goBack("You are out of ammo. ")
					buttonVarArray[0] = combat.displayAttacks;
					return;
				}
			} else {
				combat.playerAction[0] = 0;
				combat.startRound();
			}
		}
		function shield() {
			combat.playerAction[0] = 6;
			combat.blocking = true;
			combat.startRound();			
		}
		
		function flee(buttonNum) {
			combat.playerAction[0] = 5;
			combat.startRound();
		}
		function equip() {
			equipStuff(0);
		}
	}
	
	combat.displaySpells = function() {
		goBack("Which Attack Spell would you like to use?");
		buttonVarArray[0] = combat.displayAttacks;
		loadAttackSpells();
		function setItemNum(itemNum) {
			if (spells.testManna(player, player.spellsAttack[itemNum].mannaCost) === false) {
				buttonVarArray[0] = combat.displaySpells;
				return;
			} else {
				combat.playerAction = [1, itemNum];
				combat.startRound();
			}
		}
		itemSet(setItemNum);
	}
	
	combat.displayEffectSpells = function() {
		goBack("Which Effect Spell would you like to use?");
		buttonVarArray[0] = combat.displayAttacks;
		loadEffectSpells();
		function setItemNum(itemNum) {
			if (spells.testManna(player, player.spells[itemNum].mannaCost) === false) {
				return;
			} else {
				combat.playerAction = [2, itemNum];
				combat.startRound();
			}
		}
		itemSet(setItemNum);
	}

	combat.displayDamage = function(atkType, spellNum) {	
		combat.turns[0] = true;
		buttonReset();
		setButton(0, "Okay.", combat.checkRound);
		var attackBonus, dmg;
		var crit = 1;
		var spellBonus = combat.bonus(player.iq);
		var defenseBonus = combat.bonus(combat.opponent.armorClass)
		var roll = rng(10);
		var accuracy = combat.bonus(player.dexterity)-combat.bonus(combat.opponent.dexterity)+50+(roll*5);
		if (player.weapons[player.weaponEquipped].bonus === 0) {
			attackBonus =  combat.bonus(player.strength);
		} else {attackBonus = combat.bonus(player.dexterity);}
		if (attackBonus <= 1) {attackBonus = 1;}
		if (defenseBonus <= 1) {defenseBonus = 1;}
		var bonus = attackBonus/defenseBonus;
		if (bonus <= 0) {bonus = 0;}
		if (combat.checkStatusPos(player, "blinded") !== false) {
			accuracy -= 50;
		}
		if (roll === 10) {
			document.getElementById("prompt").innerHTML = "Critical hit! You attack "+combat.opponent.name+" with a ";
			crit = 1.5;
			atkCheck();
		} else if (roll === 1) {
			missed();
			return;
		} else if (accuracy > 50) {
			document.getElementById("prompt").innerHTML = "You attack "+combat.opponent.name+" with a ";
			atkCheck(); 
		} else {
			missed();
			return;
		}
		function weaponAtk() {		
			weapons.projectile(player, player.weapons[player.weaponEquipped]);
			var effect = 0;
			if (player.weapons[player.weaponEquipped].effect !== false) {
				effect = function() {combat.effect(combat.opponent, player.weapons[player.weaponEquipped].effect, player.weapons[player.weaponEquipped].effectChance)};
			}
			document.getElementById("prompt").innerHTML += player.weapons[player.weaponEquipped].name;
			var weaponDmgType = player.weapons[player.weaponEquipped].dmgType;
			var effectNum = combat.damageresistance(combat.opponent, weaponDmgType);
			var dmg = Math.floor((player.weapons[player.weaponEquipped].use()+bonus)*effectNum*crit)
			immunity(effectNum, weaponDmgType, dmg, effect);
		}
		function spellAtk() {	
			var effect = 0;
			if (player.manna < player.spellsAttack[spellNum].mannaCost) {
				goBack("You do not have enough manna. ")
				combat.turns[0] = false;
				buttonVarArray[0] = combat.displaySpells;
				return;
			}
			if (player.spellsAttack[spellNum].effect !== false) {
				effect = function() {
					combat.effect(combat.opponent, player.spellsAttack[spellNum].effect, player.spellsAttack[spellNum].effectChance)
				}
			}
			var spellDmgType = player.spellsAttack[spellNum].dmgType;
			var effectNum = combat.damageresistance(combat.opponent, spellDmgType);	
			var dmg = Math.floor((player.spellsAttack[spellNum].use()+bonus)*effectNum*crit)
			document.getElementById("prompt").innerHTML += player.spellsAttack[spellNum].name+" spell";
			player.manna -= player.spellsAttack[spellNum].mannaCost;
			if (player.manna<=0) {
				player.manna = 0;
			}
			immunity(effectNum, spellDmgType, dmg, effect);
		}
		function immunity(effectNum, dmgType, dmg, effect) {	
			if (effectNum === 0) {
				document.getElementById("prompt").innerHTML += ". The "+combat.opponent.name+" is immune to "+dmgType+" damage.";
				return;
			} else if (effectNum === 0.5) {
				document.getElementById("prompt").innerHTML += ". Your attack wasn't very effective against "+combat.opponent.name
			} else if (effectNum === 2) {
				document.getElementById("prompt").innerHTML += ". The "+combat.opponent.name+" took a heavy blow from your attack";
			}
			if (dmg <= 0) {
				combat.opponent.health -= 1;
				document.getElementById("prompt").innerHTML += ". The "+combat.opponent.name+" was barely damaged by your attack. ";
			} else {
				document.getElementById("prompt").innerHTML += ". The "+combat.opponent.name+" has lost "+dmg+" health points. ";
				combat.opponent.health -= dmg;
			}
			displayChar();
			if (checkEnemyHealth()=== false) {
				buttonVarArray[0] = levelUp
			} else if (effect !== 0) {
				buttonVarArray[0] = effect;
			}
		}
		function checkEnemyHealth() {
			if (combat.opponent.health <= 0) {
				combat.opponent.health = 0;
				combat.victory();
				return false;
			}
		}
		function missed() {
			weapons.projectile(player, player.weapons[player.weaponEquipped])
			if (atkType === 1) {
				if (player.spellsAttack[spellNum].mannaCost > player.manna) {
					goBack("You do not have enough manna. ")
					combat.turns[0] = false;
					buttonVarArray[0] = combat.displaySpells;
					return;
				} else {
					player.manna -= player.spellsAttack[spellNum].mannaCost;
					goBack("You missed! ");
					buttonVarArray[0] = combat.checkRound;
				}
			}
			goBack("You missed! ");
			displayChar();
		}
		function atkCheck() {
			if (atkType === 0) {	
				weaponAtk();	
			} else {spellAtk();}
		}
	}
	
	combat.opponentAttacks = function(atkType, spellNum) {
		combat.turns[1] = true;
		buttonReset();
		if (combat.blocking === true) {
			document.getElementById("prompt").innerHTML = "You block the "+combat.opponent.name+"'s attack with your shield. ";
			combat.blocking = false;
			setButton(0, "Okay.", combat.checkRound);
			return;
		}
		setButton(0, "Okay.", combat.checkRound);
		var attackBonus, dmg;
		var spellBonus = combat.bonus(combat.opponent.iq);
		var defenseBonus = combat.bonus(player.armorClass);
		var crit = 1;
		var roll = rng(10);
		var accuracy = combat.bonus(combat.opponent.dexterity)-combat.bonus(player.dexterity)+50+(roll*5);
		if (combat.opponent.weapons[combat.opponent.weaponEquipped].bonus === 0) {
			attackBonus = combat.bonus(combat.opponent.strength);
		} else {attackBonus = combat.bonus(combat.opponent.dexterity);}
		if (attackBonus <= 1) {attackBonus = 1;}
		if (defenseBonus <= 1) {defenseBonus = 1;}
		var bonus = attackBonus/defenseBonus;
		if (bonus <= 0) {bonus = 0;}
		if (combat.checkStatusPos(player, "blinded") !== false) {
			accuracy -= 50;
		}
		if (roll === 10) {
			document.getElementById("prompt").innerHTML = "Critical hit! The "+combat.opponent.name+" attacked you with a ";
			crit = 1.5;
			atkCheck();
		} else if (roll === 1) {
			missed();
			return;
		} else if (accuracy > 50) {
			document.getElementById("prompt").innerHTML = "The "+combat.opponent.name+" attacked you with a ";
			atkCheck();
		} else {
			missed();
			return;
		}
		function weaponAtk() {
			weapons.projectile(combat.opponent, combat.opponent.weapons[combat.opponent.weaponEquipped])
			var effect = 0;
			if (combat.opponent.weapons[combat.opponent.weaponEquipped].effect !== false) {
				effect = function() {combat.effect(player, combat.opponent.weapons[combat.opponent.weaponEquipped].effect, combat.opponent.weapons[combat.opponent.weaponEquipped].effectChance)};
			}
			var weaponDmgType = combat.opponent.weapons[combat.opponent.weaponEquipped].dmgType;
			var effectNum = combat.damageresistance(player, weaponDmgType); 
			document.getElementById("prompt").innerHTML += combat.opponent.weapons[combat.opponent.weaponEquipped].name;
			var dmg = Math.floor((combat.opponent.weapons[combat.opponent.weaponEquipped].use()+bonus)*effectNum*crit)
			immunity(effectNum, weaponDmgType, dmg, effect);
		}
		function spellAtk() {
			var effect = 0;
			if (combat.opponent.spellsAttack[spellNum].effect !== false) {
				effect = function() {combat.effect(player, combat.opponent.spellsAttack[spellNum].effect, combat.opponent.spellsAttack[spellNum].effectChance)}
			}
			var spellDmgType = combat.opponent.spellsAttack[spellNum].dmgType;
			var effectNum = combat.damageresistance(player, spellDmgType);
			var dmg = Math.floor((combat.opponent.spellsAttack[spellNum].use()+bonus)*effectNum*crit)
			document.getElementById("prompt").innerHTML += combat.opponent.spellsAttack[spellNum].name+" spell"
			combat.opponent.manna -= combat.opponent.spellsAttack[spellNum].mannaCost;
			immunity(effectNum, spellDmgType, dmg, effect);
		}
		function immunity(effectNum, dmgType, dmg, effect) {
			if (effectNum === 0) {
				document.getElementById("prompt").innerHTML += ". However, you are immune to "+dmgType+" damage.";
				return;
			} else if (effectNum === 0.5) {
				document.getElementById("prompt").innerHTML += ". "+combat.opponent.name+"'s attack wasn't very effective against you";
			} else if (effectNum === 2) {
				document.getElementById("prompt").innerHTML += ". You took a heavy blow from the attack";
			}
			if (dmg <= 0) {
				player.health -= 1;
				document.getElementById("prompt").innerHTML += ". You were barely damaged by "+combat.opponent.name+"'s attack. ";
			} else {
				document.getElementById("prompt").innerHTML += ". You lost "+dmg+" health points. ";
				player.health -= dmg;
			}
			if (checkPlayerHealth() === false) {
				setButton(0, "Continue.", combat.defeatFunc);
			} else if (effect !== 0) {
				buttonVarArray[0] = effect;
			}
		}
		function missed() {
			weapons.projectile(combat.opponent, combat.opponent.weapons[combat.opponent.weaponEquipped]);
			if (atkType === 1) {
				combat.opponent.manna -= combat.opponent.spellsAttack[spellNum].mannaCost;
			}
			goBack("The "+combat.opponent.name+" tried to attack you, but it missed!");
		}
		function checkPlayerHealth() {
			if (player.health <= 0) {
				player.health = 0
				return false;
			}
			displayChar();
		}
		function atkCheck() {
			if (atkType === 0) {
				weaponAtk();
			} else {spellAtk();}
		}
	}
	
	combat.opponentUseItem = function(itemNum) {
		if (combat.opponent.itemsQuantity[itemNum]>=1) {
			combat.turns[1] = true;
			combat.opponent.items[itemNum].use(combat.opponent, itemNum);
		}
	}

	combat.damageresistance = function(target, dmgType) {
		if (target.weakness.length === 0) {
			return 1;
		}
		for (i=0; i<target.weakness.length; i+=1) {
			var weakType = target.weakness[i];									// 0 = immune, 0.5 = half damage, 1 = normal damage, 2 = double damage
			var effectNum = parseInt(weakType[weakType.length-1]);
			if (effectNum === 1) {effectNum = 0.5;};
			weakType = weakType.slice(0, weakType.length-1);
			if (dmgType === weakType) {return effectNum;}
		}
		return 1;
	}
	
	combat.boostTempStat = function(target, amount, rounds, type) {
		if (target === 0) {
			combat.tempStatBoost[type] += amount;
			combat.tempStatBoostRounds[type] = rounds;
			if (type === 0) {
				player.strength += amount;
			} else if (type === 1) {
				player.dexterity += amount;
			} else if (type === 2) {
				player.iq += amount;
			} else if (type === 3) {
				player.armorClass += amount;
			}
		} else {
			combat.opponentTempStatBoost[type] += amount;
			combat.opponentTempStatBoostRounds[type] = rounds;
			if (type === 0) {
				combat.opponent.strength += amount;
			} else if (type === 1) {
				combat.opponent.dexterity += amount;
			} else if (type === 2) {
				combat.opponent.iq += amount;
			} else if (type === 3) {
				combat.opponent.armorClass += amount;
			}
		}
		displayChar();
	}
	
	combat.removeTempStat = function(target, amount, type) {
		if (target === 0) {
			if (combat.tempStatBoost[type] < amount) {
				amount = combat.tempStatBoost[type];
			}
			if (type === 0) {
				player.strength -= amount;
			} else if (type === 1) {
				player.dexterity -= amount;
			} else if (type === 2) {
				player.iq -= amount;
			} else if (type === 3) {
				player.armorClass -= amount;
			}
			combat.tempStatBoost[type] = 0;
			combat.tempStatBoostRounds[type] = "a";
		} else {
			if (combat.opponentTempStatBoost[type] < amount) {
				amount = combat.opponentTempStatBoost[type];
			}
			if (type === 0) {
				combat.opponent.strength -= amount;
			} else if (type === 1) {
				combat.opponent.dexterity -= amount;
			} else if (type === 2) {
				combat.opponent.iq -= amount;
			} else if (type === 3) {
				combat.opponent.armorClass -= amount;
			}
			combat.opponentTempStatBoost[type] = 0;
			combat.opponentTempStatBoostRounds[type] = "a";
		}
		displayChar();
	}
	
	combat.checkTempStat = function(target, boost, rounds, func) {
		var amount, name;
		if (target === player) {
			name = "Your"
		} else {
			name = target.name
		}
		var txt = name+" stat boost wore off. "
		if (rounds[0] === "a" && rounds[1] === "a" && rounds[2] === "a" && rounds[3] === "a") {
			func();
			return;
		} else {
			buttonVarArray[0] = func;
		}
		if (rounds[0] === 0 || rounds[1] === 0 || rounds[2] === 0 || rounds[3] === 0) {
			buttonVarArray[0] = func;
			if (rounds[0] === 0) {
				amount = boost[0];
				target.strength -= amount;
				goBack(txt)
				boost[0] = 0;
				rounds[0] = "a";
			}
			if (rounds[1] === 0) {
				amount = boost[1];
				target.dexterity -= amount;
				goBack(txt)
				boost[1] = 0;
				rounds[1] = "a";
			}
			if (rounds[2] === 0) {
				amount = boost[2];
				target.iq -= amount;
				goBack(txt)
				boost[2] = 0;
				rounds[2] = "a";
			}
			if (rounds[3] === 0) {
				amount = boost[3];
				target.armorClass -= amount;
				goBack(txt)
				boost[3] = 0;
				rounds[3] = "a";
			}
			displayChar();
		} else {
			func();
			return;
		}
	}
	
	combat.resetTempStat = function() {
		if (combat.tempStatBoost[0] !== 0) {combat.removeTempStat(0, combat.tempStatBoost[0], 0);}
		if (combat.tempStatBoost[1] !== 0) {combat.removeTempStat(0, combat.tempStatBoost[1], 1);}
		if (combat.tempStatBoost[2] !== 0) {combat.removeTempStat(0, combat.tempStatBoost[2], 2);}
		if (combat.tempStatBoost[3] !== 0) {combat.removeTempStat(0, combat.tempStatBoost[3], 3);}
		combat.opponentTempStatBoost = [0,0,0,0];
		combat.opponentTempStatBoostRounds = ["a","a","a","a"];
	}
	
	combat.victory = function() {
		document.getElementById("prompt").innerHTML += "You defeated the "+combat.opponent.name+"! You gained "+combat.opponent.experience+" experience points. "
		for (let i=0; i<combat.opponent.weapons.length; i+=1) {
			if (combat.opponent.weapons[i].enemyAtk === true || combat.opponent.weapons[i] === weapons.fist) {
				combat.opponent.weapons.splice(i,1)
			}
		}
		currentShop = combat.opponent;
		loadLoot();
		combat.playerAction = [0,0];
		player.experience += combat.opponent.experience;
		combat.round = 1;
		combat.resetTempStat();
		displayChar();
		loadInventory();
		combat.defeatFunc = gameOver;
		combat.cannotRun = false;
		buttonReset();
		setButton(0, "Continue.", levelUp);
	}
	var dropStr = "";
	var dropArr = 0;
	var dropArrQuantity = 0;
	function dropStuffThru(arr, arrQuantity, str) {
		if (combat.active) {return;}
		dropStr = str;
		dropArr = arr;
		dropArrQuantity = arrQuantity;
		buttonReset();
		goBack("Click the "+str+" you would like to drop.");
		itemSet(quantityCheck);
	}
	function dropStuff(arr, arrQuantity, str) {
		var art = "a "
		if (str === "item"){art = "an "}
		else if (str === "armor"){art = "some "}
		document.getElementById("prompt").innerHTML = "Your "+str+"s is full. Do you want to drop "+art+str+"?";
		buttonReset();
		setButton(0, "Yes", dropStuff1);
		setButton(1, "No.", data[player.progress]);
		function dropStuff1() {
			dropStuffThru(arr, arrQuantity, str);
		}
	}
	function quantityCheck(itemNum) {
		if (dropStr === "weapon" && itemNum === 0) {
			goBack("You cannot drop your fists. ")
			itemSet(quantityCheck);
			return;
		}
		if (dropArrQuantity[itemNum] >= 1) {
			var howMany = window.prompt("How many would you like to drop?");
			var howManyNum = parseInt(howMany);
			if (howManyNum > 0) {
				if (dropArrQuantity[itemNum] === 1 || dropArrQuantity[itemNum] === howManyNum){
					removeStuff(dropArr, dropArrQuantity, itemNum, dropStr);
					document.getElementById("prompt").innerHTML = "The "+dropStr+" has been dropped.";
					return;
				}
			}
			if (100 > howManyNum > 0 && howManyNum < dropArrQuantity[itemNum] && dropArrQuantity[itemNum]>1) {
				arrQuantity[itemNum] -= howManyNum;
			} else  {return}
		}
		if (dropStr === "item") {loadInventory();} else if (dropStr === "weapon") {loadWeapons();} else {loadArmor();}
	}
	
	function gameOver() {
		combat.active = false;
		goBack("You have died. All your inventory, weapons, and armor have been lost. ");
		buttonVarArray[0] = data0;
		player.gold = 0;
		player.items = [];
		player.itemsQuantity = [];
		player.weapons = [];
		player.weaponsQuantity = [];
		player.armor = [];
		player.armorQuantity = [];
		player.armorIsEquipped = [];
		player.armorTypeEquipped = [];
		player.weakness = [];
		player.quests = [];
		player.questProgress = [];
		fillArray(player.flags, 64, false);
		player.weapons[0] = weapons.fist;
		player.weaponEquipped = 0;
		player.health = player.hitPoints;
		player.manna = player.mannaMax;
		player.armorClass = player.defense
		combat.resetTempStat();
		displayChar();
		combat.round = 1;
		combat.playerAction = [0,0];
		combat.opponentTempStatBoost = [0,0,0,0];
		combat.opponentTempStatBoostRounds = ["a","a","a","a"];
		combat.turns = [false, false];
		combat.cannotRun = false;
		combat.statusDefeat = false;
		combat.statusVictory = false;
		combat.statusDefeatFunc = false;
		combat.statusVictoryFunc = false;
		tournament.reset()
		guardDeadLoc = "";
		spices.common = 12;
		spices.modRare = 20;
		spices.rare = 4;
		loadInventory();
	}
	
	function fightEn(oppo, name) {
		var lvl = window.prompt("What level "+name+" would you like to fight?")
		if (lvl === "") {
			lvl = 1;
		} else {lvl = parseInt(lvl)}
		combat.active = true;
		combat.opponent = enemy.create(oppo(), lvl);
		combat.challenge();
	}
	
	function rat() {
		document.getElementById("prompt").innerHTML = "You have been approached by a giant rat. ";
		buttonReset();
		setButton(0, "Continue.", fight);
		function fight() {
			fightEn(enemy.giantRat, "Rat")
		}
	}
	
	function spider() {
		document.getElementById("prompt").innerHTML = "You have been approached by a giant spider. ";
		buttonReset();
		setButton(0, "Continue.", fight);
		function fight() {
			fightEn(enemy.giantSpider, "Giant Spider")
		}
	}
	
	function frostSpider() {
		document.getElementById("prompt").innerHTML = "You have been approached by a frost spider. ";
		buttonReset();
		setButton(0, "Continue.", fight);
		function fight() {
			fightEn(enemy.frostSpider, "Frost Spider")
		}
	}
	
	function babyDragon() {
		document.getElementById("prompt").innerHTML = "You have been approached by a Baby Dragon. ";
		buttonReset();
		setButton(0, "Continue.", fight);
		function fight() {
			fightEn(enemy.babyDragon, "Baby Dragon")
		}
	}
	
	function wizard() {
		document.getElementById("prompt").innerHTML = "You have been approached by a wizard. ";
		buttonReset();
		setButton(0, "Continue.", fight);
		function fight() {
			fightEn(enemy.wizard, "Wizard")
		}
	}
	
	function wolf() {
		document.getElementById("prompt").innerHTML = "You have been approached by a wolf. ";
		buttonReset();
		setButton(0, "Continue.", fight);
		function fight() {
			fightEn(enemy.wolf, "Wolf")
		}
	}
	
	function goblin() {
		document.getElementById("prompt").innerHTML = "You have been approached by a goblin. ";
		buttonReset();
		setButton(0, "Continue. ", fight);
		function fight() {
			fightEn(enemy.goblin, "Goblin")
		}
	}
	
	function guard() {
		document.getElementById("prompt").innerHTML = "You have been approached by a palace guard. ";
		buttonReset();
		setButton(0, "Continue.", fight);
		function fight() {
			fightEn(enemy.guard, "Guard")
		}
	}
	
	function freeShit() {
		buttonReset();
		goBack("Here's some free shit.");
		for (let i=1; i<14; i+=1) {
			addStuff(player.weapons, player.weaponsQuantity, 3, weapons.array[i], "weapon");
		}
		addStuff(player.weapons, player.weaponsQuantity, 20, weapons.array[14], "weapon");
		addStuff(player.weapons, player.weaponsQuantity, 20, weapons.array[15], "weapon");
		addStuff(player.weapons, player.weaponsQuantity, 20, weapons.array[16], "weapon");
		addStuff(player.weapons, player.weaponsQuantity, 20, weapons.array[17], "weapon");
		addStuff(player.weapons, player.weaponsQuantity, 3, weapons.array[18], "weapon");
		for (let i=0; i<9; i+=1) {
			addStuff(player.items, player.itemsQuantity, 3, items.array[i], "item");
		}
		for (let i=0; i<24; i+=1) {
			addStuff(player.armor, player.armorQuantity, 3, armor.array[i], "armor");
		}
		loadInventory();
	}
	
	function freeSpellBooks() {
		goBack("Here's some free spell books.");
		for (i=0; i<20; i+=1) {
			addStuff(player.items, player.itemsQuantity, 1, items.array[(i+9)], "item");
		}
		loadInventory();
	}
	
	function fightTest() {
		document.getElementById("prompt").innerHTML = 'A large man in steel plate armor approaches you. "Welcome to the '+"Gladiator's"+' Arena. You could fight any '+
		'creature you want at any level. Who would you like to fight?"';
		combat.victoryFunc = data[player.progress];
		buttonReset();
		setButton(0, "Goblin.", goblin);
		setButton(1, "Guard.", guard);
		setButton(2, "Wolf.", wolf);
		setButton(3, "Giant Spider.", spider);
		setButton(4, "Giant Rat.", rat);
		setButton(5, "Frost Spider.", frostSpider);
		setButton(6, "Wizard.", wizard);
		setButton(7, "Baby Dragon.", babyDragon);
		setButton(8, "Leave.", data67);
	}
	
	function data0() {
		player.progress = 0;
		document.getElementById("prompt").innerHTML = "You start off at your house in the city of Oakloft. What would you like to do?"
		currentShop = homeInventory;
		buttonReset();
		setButton(0, "Go outside.", data1);
		setButton(1, "Open inventory chest.", loadBank);
		setButton(2, "Inspect room.", checkFlag);
		setButton(3, "Go to bed.", data68);
		setButton(4, "Get some free shit.", freeShit);
		setButton(5, "Get some free spell books.", freeSpellBooks);
		function checkFlag() {
			if (player.flags[0] === false) {data3();} else {data5();}
		}
	}
	
	function data1() {
		player.progress = 1;
		document.getElementById("prompt").innerHTML = "You are outside on the road by your house. What would you like to do?";
		buttonReset();
		setButton(0, "Walk to town square.", data2);
		setButton(1, "Head toward the outskirts.", data6);
		setButton(2, "Go back inside house.", data0);
	}
	
	function data2() {
		player.progress = 2;
		if (player.flags[nwFlags + 57] === true) {
			if (rng(20) > 15) {
				data63();
				return;
			}
		}
		document.getElementById("prompt").innerHTML = "The town square is packed with people moving in all directions. The two most popular sites are the bank and the "+
		"general store. You can see the palace in the distance. What would you like to do?";
		buttonReset();
		setButton(0, "Go to the General Store.", store);
		setButton(1, "Go to the bank.", bank);
		setButton(2, "Head to the palace.", data8);
		setButton(3, "Head to the Gladiator's Arena.", data67);
		setButton(4, "Head back home.", data1);
		function bank() {
			currentShop = townBank;
			loadBank();
		}
		function store() {
			currentShop = townShop;
			loadShop();
		}
	}
	
	function data3() {
		document.getElementById("prompt").innerHTML = "You found a dagger.";
		buttonReset();
		setButton(0, "Put it in weapons.", data4);
		setButton(1, "Leave it here.", data0);
	}
	
	function data4() {
		var full = checkQuantityFull(player.weapons, player.weaponsQuantity, weapons.dagger);
		if (full === false) {
			player.flags[0] = true;
			buttonReset();
			goBack("The dagger was placed in your weapons.");
			addStuff(player.weapons, player.weaponsQuantity, 1, weapons.dagger, "weapon");
			loadWeapons();
		} else {dropStuff(player.weapons, player.weaponsQuantity, "weapon");}
	}

	function data5() {
		player.progress = 5;
		document.getElementById("prompt").innerHTML = "There's nothing here.";
		buttonReset();
		setButton(0, "Go back.", data0);
	}

	function data6() {
		player.progress = 6;
		document.getElementById("prompt").innerHTML = "You are at the edge of the city. A road leads from the town into a forest. There is a stranger staring at you. ";
		buttonReset();
		var b = 1;
		setButton(0, "Talk to stranger.", data11);
		if (quests.find(0) !== false) {
			setButton(b, "Walk down the road.", data7);
			b += 1;
		}
		setButton(b, "Head back home.", data1);
	}
	
	function data7() {
		if (Math.random()>0.3) {
			document.getElementById("prompt").innerHTML = "As you walk down the road, a goblin comes out of nowhere.";
			buttonReset();
			setButton(0, "Continue.", fight);
			function fight() {
				combat.active = true;
				combat.victoryFunc = data21;
				combat.opponent = enemy.create(enemy.goblin(), enemy.lvlLessThan());
				combat.challenge();
			}
		} else {data21();}
	}
	
	function data8() {
		player.progress = 8;
		if (player.flags[nwFlags + 57] === true) {
			if (rng(20) > 15) {
				data63();
				return;
			}
		}
		document.getElementById("prompt").innerHTML = "You arrive at the palace gate. There is a guard standing watch.";
		buttonReset();
		var b = 1;
		setButton(0, "Talk to the guard.", data9);
		if (quests.find(1) !== false) {
			setButton(b, "Enter the palace courtyard.", data32);
			b += 1;
		}
		setButton(b, "Go back to the town square.", data2);
	}
	
	function data9() {
		player.progress = 9;
		buttonReset();
		if (player.questProgress[quests.find(1)] >= quests.array[1].length) {
			document.getElementById("prompt").innerHTML = "Hey, so how was the tournament?";
			setButton(0, "It was great! I won first place.", next);
			function next() {
				document.getElementById("prompt").innerHTML = "Did you take an arrow to the knee?";
				setButton(0, "Ugh.", data8);
			}
		} else {
			document.getElementById("prompt").innerHTML = "I used to be an adventurer like you once, but then I took an arrow to the knee.";
			setButton(0, "Yeah. Arrows suck. My sword would have taken your knee off.", data10);
			setButton(1, "Cool story, bro.", data8);
			setButton(2, "What are you doing here?.", data27);
		}
	}
	
	function data10() {
		player.progress = 10;
		document.getElementById("prompt").innerHTML = "Then I guess I was fortunate.";
		buttonReset();
		setButton(0, "What are you doing here?.", data27);
		setButton(1, "Okay. Bye!", data8);
	}
	
	function data11() {
		player.progress = 11;
		if (player.questProgress[quests.find(0)] >= 4) {
			document.getElementById("prompt").innerHTML = "We have no more business to discuss. Pretend like you don't know me. ";
			buttonReset();
			setButton(0, "Okay.", data6);
		} else if (player.questProgress[quests.find(0)] >= 0) {
			document.getElementById("prompt").innerHTML = "So how did it go?";
			buttonReset();
			if (player.questProgress[quests.find(0)] >= 2) {
				setButton(0, "It was great. I stole a lot of shit.", data25);
				setButton(1, "(Lie) I didn't go yet.", data24);
			} else {
				setButton(0, "(Lie) It was great. I stole a lot of shit.", data24);
				setButton(1, "I didn't go yet.", data26);
			}
		} else {
			document.getElementById("prompt").innerHTML = "Hi. I'm a stranger.";
			buttonReset();
			setButton(0, "No shit.", data12);
			setButton(1, "What are you doing?", data14);
		}
	}
	
	function data12() {
		player.progress = 12;
		document.getElementById("prompt").innerHTML = "That's kind of rude.";
		buttonReset();
		setButton(0, "You said it first. I just agreed with you.", data13);
		setButton(1, "So what?", data13);
	}
	
	function data13() {
		player.progress = 13;
		document.getElementById("prompt").innerHTML = "Fair enough.";
		buttonReset();
		setButton(0, "What are you doing?", data14);
		setButton(1, "Yeah. Bye.", data6);
	}
	
	function data14() {
		player.progress = 14;
		document.getElementById("prompt").innerHTML = "I'm waiting for something interesting to happen. It's pretty boring in this town.";
		buttonReset();
		setButton(0, "Nothing interesting happens unless you make it happen.", data15);
		setButton(1, "Cool. See ya.", data6);
	}
	
	function data15() {
		player.progress = 15;
		document.getElementById("prompt").innerHTML = "That's an interesting point. What do you have in mind?";
		buttonReset();
		setButton(0, "Bath tub full of pudding.", data16);
		setButton(1, "Definitely not talking to you.", data17);
		setButton(2, "I don't know. What do you have in mind?", data18);
	}
	
	function data16() {
		player.progress = 16;
		document.getElementById("prompt").innerHTML = "And you thought I was a stranger.";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data17() {
		player.progress = 17;
		document.getElementById("prompt").innerHTML = "Are you just an asshole all the time?";
		buttonReset();
		setButton(0, "Yes.", data6);
	}
	
	function data18() {
		player.progress = 18;
		document.getElementById("prompt").innerHTML = "Why don't you go break into that house at the end of the road and see what you can steal?";
		buttonReset();
		setButton(0, "Sounds like fun.", addQuest);
		setButton(1, "No thanks.", data20);
		function addQuest() {
			quests.add(0);
			data19();
		}
	}
	
	function data19() {
		player.progress = 19;
		document.getElementById("prompt").innerHTML = "Come tell me about it when you get back.";
		buttonReset();
		setButton(0, "Okay.", data6);
	}
	
	function data20() {
		player.progress = 20;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data21() {
		player.progress = 21;
		if (player.questProgress[quests.find(0)] === 0) {
			quests.update(0);
		}
		document.getElementById("prompt").innerHTML = "You found a house. It looks like there are many valuable things in there. What do you want to do?";
		buttonReset();
		setButton(0, "Break in.", nightsWork0);
		setButton(1, "Leave.", data6);
		setButton(2, "Keep Walking.", data23);
	}
	
	function data22() {
		player.progress = 11;
		document.getElementById("prompt").innerHTML = "Which items would you like me to take a look at?";
		if (player.questProgress[quests.find(0)] === 3) {
			quests.update(0);
		}
		buttonReset();
		var b = 0;
		if (checkForStuff(player.items, items.rareWine) !== false) {
			setButton(b, "Rare Wine.", nightsWork35);
			b += 1;
		}
		if (checkForStuff(player.items, items.burnOintment) !== false) {
			setButton(b, "Burn Ointment.", nightsWork34);
			b += 1;
		}
		if (checkForStuff(player.items, items.tapestry) !== false) {
			setButton(b, "Tapestry.", nightsWork172);
			b += 1;
		}
		if (checkForStuff(player.items, items.goldKey) !== false) {
			setButton(b, "Golden Key.", nightsWork169);
			b += 1;
		}
		if (checkForStuff(player.items, items.teaService) !== false) {
			setButton(b, "Tea Service.", nightsWork179);
			b += 1;
		}
		if (checkForStuff(player.items, items.spoon) !== false) {
			setButton(b, "Spoons.", nightsWork132);
			b += 1;
		}
		if (checkForStuff(player.items, items.bagOfGems) !== false) {
			setButton(b, "Bag of Gems.", nightsWork165);
			b += 1;
		}
		if (checkForStuff(player.items, items.fatsosPapers) !== false) {
			setButton(b, "Fatso's Papers.", papers);
			b += 1;
		}
		setButton(b, "Go back.", levelUp);
		function papers() {
			if (rng(20)+combat.bonus(player.iq) > 12) {
				nightsWork62();
			} else {nightsWork166();}
		}
	}
	
	function data23() {
		player.progress = 23;
		document.getElementById("prompt").innerHTML = "There's nothing else here.";
		buttonReset();
		setButton(0, "Go back.", data21);
	}

	function data24() {
		player.progress = 24;
		document.getElementById("prompt").innerHTML = "You liar!!";
		buttonReset();
		setButton(0, "Yeah.... I know.", data6);
	}

	function data25() {
		player.progress = 25;
		document.getElementById("prompt").innerHTML = "So I take it you need a fence to sell your stolen goods?";
		buttonReset();
		setButton(0, "Yes.", data22);
		setButton(1, "No.", data6);
		if (player.questProgress[quests.find(0)] === 2) {
			player.progress = 6;
			quests.update(0);
		}
	}

	function data26() {
		player.progress = 26;
		document.getElementById("prompt").innerHTML = "Well, what are you waiting for?";
		buttonReset();
		setButton(0, "I don't know.", data6);
	}
	
	function data27() {
		player.progress = 27;
		document.getElementById("prompt").innerHTML = "Well, I'm a guard. I'm guarding. It's my job to ask you what you're doing here. So, what are you doing here?";
		buttonReset();
		setButton(0, "I don't know.", data28);
		setButton(1, "Well, what is there to do here?", data29);
		setButton(2, "I guess I'll be leaving.", data8);
	}
	
	function data28() {
		player.progress = 28;
		document.getElementById("prompt").innerHTML = "Might I make a suggestion?";
		buttonReset();
		setButton(0, "Sure.", data29);
		setButton(1, "No.", data30);
		setButton(2, "Does this have anything to do with arrows?.", arrows);
		function arrows() {
			document.getElementById("prompt").innerHTML = "No... Yes... Maybe... I don't know. Do you want to hear it?";
			document.getElementById("button2").style = "display: none";
		}
	}
	
	function data29() {
		player.progress = 29;
		document.getElementById("prompt").innerHTML = "The king is hosting a tournament tonight. The grand prize is 1000 gold coins and the Sword of Embers. You should "+
		"enter the tournament. They still need one more fighter.";
		buttonReset();
		setButton(0, "That sounds like fun.", data31);
		setButton(1, "Not interested.", data30);
	}
	
	function data30() {
		player.progress = 30;
		document.getElementById("prompt").innerHTML = "Very well. You should head back to town square. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data8);
	}
	
	function data31() {
		player.progress = 31;
		document.getElementById("prompt").innerHTML = "Great! I'll open the gate for you. Enter the palace courtyard and talk to the king's steward to register. ";
		buttonReset();
		setButton(0, "Okay.", data8);
		quests.add(1);
	}
	
	function data32() {
		player.progress = 32;
		if (player.flags[nwFlags + 57] === true) {
			if (rng(20) > 15) {
				data63();
				return;
			}
		}
		document.getElementById("prompt").innerHTML = "You enter the palace courtyard and see a bunch of palace guards and knights standing around. The king's steward "+
		"is talking with his servants in the far corner. ";
		buttonReset();
		setButton(0, "Talk to the king's steward.", data33);
		setButton(1, "Talk to a palace guard.", data46);
		setButton(2, "Visit the dungeon.", data47);
		setButton(3, "Go to the arena.", data41);
		setButton(4, "Go back to the palace gate.", data8);
	}
	
	function data33() {
		player.progress = 33;
		buttonReset();
		if (player.questProgress[quests.find(1)] === 3) {
			document.getElementById("prompt").innerHTML = "Congratulations, Tournament Champion! You were pretty good out there. ";
			setButton(0, "Yeah, I'm a badass!", data32);
		} else if (player.questProgress[quests.find(1)] === 1) {
			document.getElementById("prompt").innerHTML = "What are you waiting for? Get to the arena! The tournament is starting!";
			setButton(0, "Okay.", data32);
		} else {
			document.getElementById("prompt").innerHTML = "Yes? Who are you and what the hell do you want? I'm very busy.";
			setButton(0, "I'm here for the tournament.", data40);
			setButton(1, "Why are you so busy? Can I help?.", data39);
			setButton(2, "Hi. How's the weather?.", data34);
			setButton(3, "Well, fuck you too!", data35);
			setButton(4, "Nevermind.", data32);
		}
	}
	
	function data34() {
		player.progress = 34;
		document.getElementById("prompt").innerHTML = "Are you serious? Get out of my face! ";
		buttonReset();
		setButton(0, "Okay.", data32);
	}
	
	function data35() {
		player.progress = 35;
		document.getElementById("prompt").innerHTML = "Who the hell do you think you are?!?";
		buttonReset();
		setButton(0, "Bitch! You started it!", data36);
		setButton(1, "I'm sorry. I don't know what came over me.", data34);
	}
	
	function data36() {
		player.progress = 36;
		document.getElementById("prompt").innerHTML = "Guards! Arrest this man immediately!";
		buttonReset();
		setButton(0, "But I didn't do anything!", data37);
	}
	
	function data37() {
		player.progress = 37;
		document.getElementById("prompt").innerHTML = "My word is law! You will rot in my dungeon!";
		buttonReset();
		setButton(0, "Continue.", data38);
	}
	
	function data38() {
		player.progress = 38;
		document.getElementById("prompt").innerHTML = "The guards beat you and knock you unconscious. They throw you in the dungeon and slam the door to your cell.";
		buttonReset();
		setButton(0, "Continue.", data65);
	}
	
	function data39() {
		player.progress = 39;
		document.getElementById("prompt").innerHTML = "I am short one fighter for the tournament. If we have to postpone, the king will be furious. ";
		buttonReset();
		setButton(0, "That's great! I'm here to fight in the tournament.", data40);
		setButton(1, "Sorry. Can't help you.", data32);
	}
	
	function data40() {
		player.progress = 40;
		document.getElementById("prompt").innerHTML = "Really? That's fantastic! Sign this paper and head over to the arena. We're about to start soon. ";
		buttonReset();
		setButton(0, "Okay.", addQuest);
		function addQuest() {
			quests.update(1);
			data32();
		}
	}
	
	function data41() {
		player.progress = 41;
		document.getElementById("prompt").innerHTML = "You enter the lobby for the arena. There is a door leading to the field and another leading to the stands. ";
		buttonReset();
		setButton(0, "Go to the field.", data43);
		setButton(1, "Go to the stands.", data42);
		setButton(2, "Go back.", data32);
	}
	
	function data42() {
		player.progress = 42;
		document.getElementById("prompt").innerHTML = "There are a bunch of people staring at an empty field. They are anxiously waiting on the tournament to start. ";
		buttonReset();
		setButton(0, "Go back to the lobby.", data41);
		if (player.questProgress[quests.find(1)] >= 2) {
			data62();
		}
	}
	
	function data43() {
		player.progress = 43;
		document.getElementById("prompt").innerHTML = 'As you head toward the entrance to the field, a palace guard stops you. "Hey! Where are you going? Is your name '+
		'on the list?"';
		buttonReset();
		var list = false;
		setButton(0, "What list?", whatList);
		setButton(1, "Yes, it is.", newAdd);
		setButton(2, "No, it isn't.", data44);
		setButton(3, "I don't know. My name is "+player.name+".", justAdd);
		if (player.questProgress[quests.find(1)] >= 2) {
			data62();
		}
		function whatList() {
			if (list === false) {
				document.getElementById("prompt").innerHTML = "The list of people competing in the tournament. Is your name on it? ";
				buttonReset();
				setButton(0, "Yes, it is.", newAdd);
				setButton(1, "No, it isn't.", data44);
				setButton(2, "I don't know. My name is "+player.name+".", justAdd);
			}
		}
		function onList() {
			document.getElementById("prompt").innerHTML = "Hmm. You're "+player.name+"? ";
			buttonReset();
			setButton(0, "Yes.", data45);
		}
		function justAdd() {
			onList();
			document.getElementById("prompt").innerHTML += "Yes, you're on here. You must have just been added. ";
		}
		function newAdd() {
			onList();
			document.getElementById("prompt").innerHTML += "You must be the new addition. ";
		}
	}
	
	function data44() {
		player.progress = 44;
		document.getElementById("prompt").innerHTML = "Well then you cannot go in here. ";
		buttonReset();
		setButton(0, "Okay.", data41);
	}
	
	function data45() {
		player.progress = 45;
		quests.update(1);
		document.getElementById("prompt").innerHTML = "You had better get on the field. The tournament is about to start. ";
		buttonReset();
		setButton(0, "Okay.", data48);
	}
	
	function data46() {
		player.progress = 46;
		document.getElementById("prompt").innerHTML = "I also used to be an adventurer like you once, but then I also took an arrow to the knee.";
		buttonReset();
		setButton(0, "Seriously? Nevermind. I don't want to talk to you.", data32);
	}
	
	function data47() {
		player.progress = 47;
		document.getElementById("prompt").innerHTML = "You enter the dungeon. There are a bunch of people in small cells. ";
		buttonReset();
		setButton(0, "Go back.", data32);
	}
	
	function data48() {
		player.progress = 48;
		document.getElementById("prompt").innerHTML = "You enter the field and one of the king's servants ushers you to the competitor's area. You hear the voice of "+
		'the king address the people. "Welcome to the Oakloft Tournament! Today we will have eight valiant warriors compete for glory, honor, and, of course, money! '+
		'The champion of the tournament will win 1000 gold coins and the legendary Sword of Embers. ';
		buttonReset();
		setButton(0, "Continue.", data49);
	}
	
	var tournament = {
		fighters: [data51, data52, data53, data54, data55, data56, data57,0],
		names: ["Donkey Kong","Charizard","Obi Wan Shinobi","Ganondorf","Link","Tanjiro","Ulfric Stormcloak",0],
		tier: 1,
		order: [],
		choose: [0,1,2,3,4,5,6,7],
		select: function() {
			for (i=0; i<8; i+=1) {
				var choice = (rng(8-i)-1)
				this.order.push(this.choose[choice]);
				this.choose.splice(choice,1);
			}
		},
		tierTwo: function() {
			this.tier += 1;
			for (i=0; i<this.order.length; i+=2) {
				if (this.order[i] === 7 || this.order[i+1] === 7) {
					this.order[i] = 7;
					this.order[i+1] = "a";
				} else {
					var lose = rng(2)-1
					this.order[i+lose] = "a";
				}
			}
			for (i=0; i<this.order.length; i+=1) {
				if (this.order[i] === "a") {
					this.order.splice(i,1);
					i-=1;
				}
			}
		},
		reset: function() {
			this.tier = 1;
			this.order = [];
			this.choose = [0,1,2,3,4,5,6,7];
		}
	}
	
	function data49() {
		player.progress = 49;
		tournament.reset();
		tournament.select();
		var count = 8;
		document.getElementById("prompt").innerHTML = 'The king continues, "In the first tier of fighting, it shall be '+decompress()+' versus '+decompress()+', '+
		decompress()+' versus '+decompress()+', '+decompress()+' versus '+decompress()+', and '+decompress()+' versus '+decompress()+'. They will fight to the death '+
		'for our amusement! Let the games begin!"'
		buttonReset();
		setButton(0, "Continue.", data50);
		function decompress() {
			count -= 1;
			if (tournament.names[tournament.order[count]] === 0) {
				return player.name;
			} else {
				return tournament.names[tournament.order[count]];
			}
		}
	}
	
	function data50() {
		player.progress = 50;
		var oppName;
		var oppNum;
		for (i=0; i<8; i+=2) {
			if (tournament.order[i+1] === 7) {
				oppName = tournament.names[tournament.order[i]];
				oppNum = i;
			} else if (tournament.order[i] === 7) {
				oppName = tournament.names[tournament.order[i+1]];
				oppNum = i+1;
			}
		}
		document.getElementById("prompt").innerHTML = 'The king returns to his throne and his steward emerges. He calls out, "Will '+player.name+' and '+oppName+
		' please take your positions and prepare for combat?';
		buttonReset();
		setButton(0, "Take your position.", fight);
		function fight() {
			combat.victoryFunc = data58;
			tournament.fighters[tournament.order[oppNum]]()
		}
	}
	
	function data51() {
		document.getElementById("prompt").innerHTML = 'Donkey Kong approaches you on the field. He grunts at you, "Ooh! Ooh! Ahh! Ahh!" then slams his fists on the '+
		'ground, staring you down with murdurous intent and heavy breathing.';
		buttonReset();
		setButton(0, "Continue.", fightFunc);
		function fightFunc() {
			combat.active = true;
			combat.opponent = enemy.create(enemy.donkeyKong(), enemy.lvlLessThan());
			combat.cannotRun = true;
			combat.challenge();
		}
	}
	
	function data52() {
		document.getElementById("prompt").innerHTML = "Charizard approaches you on the field. He breathes an intimidating burst of fire into the air while shouting his "+
		"name over and over.";
		buttonReset();
		setButton(0, "Continue.", fightFunc);
		function fightFunc() {
			combat.active = true;
			combat.opponent = enemy.create(enemy.charizard(), enemy.lvlLessThan());
			combat.cannotRun = true;
			combat.challenge();
		}
	}
	
	function data53() {
		document.getElementById("prompt").innerHTML = 'Obi Wan Shinobi approaches you on the field. He bows in respect to a worthy adversary. He looks up at you and '+
		'declares, "I will defeat Darth Vader and the Sith and become the next Hokage!" He bows again and says, "May the Chakra be with you."';
		buttonReset();
		setButton(0, "Continue.", fightFunc);
		function fightFunc() {
			combat.active = true;
			var e = enemy.obiWanShinobi();
			combat.opponent = enemy.create(e, enemy.lvlLessThan());
			combat.cannotRun = true;
			combat.challenge();
		}
	}
	
	function data54() {
		document.getElementById("prompt").innerHTML = 'Ganondorf approaches you on the field. He declares, "I will defeat Link and obtain all three parts of the '+
		'Triforce." He pulls out his axe and gets into a fighting stance as dark energy swirls around him.';
		buttonReset();
		setButton(0, "Continue.", fightFunc);
		function fightFunc() {
			combat.active = true;
			var e = enemy.ganondorf();
			combat.opponent = enemy.create(e, enemy.lvlLessThan());
			combat.cannotRun = true;
			combat.challenge();
		}
	}
	
	function data55() {
		document.getElementById("prompt").innerHTML = 'Link approaches you on the field. He declares, "I am on an epic quest to save my girlfriend!" He pulls out his '+
		'sword and shield and gets into his fighting stance.';
		buttonReset();
		setButton(0, "Continue.", fightFunc);
		function fightFunc() {
			combat.active = true;
			var e = enemy.link();
			combat.opponent = enemy.create(e, enemy.lvlLessThan());
			combat.cannotRun = true;
			combat.challenge();
		}
	}
	
	function data56() {
		document.getElementById("prompt").innerHTML = 'Tanjiro approaches you on the field. He declares, "Is Ganondorf a demon? I must kill all demons and turn my '+
		'sister Nezuko back into a human!" He swirls his sword around with his water magic swirling about.';
		buttonReset();
		setButton(0, "Continue.", fightFunc);
		function fightFunc() {
			combat.active = true;
			combat.opponent = enemy.create(enemy.tanjiro(), enemy.lvlRange());
			combat.cannotRun = true;
			combat.challenge();
		}
	}
	
	function data57() {
		document.getElementById("prompt").innerHTML = 'Ulfric Stormcloak approaches you on the field. He declares, "Skyrim is for the Nords!"';
		buttonReset();
		setButton(0, "Continue.", fightFunc);
		function fightFunc() {
			combat.active = true;
			combat.opponent = enemy.create(enemy.ulfricStormcloak(), enemy.lvlLessThan());
			combat.cannotRun = true;
			combat.challenge();
		}
	}
	
	function data58() {
		player.progress = 58;
		combat.opponent = 0;
		var count = 4;
		if (tournament.tier === 1) {
			tournament.tierTwo();
		}
		var t1 = decompress();
		var t2 = decompress();
		var t3 = decompress();
		var t4 = decompress();
		var oppName;
		var oppNum;
		for (i=0; i<4; i+=2) {
			if (tournament.order[i+1] === 7) {
				oppName = tournament.names[tournament.order[i]];
				oppNum = i;
			} else if (tournament.order[i] === 7) {
				oppName = tournament.names[tournament.order[i+1]];
				oppNum = i+1;
			}
		}
		document.getElementById("prompt").innerHTML = "The king's steward steps forward again and says, "+'"The first tier of the tournament is over. The victors are '+
		t1+', '+t2+', '+t3+', and '+t4+'. In the second tier of the tournament, '+t1+' shall fight '+t2+' and '+t3+' shall fight '+t4+'. Will '+player.name+' and '+
		oppName+' please take their positions on the field?' 
		buttonReset();
		setButton(0, "Take your position.", fight);
		function fight() {
			combat.victoryFunc = data59;
			tournament.fighters[tournament.order[oppNum]]()
		}
		function decompress() {
			count -= 1;
			if (tournament.names[tournament.order[count]] === 0) {
				return player.name;
			} else {
				return tournament.names[tournament.order[count]];
			}
		}
	}
	
	function data59() {
		player.progress = 59;
		if (tournament.tier === 2) {
			tournament.tierTwo();
		}
		var oppName;
		var oppNum;
		if (tournament.order[1] === 7) {
			oppName = tournament.names[tournament.order[0]];
			oppNum = 0;
		} else {
			oppName = tournament.names[tournament.order[1]];
			oppNum = 1;
		}
		document.getElementById("prompt").innerHTML = "The king's steward steps forward again and says, "+'"The second tier of the tournament is over. Our finalists '+
		'are '+player.name+' and '+oppName+'. Would you please take your positions on the field?"';
		buttonReset();
		setButton(0, "Take your position.", fight);
		function fight() {
			combat.victoryFunc = data60;
			tournament.fighters[tournament.order[oppNum]]()
		}
	}
	
	function data60() {
		player.progress = 60;
		document.getElementById("prompt").innerHTML = "The king's steward steps forward again and says, "+'"Congratulations, '+player.name+'! You are the grand '+
		'champion of the Oakloft Tournament! Please accept your prizes." He gives you 1000 gold coins and the Sword of Embers.';
		buttonReset();
		setButton(0, "Continue.", win);
		function win() {
			player.progress = 61;
			player.gold += 1000;
			quests.update(1);
			displayChar();
			addStuff(player.weapons, player.weaponsQuantity, 1, weapons.swordOfEmbers, "weapon");
			loadWeapons();
			levelUp();
		}
	}
	
	function data61() {
		player.progress = 61;
		document.getElementById("prompt").innerHTML = "You are cheered by the crowd as you leave the field. ";
		buttonReset();
		setButton(0, "Continue.", data41);
	}
	
	function data62() {
		player.progress = 62;
		document.getElementById("prompt").innerHTML = 'As you head toward the entrance, a palace guard stops you. "Hey! Where are you going? The tournament is over. '+
		'You cannot go in there. '
		buttonReset();
		setButton(0, "Okay.", data41);
	}

	function data63() {
		document.getElementById("prompt").innerHTML = 'As you are walking through the streets, a group of guards recognize you. "Hey, you! Stop right there!" one of '+
		'them calls out. "You are wanted for burglary' 
		if (player.flags[nwFlags + 52] === true || player.flags[nwFlags + 33] === true) {
			document.getElementById("prompt").innerHTML += " and murder"
		}
		document.getElementById("prompt").innerHTML += '. "'+"You're"+' coming with us."';
		buttonReset();
		setButton(0, "Go with the guard.", data64);
		setButton(1, "Run for it.", data66);
	}
	
	function data64() {
		player.progress = 64;
		document.getElementById("prompt").innerHTML = "The guards bind your hands and take you away.";
		buttonReset();
		setButton(0, "Continue.", data65);
	}
	
	function data65() {
		player.progress = 65;
		gameOver();
		document.getElementById("prompt").innerHTML = "You are in a dungeon in the Oakloft Palace. You have no idea how long it's been, but you are about to be "+
		"released. Your experience has suffered some due to the confinement.";
		player.experience -= 100;
		if (player.experience < 0) {
			player.experience = 0;
		}
		displayChar();
		buttonReset();
		setButton(0, "Continue.", data8);
	}
	
	function data66() {
		buttonReset();
		document.getElementById("prompt").innerHTML = "You try to make a break for it. The guards take off after you. ";
		if (rng(20)+combat.bonus(player.dexterity) > rng(20)+player.level) {
			document.getElementById("prompt").innerHTML += "You manage to find a good hiding spot, and the guards give up their search. "
			setButton(0, "Continue.", data[player.progress]);
		} else {
			document.getElementById("prompt").innerHTML += "You hide for a while. As you emerge from your hiding spot, one of the guards comes out of nowhere with his "+
			"weapon drawn. There's no getting around it; you'll have to fight him. "
			setButton(0, "Continue.", fight);
		}
		function fight() {
			combat.opponent = enemy.create(enemy.guard(), enemy.lvlLessThan())
			combat.victoryFunc = data[player.progress];
			combat.challenge()
			buttonReset();
			setButton(0, "Fight.", combat.displayAttacks)
		}
	}
	
	function data67() {
		player.progress = 67;
		document.getElementById("prompt").innerHTML = "You arrive at the front gate of the Gladiator's Arena. There are many fighters walking around. ";
		buttonReset();
		setButton(0, "Enter the arena.", fightTest);
		setButton(1, "Head back to town square.", data2);
	}
	
	function data68() {
		player.progress = 68;
		document.getElementById("prompt").innerHTML = "You go to sleep and your health and Manna are restored. You are also cured of status effects. You wake well rested";
		player.health = player.hitPoints;
		player.manna = player.mannaMax;
		player.status = [];
		player.statusRounds = [];
		combat.resetTempStat();
		buttonReset();
		setButton(0, "Continue.", data0);
	}
	
	function data69() {
		player.progress = 69;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data70() {
		player.progress = 70;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data71() {
		player.progress = 71;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data72() {
		player.progress = 72;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data73() {
		player.progress = 73;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data74() {
		player.progress = 74;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data75() {
		player.progress = 75;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data76() {
		player.progress = 76;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data77() {
		player.progress = 77;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data78() {
		player.progress = 78;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data79() {
		player.progress = 79;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
	function data80() {
		player.progress = 80;
		document.getElementById("prompt").innerHTML = "Well I'm out of ideas. ";
		buttonReset();
		setButton(0, "Cool. See ya.", data6);
	}
	
var guardDeadLoc = "";
	
function nightsWork0() {
	player.progress = nwOffset + 0;
	document.getElementById("prompt").innerHTML = "You check the windows and doors. Soon you find a chest-level window that isn't barred. You notice that the window "+
	"is unlocked and you open the window slowly and climb in."
	player.flags[nwFlags + 32] = true;
	combat.opponent = enemy.create(enemy.guard(), enemy.lvlLessThan())
	buttonReset();
	setButton(0, "Continue.", nightsWork1);
}

function nightsWork1() {
	if (player.flags[nwFlags + 33] === false) {
		if (rng(20)+combat.bonus(player.dexterity) > 15) {
			nightsWork128();
		} else {nightsWork102();}
	} else {nightsWork128();}
}

function nightsWork2() {
	player.progress = nwOffset + 2;
	var weaponName;
	document.getElementById("prompt").innerHTML = "You realize that it would be a good idea to cut the bell-rope. "
	buttonReset();
	if (hasSlashing() === true) {
		setButton(0, "Cut the rope.", cut);					//check weapons for slashing damage
		setButton(1, "Don't cut the rope.", dontCut);
	} else {
		document.getElementById("prompt").innerHTML += "Unfortunately, you have nothing to cut it with. ";
		setButton(0, "Continue.", nightsWork110);
		player.flags[nwFlags + 46] = true;
	}
	function dontCut() {
		player.flags[nwFlags + 46] = true;
		nightsWork110();
	}
	function hasSlashing() {
		if (player.weapons[player.weaponEquipped].dmgType === "slashing") {
			weaponName = player.weapons[player.weaponEquipped].name;
			return true;
		} else {
			for (i=0; i<player.weapons.length; i+=1) {
				if (player.weapons[i].dmgType === "slashing") {
					weaponName = player.weapons[i].name;
					return true;
				}
			}
		}
	}
	function cut() {
		document.getElementById("prompt").innerHTML = "You try to cut the rope with your "+weaponName+". ";
		buttonReset();
		setButton(0, "Continue.", nightsWork6);
	}
}

function nightsWork3() {
	player.progress = nwOffset + 3;
	document.getElementById("prompt").innerHTML = "You light the candle from the embers."
	buttonReset();
	if (player.flags[nwFlags + 1] === false) {
		document.getElementById("prompt").innerHTML = "You light the candle from the embers."
		setButton(0, "Take candle and candlestick.", take);
		setButton(1, "Go back.", nightsWork128);
		player.flags[nwFlags + 1] = true;
	} else {
		document.getElementById("prompt").innerHTML = "There is a candle burning in the room."
		setButton(0, "Take candle and candlestick.", take)
		setButton(1, "Go back.", nightsWork128)
	}
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.candleStick) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The candlestick was added to your inventory. "
			buttonReset();
			setButton(0, "Go back.", nightsWork128);
			addStuff(player.items, player.itemsQuantity, 1, items.candleStick, "item");
			player.flags[nwFlags + 2] = true;
			loadInventory();
		}
	}
}

function nightsWork4() {
	player.progress = nwOffset + 4;
	document.getElementById("prompt").innerHTML = "The guard laughs, he puts his blade to your throat and backs you into the living room. He frisks you and takes "+
	"everything of value, including your own possessions! Then he escorts you out the front door. "
	setButton(0, "Continue.", data21);
	player.items = [];
	player.itemsQuantity = [];
	player.weapons = [];
	player.weaponsQuantity = [];
	player.weaponEquipped = 0;
	player.armor = [];
	player.armorQuantity = [];
	player.armorIsEquipped = [];
	player.armorTypeEquipped = [];
	player.gold = 0;
}

function nightsWork5() {
	player.progress = nwOffset + 5;
	document.getElementById("prompt").innerHTML = "You notice that a plank in the pantry floor seems out of place. You move a barrel to investigate, and find a trap "+
	"door built into the floor! You open the trap door and find it leads to a staircase.";
	buttonReset();
	player.flags[nwFlags + 38] = true;
	setButton(0, "Go downstairs.", nightsWork71)
	setButton(1, "Look around some more.", nightsWork111)
}		

function nightsWork6() {
	player.progress = nwOffset + 6;
	document.getElementById("prompt").innerHTML = "Carefully, you reach for the bell-pull, gathering part of it in a loop in the hope of cutting it without "+
	"accidentally pulling it. ";
	setButton(0, "Continue.", check);
	function check() {
		if (rng(20)+combat.bonus(player.dexterity) > 15) {
			nightsWork55();
		}else {nightsWork139();}
	}
}

function nightsWork7() {
	player.progress = nwOffset + 7;
	document.getElementById("prompt").innerHTML = "Fatso is more interested in saving his life than hanging on to his money. He reaches under his mattress "+
	"and pulls out a bag. It is small but jingles very nicely! You don't have time to find out what's in the bag right now"
	if (player.flags[nwFlags + 33] === false) {
		document.getElementById("prompt").innerHTML += "; someone is coming up the stairs";
	}
	document.getElementById("prompt").innerHTML += ". What do you want to do?"
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 34] === false) {
		setButton(b, "Take the bag.", take);
		b += 1;
	}
	if (player.flags[nwFlags + 33] === false) {
		setButton(b, "Pull the bell-rope.", nightsWork78);
		setButton(b+1, "Wait to see who enters the bedroom.", nightsWork49);
	} else {
		setButton(b, "Run out of the room.", home);
		setButton(b+1, "Kill Fatso.", kill);
	}
	function home() {
		document.getElementById("prompt").innerHTML = "You push Fatso down and try to run. "
		player.flags[nwFlags + 55] = true;
		buttonReset();
		if (player.flags[nwFlags + 33] === false) {
			setButton(0, "Continue.", guard);
		} else {
			document.getElementById("prompt").innerHTML += "You manage to get to the kitchen. You hear Fatso blows a whistle to signal the City Guard. "
			player.flags[nwFlags + 57] = true;
			buttonReset();
			setButton(0, "Continue.", nightsWork128)
		}
	}
	function guard() {
		if (rng(20)+combat.bonus(player.dexterity) > 12) {
			document.getElementById("prompt").innerHTML += "You manage to get past the guard and make it to the kitchen. Fatso blows a whistle to signal the City Guard. "
			player.flags[nwFlags + 53] = true;
			player.flags[nwFlags + 57] = true;
			buttonReset();
			setButton(0, "Continue.", nightsWork23)
		} else {
			document.getElementById("prompt").innerHTML += "The guard stops you at the door to the bedroom. Fatso blows a whistle to signal the City Guard. "
			player.flags[nwFlags + 57] = true;
			buttonReset();
			setButton(0, "Continue.", nightsWork63)
		}
	}
	function kill() {
		document.getElementById("prompt").innerHTML = "You slit Fatso's throat, and he falls to the ground, gasping for air. "
		player.flags[nwFlags + 52] = true;
		player.flags[nwFlags + 55] = false;
		buttonReset();
		setButton(0, "Continue.", nightsWork110);
	}
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.fatsosPurse) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The bag was added to your inventory. "
			player.flags[nwFlags + 34] = true;
			buttonReset();
			setButton(0, "Continue.", nightsWork7);
			addStuff(player.items, player.itemsQuantity, 1, items.fatsosPurse, "item");
			loadInventory();
		}
	}
}

function nightsWork8() {
	player.progress = nwOffset + 8;
	document.getElementById("prompt").innerHTML = "The key you took from around Fatso's neck works like a charm!";
	buttonReset();
	setButton(0, "Continue.", nightsWork97)
}

function nightsWork9() {
	player.progress = nwOffset + 9;
	document.getElementById("prompt").innerHTML = "You weren't fast enough. The spider bites you painfully. Your hand becomes swollen and tender.";
	player.health -= rng(5);
	player.flags[nwFlags + 10] = true;
	if (player.health < 1) {
		setButton(0, "Continue.", gameOver)
	}
	buttonReset();
	setButton(0, "Look at the jar.", nightsWork118)
	setButton(1, "Look at something else.", nightsWork68)
}

function nightsWork10() {
	player.progress = nwOffset + 10;
	document.getElementById("prompt").innerHTML = "You are in the guard's bedroom, with the guard hot on your heels. You don't have time to look around. This room "+
	"opens out into the great hall.";
	buttonReset();
	setButton(0, "Continue.", nightsWork157)
}

function nightsWork11() {
	player.progress = nwOffset + 11;
	document.getElementById("prompt").innerHTML = "Your clumsy blow merely awakens the gaint"
	if (player.flags[nwFlags + 31] === false) {
		document.getElementById("prompt").innerHTML += ", who snatches his scimitar and rolls to his side"
	}
	document.getElementById("prompt").innerHTML += ". In your surprise, you let him reach his feet. ";
	buttonReset();
	setButton(0, "Continue.", fight)
	function fight() {
		player.progress = nwOffset + 149;
		nightsWork76();
		guardDeadLoc = "kitchen"
	}
}

function nightsWork12() {
	player.progress = nwOffset + 12;
	document.getElementById("prompt").innerHTML = "As far as you can tell, these casks of ale are sitting here to age, and that's all there is to it. ";
	buttonReset();
	setButton(0, "Continue.", nightsWork16)
}

function nightsWork13() {
	player.progress = nwOffset + 13;
	document.getElementById("prompt").innerHTML = "This jar is full of some kind of red powder. ";
	buttonReset();
	setButton(0, "Taste it to identify it.", check)
	setButton(1, "Put it back.", nightsWork68)
	function check() {
		if (player.flags[nwFlags + 12] === false) {
			player.flags[nwFlags + 12] = true;
			if (rng(20)+combat.bonus(player.iq) > 12) {
				player.flags[nwFlags + 13] = true;
			}
			check();
		} else {
			if (player.flags[nwFlags + 13] === true) {
				nightsWork29();
			} else {
				nightsWork137();
			}
		}
	}
}

function nightsWork14() {
	player.progress = nwOffset + 14;
	document.getElementById("prompt").innerHTML = "You start back up the stairs to the pantry.";
	buttonReset();
	setButton(0, "Continue.", check);
	function check() {
		if (player.flags[nwFlags + 33] === false) {
			nightsWork159();
		} else {
			if (rng(20)+combat.bonus(player.dexterity) > 12) {
				nightsWork159();
			} else {nightsWork117();}
		}
	}
}

function nightsWork15() {
	player.progress = nwOffset + 15;
	document.getElementById("prompt").innerHTML = "This is your conscience speaking. You're a thief, not a murderer. Do you really want to do this? Even if you're "+
	"willing to kill someone in cold blood, remember that the City Guard, and even the Thieves' Guild itself, will pay more attention to murder than to an ordinary theft. ";
	buttonReset();
	setButton(0, "Kill the giant.", nightsWork21)
	setButton(1, "Knock him out instead.", nightsWork83)
	setButton(2, "Don't attack him.", nightsWork149)
}

function nightsWork16() {
	player.progress = nwOffset + 16;
	document.getElementById("prompt").innerHTML = "You are in the storage room underneath the pantry. A rack along one wall is filled with bottles of wine. There "+
	"are perhaps two dozen casks stacked along another wall. A third wall holds a collection of random junk. ";
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 16] === false) {
		setButton(b, "Drink the wine.", check);
		setButton(b+1, "Examine the wine rack.", nightsWork125)
		b += 2;
	}
	setButton(b, "Examine the casks.", nightsWork94)
	setButton(b+1, "Examine the junk on wall.", nightsWork154)
	setButton(b+2, "Leave the room.", nightsWork14)
	function check() {
		if (rng(20)+combat.bonus(player.dexterity) > 12) {
			nightsWork116();
		} else {
			document.getElementById("prompt").innerHTML = "You drank the wine and nothing happened. What do you want to do?";
			buttonReset();
			setButton(0, "Drink more wine.", check);
			setButton(1, "Go back.", nightsWork16);
		}
		player.flags[nwFlags + 16] = true;
	}
}

function nightsWork17() {
	player.progress = nwOffset + 17;
	document.getElementById("prompt").innerHTML = "Well, the statuettes seemed worthless, but you look at one, just in case - and it turns out to be hollow! Inside "+
	"is an amulet on a chain. The amulet and chain look like they're solid gold - they weigh little, but are finely made. You may take them if you wish.";
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 45] === false) {
		setButton(0, "Take amulet. ", take)
		b += 1;
	}
	if (player.flags[nwFlags + 52] === true) {
		setButton(b, "Investigate Fatso's corpse.", nightsWork52)
		b += 1;
	} else {
		if (player.flags[nwFlags + 55] === false) {
			setButton(b, "Investigate Fatso.", nightsWork52)
			b += 1;
		}	
	}	
	setButton(b, "Go back downstairs.", nightsWork111)
	function take() {
		if (checkQuantityFull(player.armor, player.armorQuantity, armor.amuletOfThunder) === true) {
			return dropStuff(player.armor, player.armorQuantity, "armor");
		} else {
			document.getElementById("prompt").innerHTML = "The amulet was added to your inventory. "
			buttonReset();
			setButton(0, "Continue.", nightsWork17);
			addStuff(player.armor, player.armorQuantity, 1, armor.amuletOfThunder, "armor");
			player.flags[nwFlags + 45] = true;
			loadArmor();
		}
	}
}

function nightsWork18() {
	player.progress = nwOffset + 18;
	document.getElementById("prompt").innerHTML = "You are at the top of the flight of stairs. There is only one door here, right at the top of the stairs.";
	buttonReset();
	setButton(0, "Check out door.", nightsWork64)
	setButton(1, "Go back downstairs.", nightsWork111)
}

function nightsWork19() {
	player.progress = nwOffset + 19;
	document.getElementById("prompt").innerHTML = "You break the seal and open the bag - and smoke pours out. Lots of smoke! Frantically, you try and close it, but "+
	"it's to late. The smoke solidifies and reaches for you.";
	window.alert("GAME OVER!!!");
	nightsWork0();
}

function nightsWork20() {
	player.progress = nwOffset + 20;
	document.getElementById("prompt").innerHTML = "You look around for a few minutes, and give one or two of the statues a test-heft, but you don't find anything "+
	"that looks both valuable and portable. "
	if (player.flags[nwFlags + 52] === false && player.flags[nwFlags + 55] === false) {
		document.getElementById("prompt").innerHTML += "As you search, you hear the fat man groan and mutter. You freeze - and he soon is snoring again.";
	}
	buttonReset();
	setButton(0, "Take time to search.", nightsWork43)
	setButton(1, "Leave the room.", nightsWork18)
}

function nightsWork21() {
	if (rng(20)+combat.bonus(player.dexterity) > 5) {
			nightsWork134();
		} else {nightsWork11();}
}

function nightsWork22() {
	player.progress = nwOffset + 22;
	document.getElementById("prompt").innerHTML = "You turn and run, hoping to dodge past the huge guard.";
	buttonReset();
	setButton(0, "Continue.", check)
	function check() {
		if (rng(20)+combat.bonus(player.dexterity) > 15) {
			nightsWork63();
		} else {nightsWork50();}
	}
}

function nightsWork23() {
	player.progress = nwOffset + 23;
	document.getElementById("prompt").innerHTML = "You are in the kitchen, with the guard chasing you. What do you do?";
	player.flags[nwFlags + 53] = true;
	buttonReset();
	setButton(0, "Run into the pantry.", nightsWork58)
	setButton(1, "Dive through the window.", nightsWork113)
	setButton(2, "Fight.", fight)
	function fight() {
		player.progress = nwOffset + 128;
		nightsWork76();
		guardDeadLoc = "kitchen"
	}
}

function nightsWork24() {
	player.progress = nwOffset + 24;
	document.getElementById("prompt").innerHTML = "You can't stifle a sharp cry as you feel the unexpected pain. " 
	buttonReset();
	if (player.flags[nwFlags + 33] === false) {
		document.getElementById("prompt").innerHTML += "As you cry out, you hear footsteps in one of the other rooms. ";
		setButton(0, "Continue.", nightsWork58)
	} else {
		setButton(0, "Continue.", nightsWork114)
	}
}

function nightsWork25() {
	player.progress = nwOffset + 25;
	document.getElementById("prompt").innerHTML = "The footsteps are coming closer - but you have the advantage. You will be able to surprise whoever is coming. "+
	"Then you see him - a huge guard "
	if (player.flags[nwFlags + 31] === false) {
		document.getElementById("prompt").innerHTML += "with a scimitar, "
	}
	document.getElementById("prompt").innerHTML += "filling the doorway!";
	buttonReset();
	setButton(0, "Fight him. ", fight)
	setButton(1, "Talk your way out. ", nightsWork156)
	function fight() {
		player.progress = nwOffset + 128;
		nightsWork76();
		guardDeadLoc = "kitchen"
	}
}

function nightsWork26() {
	player.progress = nwOffset + 26;
	document.getElementById("prompt").innerHTML = "You open the lid to find an oily white cream inside.";
	buttonReset();
	setButton(0, "See what it does.", nightsWork114)
	setButton(1, "Go back.", nightsWork68)
}

function nightsWork27() {
	player.progress = nwOffset + 27;
	document.getElementById("prompt").innerHTML = "You decide that this adventure was not worth coming out for tonight and head back to town.";
	player.flags[nwFlags + 32] = false;
	buttonReset();
	setButton(0, "Continue.", data0)
	if (player.questProgress[quests.find(0)] === 2) {
		quests.update(0);
	}
}

function nightsWork28() {
	if (Math.ceil(Math.random()*6) < 5) {
		nightsWork17();
	} else {nightsWork163();}
}

function nightsWork29() {
	player.progress = nwOffset + 29;
	document.getElementById("prompt").innerHTML = "It's good that you didn't taste very much of this. It's cayenne pepper! Pepper is rare and valuable!";
	player.flags[nwFlags + 12] = true;
	buttonReset();
	setButton(0, "Take the jar.", take)
	setButton(1, "Leave the jar.", nightsWork68)
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.cayenne) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The cayenne pepper was added to your inventory. "
			buttonReset();
			setButton(0, "Continue.", nightsWork68)
			addStuff(player.items, player.itemsQuantity, 1, items.cayenne, "item") 																								//add cayenne pepper
			player.flags[nwFlags + 6] = true;
			loadInventory();
		}
	}
}

function nightsWork30() {
	if (checkQuantityFull(player.weapons, player.weaponsQuantity, weapons.scimitar) === true) {
		return dropStuff(player.weapons, player.weaponsQuantity, "weapon");
	} else {
		player.progress = nwOffset + 30;
		document.getElementById("prompt").innerHTML = "You take the scimitar on the ground and put it in your weapons. What do you do next?";
		if (player.flags[nwFlags + 31] === false) {
			addStuff(player.weapons, player.weaponsQuantity, 1, weapons.scimitar, "weapon");
		}
		player.flags[nwFlags + 31] = true;
		loadWeapons();
		buttonReset();
		setButton(0, "Search the room further.", nightsWork155)
		setButton(1, "Attack the guard.", nightsWork160)
		setButton(2, "Leave the room.", nightsWork59)
	}
}

function nightsWork31() {
	player.progress = nwOffset + 31;
	document.getElementById("prompt").innerHTML = "A critical failure! You have fumbled badly. The trap door was in two parts - and you were standing on one "+
	"part while you fooled with the other one. The door opens with a CREEEEK, and drops you through the floor.";
	buttonReset();
	setButton(0, "Continue.", nightsWork139)
}

function nightsWork32() {
	player.progress = nwOffset + 32;
	buttonReset();
	if (rng(20)+combat.bonus(player.iq) > 12) {
		document.getElementById("prompt").innerHTML = "You have a brilliant idea!! ";
		setButton(0, "Continue.", nightsWork127);
	} else {
		document.getElementById("prompt").innerHTML = "You're out of ideas. ";
		setButton(0, "Continue.", nightsWork67);
	}
}

function nightsWork33() {
	player.progress = nwOffset + 33;
	document.getElementById("prompt").innerHTML = "You make it out the window just in time! You hear footsteps behind you, and see a man looking out the window. "+
	"He doesn't see you, so he latches the window.";
	buttonReset();
	setButton(0, "Try again in a half-hour.", nightsWork153)
	setButton(1, "Give up.", nightsWork27)
}

function nightsWork34() {
	player.progress = nwOffset + 34;
	document.getElementById("prompt").innerHTML = "This is some very powerful burn ointment. I'll give you 200 gold coins for it.";
	buttonReset();
	setButton(0, "Deal.", deal)
	setButton(1, "Nevermind.", data22)
	function deal() {
		player.gold += 200;
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.burnOintment), "item");
		loadInventory();
		displayChar();
		data22();
	}
}

function nightsWork35() {
player.progress = nwOffset + 165;
	document.getElementById("prompt").innerHTML = "This wine is very sought after. I'll pay you 150 gold coins for it. "
	buttonReset();
	setButton(0, "Deal.", deal)
	setButton(1, "Nevermind.", data22)
	function deal() {
		player.gold += 150;
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.rareWine), "item");
		loadInventory();
		displayChar();
		data22();
	}
}

function nightsWork36() {
	player.progress = nwOffset + 36;
	document.getElementById("prompt").innerHTML = "The tapestry is easy to remove from the wall. As you get ready to roll it up you notice an unusual mark on "+
	"the lower right-hand corner.";
	buttonReset();
	setButton(0, "Continue.", check);
	function check() {
		if (player.flags[nwFlags + 28] === false) {
			if (rng(20)+combat.bonus(player.iq) > 12) {
				player.flags[nwFlags + 29] = true;
				nightsWork120();
			} else {
				player.flags[nwFlags + 29] = false;
				nightsWork41();
			}
			player.flags[nwFlags + 28] = true;
		} else {
			if (player.flags[nwFlags + 29] === true) {
				nightsWork120();
			} else {nightsWork41();}
		}
	}			
}

function nightsWork37() {
	player.progress = nwOffset + 37;
	document.getElementById("prompt").innerHTML = "As you reach for the jar you notice some movement behind it. It's a huge, hairy spider, and it's right next "+
	"to your hand!";
	buttonReset();
	setButton(0, "Shoo it away.", check);
	function check() {
		var roll = Math.random();
		if (roll < 0.5) {
			nightsWork54();
		} else {nightsWork173();}
	}
}

function nightsWork38() {
	if (checkQuantityFull(player.items, player.itemsQuantity, items.goldKey) === true) {
		return dropStuff(player.items, player.itemsQuantity, "item");
	} else {
		player.progress = nwOffset + 38;
		document.getElementById("prompt").innerHTML = "You cut the cord and carefully slide it out from under the fat man's neck. Now you have a key. What does it "+
		"unlock? Nothing in here. You've already checked everything and have not seen a keyhole. The key is far too small for the door locks, it looks like it opens "+
		"a chest or drawer. Fatso rolls and mutters in his sleep again.";
		addStuff(player.items, player.itemsQuantity, 1, items.goldKey, "item")
		loadInventory();
		player.flags[nwFlags + 44] = true;
		buttonReset();
		setButton(0, "Search the room further.", nightsWork53)
		setButton(1, "Leave the room.", nightsWork18)
	}
}

function nightsWork39() {
	player.progress = nwOffset + 39;
	document.getElementById("prompt").innerHTML = "After looking at the trap door and pushing on it once or twice, you realize that the bell-rope over Fatso's bed "+
	"is the triggering mechanism.";
	buttonReset();
	setButton(0, "Examine the device further.", nightsWork136)
	setButton(1, "Pull bell-rope.", nightsWork139)
	setButton(2, "Cut the rope.", nightsWork6)
}

function nightsWork40() {
	player.progress = nwOffset + 40;
	document.getElementById("prompt").innerHTML = "The lid clatters, bangs, and resets itself on top of the pot. Now you've done it! Can you find somewhere to hide.";
	buttonReset();
	setButton(0, "Find somewhere to hide.", check);
	function check() {
		if (rng(20)+combat.bonus(player.dexterity) > 12) {
			nightsWork100();
		} else {nightsWork93();}
	}			
}

function nightsWork41() {
	player.progress = nwOffset + 41;
	document.getElementById("prompt").innerHTML = "It comes down easliy and you roll it up. ";
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 30] === false) {
		setButton(b, "Take tapestry", take);
		b += 1;
	}
	setButton(b, "Go back.", nightsWork171);
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.tapestry) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The tapestry was added to your inventory.";
			addStuff(player.items, player.itemsQuantity, 1, items.tapestry, "item");
			loadInventory();
			player.flags[nwFlags + 30] = true;
			buttonReset();
			setButton(0, "Continue.", nightsWork171);
		}
	}
}

var spices = {
	common: 12,
	modRare: 20,
	rare: 4
}

function nightsWork42() {
	player.progress = nwOffset + 42;
	document.getElementById("prompt").innerHTML = "What would you like to do?";
	if (spices.common === 0 && spices.modRare === 0 && spices.rare === 0) {
		player.flags[nwFlags + 5] = true;
	}
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 5] === false) {
		setButton(b, "Take some labeled jars.", select);
		b += 1;
	}
	setButton(b, "Check the five unlabeled jars.", nightsWork68);
	setButton(b+1, "Look around in the pantry.", nightsWork176);
	function select() {
		document.getElementById("prompt").innerHTML = "There are "+spices.common+" jars of common herbs, "+spices.modRare+" jars of moderately rare herbs, and "+
		spices.rare+" jars of very rare spices left. Which jars would you like to take?";
		buttonReset();
		var b = 0;
		if (spices.common > 0) {
			setButton(b, "Take some common herb jars.", takeCommon);
			b += 1;
		}
		if (spices.modRare > 0) {
			setButton(b, "Take some moderately rare herb jars.", takeModRare);
			b += 1;
		}
		if (spices.rare > 0) {
			setButton(b, "Take some very rare spice jars.", takeRare);
			b += 1;
		}
		setButton(b, "Go back.", nightsWork42)
	}
	function takeCommon() {
		var amount = take(spices.common, items.commonHerbs);
		if ((amount > 0 || amount < 0) === true) {
			spices.common -= amount;
		}
	}
	function takeModRare() {
		var amount = take(spices.modRare, items.modRareHerbs);
		if ((amount > 0 || amount < 0) === true) {
			spices.modRare -= amount;
		}
	}
	function takeRare() {
		var amount = take(spices.rare, items.rareHerbs);
		if ((amount > 0 || amount < 0) === true) {
			spices.rare -= amount;
		}
	}
	function take(type, itemObj) {
		var quantity = window.prompt("How many jars would you like to take?")
		quantity = parseInt(quantity);
		if ((quantity > 0 || quantity < 0) === false) {
			nightsWork42();
		} else if (checkQuantityFull(player.items, player.itemsQuantity, itemObj) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			if (quantity > type) {
				quantity = type;
			}
			addStuff(player.items, player.itemsQuantity, quantity, itemObj, "item");
			document.getElementById("prompt").innerHTML = quantity+" jars were added to your inventory.";
			loadInventory();
			buttonReset();
			setButton(0, "Go back.", nightsWork42)
			loadInventory();
			return quantity;
		}
	}
}

function nightsWork43() {
	player.progress = nwOffset + 43;
	if (rng(20)+combat.bonus(player.iq) > 12) {
		nightsWork28();
	} else {
		document.getElementById("prompt").innerHTML = "You didn't find anything. You decide there is nothing of value here.";
		buttonReset();
		var b = 0;
		if (player.flags[nwFlags + 52] === true) {
			setButton(b, "Look at Fatso's corpse.", nightsWork52)
			b += 1;
		} else if (player.flags[nwFlags + 55] === false) {
			setButton(b, "Look at Fatso.", nightsWork52)
			b += 1;
		}
		
		setButton(b, "Leave the room.", nightsWork18)
	}
}

function nightsWork44() {
	player.progress = nwOffset + 44;
	document.getElementById("prompt").innerHTML = "The casks come sliding right at you! ";
	buttonReset();
	if (rng(20)+combat.bonus(player.dexterity) > 12) {
		document.getElementById("prompt").innerHTML += "You manage to spring out of the way and up the stairs, but the casks make a LOT of noise.";
		setButton(0, "Continue.", nightsWork117)
	} else {	
		document.getElementById("prompt").innerHTML += "You cannot get out of the way in time.";
		setButton(0, "Continue.", gameOver)	
	}
}

function nightsWork45() {															//player.dexterity and player.iq are -3.
	player.progress = nwOffset + 45;
	document.getElementById("prompt").innerHTML = "The is pretty good wine, but it takes its toll.";
	combat.boostTempStat(0, -3, 5, 1);
	combat.boostTempStat(0, -3, 5, 2);
	buttonReset();
	setButton(0, "Continue.", nightsWork16);
	player.flags[nwFlags + 16] = true;
}

function nightsWork46() {
	player.progress = nwOffset + 46;
	var count = 3;
	buttonReset();
	if (player.flags[nwFlags + 35] === true && player.flags[nwFlags + 36] === true && player.flags[nwFlags + 37] === true) {
		document.getElementById("prompt").innerHTML = "You have already cut open all the pillows that were here. ";
		setButton(0, "Go back.", nightsWork171);
	} else {
		var b = 0;
		if (player.flags[nwFlags + 35] === false) {
			setButton(b, "Cut open red pillow.", nightsWork130);
			b += 1;
		} else {count -= 1;}
		if (player.flags[nwFlags + 36] === false) {
			setButton(b, "Cut open yellow pillow.", nightsWork106);
			b += 1;
		} else {count -= 1;}
		if (player.flags[nwFlags + 37] === false) {
			setButton(b, "Cut open blue pillow.", nightsWork87);
			b += 1;
		} else {count -= 1;}
		setButton(b, "Go back.", nightsWork171)
		if (count !== 1) {
			count += " pillows";
		} else {
			count += " pillow";
		}
		document.getElementById("prompt").innerHTML = "You see "+count+" in the great hall and decide to slit one open.";
	}
}

function nightsWork47() {
	player.progress = nwOffset + 47;
	document.getElementById("prompt").innerHTML = "The porcelain tea set is very beautiful - and very fragile. The artist's markings on the bottom of the teapot show "+
	"it to be at least 120 years old. It should be worth a lot of money - IF you can get it to the fence intact.";
	buttonReset();
	if (player.flags[nwFlags + 24] === false) {
		if (rng(20)+combat.bonus(player.iq) > 15) {
			player.flags[nwFlags + 25] = true;
		} else {
			player.flags[nwFlags + 25] = false;
		}
		player.flags[nwFlags + 24] = true;
	}
	if (player.flags[nwFlags + 25] === false) {
		var b = 0;
		if (player.flags[nwFlags + 22] === false) {
			setButton(b, "Take the tea set.", take)
			b += 1;
		}
		if (player.flags[nwFlags + 23] === false) {
			setButton(b, "Take the spoons.", spoons)
			b += 1;
		}
		if (player.flags[nwFlags + 21] === false) {
			setButton(b, "Examine the hookahs.", nightsWork66)
			b += 1;
		}
		setButton(b, "Look elsewhere in the room.", nightsWork171)
	} else {
		setButton(0, "Continue.", nightsWork73);
	}
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.teaService) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The tea set was added to your inventory. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork129);
			addStuff(player.items, player.itemsQuantity, 1, items.teaService, "item");
			loadInventory();
			player.flags[nwFlags + 22] = true;
			player.flags[nwFlags + 56] = false;
		}
	}
	function spoons() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.spoon) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The spoons were added to your inventory. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork129);
			player.flags[nwFlags + 23] = true;
			addStuff(player.items, player.itemsQuantity, 4, items.spoon, "item")
			loadInventory();
		}
	}
}

function nightsWork48() {
	player.progress = nwOffset + 48;
	document.getElementById("prompt").innerHTML = "You listen for several minutes, but you don't hear anything. You seem to have picked a house full of heavy sleepers.";
	buttonReset();
	setButton(0, "Continue.", nightsWork128)
}

function nightsWork49() {
	player.progress = nwOffset + 49;
	document.getElementById("prompt").innerHTML = "As you stand with your knife to Fatso's throat, the door opens behind you, and you turn to see a huge man filling "+
	"the doorway. He "
	if (player.flags[nwFlags + 31] === false) {
		document.getElementById("prompt").innerHTML += "is carrying a scimitar, and ";
	}
	document.getElementById("prompt").innerHTML += "looks angry. What do you do?";
	buttonReset();
	setButton(0, "Turn and knife Fatso.", nightsWork89)
	setButton(1, "Threaten Fatso.", nightsWork151)
	setButton(2, "Fight the guard.", fight)
	setButton(3, "Pull the bell-rope.", nightsWork78)
	setButton(4, "Leave the room.", nightsWork63)
	function fight() {
		player.progress = nwOffset + 110;
		nightsWork76();
		guardDeadLoc = "fatso"
	}
}

function nightsWork50() {
	player.progress = nwOffset + 50;
	document.getElementById("prompt").innerHTML = "With a desperate lunge, Fatso reaches the bell-rope. He yanks on the cord before you can run away. "+
	"Beneath you, the floor gives way, and you go sliding down into darkness.";
	buttonReset();
	setButton(0, "Continue.", nightsWork78)
}

function nightsWork51() {
	player.progress = nwOffset + 51;
	document.getElementById("prompt").innerHTML = "There are five tapestries. Four of them are huge, but the fifth looks like it might be portable.";
	buttonReset();
	setButton(0, "Pick up tapestry.", nightsWork36)
	setButton(1, "Go back.", nightsWork171)
}

function nightsWork52() {
	player.progress = nwOffset + 52;
	document.getElementById("prompt").innerHTML = "Fatso is wearing a number of rings and bracelets, but they are pressed so tightly into his flesh you wouldn't be "+
	"able to remove them without taking off his fingers - "
	if (player.flags[nwFlags + 52] === false) {
		document.getElementById("prompt").innerHTML += "which is NOT a good idea. As you check him out, he rolls over and groans loudly. You jump - but he is still asleep.";
	} else {
		document.getElementById("prompt").innerHTML += "which could get messy. It's better if you don't do that. ";
	}
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 44] === false) {
		setButton(0, "Look further.", nightsWork180)
		b += 1;
	}
	setButton(b, "Leave the room.", nightsWork18)
}

function nightsWork53() {
	player.progress = nwOffset + 53;
	document.getElementById("prompt").innerHTML = "You push your luck a little too far! The fat man awakens and does what any normal person would do if he saw someone "+
	"standing over him with a knife at his throat. He screams. Then he reaches up toward a bell-pull.";
	player.flags[nwFlags + 55] = true;
	buttonReset();
	setButton(0, "Stop him from pulling the bell-pull.", check);
	function check() {
		if (rng(20)+combat.bonus(player.strength) > 15) {
			nightsWork162();
		} else {nightsWork144();}
	}
}

function nightsWork54() {
	player.progress = nwOffset + 54;
	document.getElementById("prompt").innerHTML = "You jerk your hand away from the spider.";
	buttonReset();
	setButton(0, "Continue.", check);
	function check() {
		if (rng(20)+combat.bonus(player.dexterity) > 12) {
			nightsWork170();
		} else {nightsWork9();}
	}
}

function nightsWork55() {
	player.progress = nwOffset + 55;
	document.getElementById("prompt").innerHTML = "Gently, you saw on the rope. But your weapon seems to make little impression! The bell-rope is resisting "+
	"your blade.";
	buttonReset();
	setButton(0, "Saw harder.", nightsWork91)
	setButton(1, "Abandon cutting the rope.", nightsWork110)
}

function nightsWork56() {
	player.progress = nwOffset + 56;
	document.getElementById("prompt").innerHTML = "This door leads outside. You take a quick look - nobody is watching!";
	buttonReset();
	setButton(0, "Head back to town.", nightsWork27)
	setButton(1, "Go back inside.", nightsWork59)
}

function nightsWork57() {
	player.progress = nwOffset + 57;
	document.getElementById("prompt").innerHTML = "You don't find anything of interest in the junk pile.";
	buttonReset();
	setButton(0, "Continue.", nightsWork16)
}

function nightsWork58() {
	player.progress = nwOffset + 58;
	document.getElementById("prompt").innerHTML = "You are in the pantry. The guard is chasing you. Going up the stairs doesn't seem to be a good idea. ";
	player.flags[nwFlags + 53] = true;
	buttonReset();
	setButton(0, "Run to the great hall.", nightsWork157)
	setButton(1, "Run to the kitchen.", nightsWork23)
	setButton(2, "Fight.", fight)
	function fight() {
		player.progress = nwOffset + 159;
		nightsWork76();
		guardDeadLoc = "pantry"
	}
}

function nightsWork59() {
	player.progress = nwOffset + 59;
	document.getElementById("prompt").innerHTML = "You are in the great hall. The ceiling here is two stories tall, with vents in the eaves to let air in and out. "+
	"There are also a number of windows, all fairly high on the wall. Along one wall is a sofa with three pillows. There are expensive-looking tapestries upon "+
	"the wall. Other furnishings include a low table, a small bookcase, and a few hookahs. And finally, there are three doorways. One leads to the landing below a "+
	"staircase. Another appears to lead into a bedroom, and a third is closed - but looks solid, as though it is an exit from the house. ";
	if (player.flags[nwFlags + 33] === true && guardDeadLoc === "hall") {
		document.getElementById("prompt").innerHTML += "The guard's dead body is sprawled out on the floor. "
	}
	buttonReset();
	setButton(0, "Go to the bedroom.", nightsWork149);
	setButton(1, "Go through the solid-looking door.", nightsWork56);
	setButton(2, "Examine the room.", nightsWork171);
	setButton(3, "Go back to the landing.", nightsWork111);
}

function nightsWork60() {
	player.progress = nwOffset + 60;
	document.getElementById("prompt").innerHTML = "Your common sense prompts you to stop and think for a moment - do you really want to destroy those valuable pillows "+
	"on the chance that something might be inside them?";
	buttonReset();
	setButton(0, "Cut them open anyway.", nightsWork46);
	setButton(1, "Go back.", nightsWork124);
}

function nightsWork61() {
	player.progress = nwOffset + 61;
	document.getElementById("prompt").innerHTML = "You were sure there was a trap here, and you were right. At the first sound of sliding casks, you're out of there "+
	"and up the stairs. The casks smash into the place where you were crouching, making a terrible noise. "
	buttonReset();
	var hasCandle = checkForStuff(player.items, items.candleStick);
	if (player.flags[nwFlags + 33] === false) {
		setButton(0, "Continue.", nightsWork117)
	} else {
		if (hasCandle !== false) {
			setButton(0, "Continue.", nightsWork16)
		} else {
			setButton(0, "Grope around in the cellar.", nightsWork143)	
		}
		setButton(1, "Go back up the stairs.", nightsWork14)
	}
}

function nightsWork62() {
	player.progress = nwOffset + 62;
	document.getElementById("prompt").innerHTML = "Most of these papers are worthless. But these bawdy limericks are a manuscript written in the hand of a famous "+
	"poet, a favorite of mine who died some 250 years ago. Some of these I never even heard! he says. I'll give you 100 gold pieces for them. "
	buttonReset();
	setButton(0, "Deal.", deal)
	setButton(1, "Nevermind.", data22)
	function deal() {
		player.gold += 100;
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.fatsosPapers), "item");
		loadInventory();
		displayChar();
		data22();
	}
}

function nightsWork63() {
	player.progress = nwOffset + 63;
	document.getElementById("prompt").innerHTML = "The guard fills the doorway, so you have to evade him or fight him. ";
	buttonReset();
	setButton(0, "Evade.", evade)
	setButton(1, "Fight.", fight)
	function evade() {
		buttonReset();
		if (rng(20)+combat.bonus(player.dexterity) >= rng(20)+combat.bonus(combat.opponent.dexterity)) {
			nightsWork142();
		} else {
			document.getElementById("prompt").innerHTML = "You could not get past the guard. ";
			setButton(0, "Continue.", fight);
		}
	}
	function fight() {
		player.progress = nwOffset + 110;
		nightsWork76();
		guardDeadLoc = "fatso"
	}
}

function nightsWork64() {
	player.progress = nwOffset + 64;
	document.getElementById("prompt").innerHTML = "Listening at the door, you ";
	if (player.flags[nwFlags + 52] === false && player.flags[nwFlags + 55] === false) {
		document.getElementById("prompt").innerHTML += "only hear snoring. ";
	} else {
		document.getElementById("prompt").innerHTML += "don't hear anything. ";
	}
	buttonReset();
	setButton(0, "Open the door.", nightsWork110)
	setButton(1, "Go back down the stairs.", nightsWork111)
}

function nightsWork65() {
	player.progress = nwOffset + 65;
	document.getElementById("prompt").innerHTML = "The ointment feels good. "
	if (checkForStuff(player.status, "burned") !== false) {
		document.getElementById("prompt").innerHTML += "In fact, your burn starts to heal immediately. Any penalties you had from the burn injury are totally gone. ";
		combat.removeStatus(player, "burned")
		displayChar();
	}
	buttonReset();
	setButton(0, "Continue.", nightsWork114)
}

function nightsWork66() {
	player.progress = nwOffset + 66;
	document.getElementById("prompt").innerHTML = "The hookahs have been heavily used. They are tarnished on the outside and have a heavy buildup of residue inside.";
	buttonReset();
	setButton(0, "Take the hookahs.", take)
	setButton(1, "Appraise the hookahs.", appraise)
	setButton(2, "Leave the hookahs.", nightsWork129)
	function appraise() {
		if (player.flags[nwFlags + 19] === false) {
			if (rng(20)+combat.bonus(player.iq) > 12) {
				player.flags[nwFlags + 20] = true;
				nightsWork145();
			} else {
				player.flags[nwFlags + 20] = false;
				document.getElementById("prompt").innerHTML = "You cannot quite tell what the hookahs are worth. ";
				buttonReset();
				setButton(0, "Continue.", nightsWork66)
			}
		} else {
			if (player.flags[nwFlags + 20] === true) {
				nightsWork145();
			} else {
				document.getElementById("prompt").innerHTML = "You cannot quite tell what the hookahs are worth. ";
				buttonReset();
				setButton(0, "Continue.", nightsWork66)
			}
		}
		player.flags[nwFlags + 19] = true;
	}
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.hookah) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The hookahs were added to your inventory. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork129);
			addStuff(player.items, player.itemsQuantity, 3, items.hookah, "item");
			player.flags[nwFlags + 21] = true;
			loadInventory();
		}
	}
}

function nightsWork67() {
	player.progress = nwOffset + 67;
	document.getElementById("prompt").innerHTML = "AH-CHOO! You manage to recover from your sneezing fit - just as a huge man comes in"
	if (player.flags[nwFlags + 31] === false) {
		document.getElementById("prompt").innerHTML += " holding a scimitar"
	}
	document.getElementById("prompt").innerHTML += ". What do you do?";
	buttonReset();
	setButton(0, "Stand and fight.", fight)
	setButton(1, "Retreat to kitchen.", nightsWork23)
	setButton(2, "Push past him.", evade)
	if (player.flags[nwFlags + 51] === false) {
		setButton(3, "Come up with a plan.", plan)
	}
	function plan() {
		nightsWork32()
		player.flags[nwFlags + 51] = true;
	}
	function fight() {
		player.progress = nwOffset + 159;
		nightsWork76();
		guardDeadLoc = "pantry"
	}
	function evade() {
		if (rng(20)+combat.bonus(player.iq) >= 15) {
			nightsWork81();
		} else {
			document.getElementById("prompt").innerHTML = "You could not get past him.";
			buttonReset();
			setButton(0, "Continue.", fight)
		}
	}
}

function nightsWork68() {
	player.progress = nwOffset + 68;
	document.getElementById("prompt").innerHTML = "Which jars would you like to examine?";
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 6] === false) {
		if (player.flags[nwFlags + 12] === true) {
			setButton(b, "Jar 1", identified);
		} else {
			setButton(b, "Jar 1", nightsWork13);
		}
		b += 1;
	}
	if (player.flags[nwFlags + 7] === false) {
		setButton(b, "Jar 2", nightsWork182);
		b += 1;
	}
	if (player.flags[nwFlags + 8] === false) {
		setButton(b, "Jar 3", nightsWork77);
		b += 1;
	}
	if (player.flags[nwFlags + 9] === false) {
		if (player.flags[nwFlags + 10] === false) {						//spider shooed away
			setButton(b, "Jar 4", nightsWork37);
		} else {
			setButton(b, "Jar 4", nightsWork118);
		}
		b += 1;
	}
	if (player.flags[nwFlags + 11] === false) {
		setButton(b, "Jar 5", nightsWork140);
		b += 1;
	}
	setButton(b, "Go back.", nightsWork176)
	function identified() {
		document.getElementById("prompt").innerHTML = "You already examined this jar and realized that it is cayenne pepper.";
		buttonReset();
		setButton(0, "Take the jar.", take)
		setButton(1, "Leave the jar.", nightsWork68)
		function take() {
			if (checkQuantityFull(player.items, player.itemsQuantity, items.cayenne) === true) {
				return dropStuff(player.items, player.itemsQuantity, "item");
			} else {
				document.getElementById("prompt").innerHTML = "The Cayenne Pepper was added to your inventory. "
				buttonReset();
				setButton(0, "Continue.", nightsWork68)
				addStuff(player.items, player.itemsQuantity, 1, items.cayenne, "item") 																								//add cayenne pepper
				player.flags[nwFlags + 6] = true;
				loadInventory();
			}
		}
	}
}

function nightsWork69() {
	player.progress = nwOffset + 69;
	document.getElementById("prompt").innerHTML = "The bag contains a dozen glittering gems, each wrapped in paper!";
	buttonReset();
	var b = 2;
	setButton(0, "Take them.", take)
	setButton(1, "Appraise them.", nightsWork82)
	if (player.flags[nwFlags + 39] === false) {
		setButton(b, "Look through the papers.", nightsWork150)
		b += 1;
	}
	setButton(b, "Go back.", nightsWork16);
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.bagOfGems) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The gems were added to your inventory."
			player.flags[nwFlags + 40] = true;
			addStuff(player.items, player.itemsQuantity, 1, items.bagOfGems, "item");
			loadInventory();
			buttonReset();
			setButton(0, "Continue.", nightsWork16)
		}
	}
}

function nightsWork70() {
	player.progress = nwOffset + 70;
	document.getElementById("prompt").innerHTML = 'As you try to lift the sword, it scrapes a little on the stone floor of the room. Instantly you feel a large hand '+
	'around your wrist. "Now then, what might you be doing, borrowing my sword without permission?" the man asks as he takes the scimitar from you. '
	buttonReset();
	setButton(0, "Talk your way out of this.", nightsWork156)
	setButton(1, "Break free.", breakFree)
	function breakFree() {
		if (rng(20)+combat.bonus(player.strength) >= 18) {
			nightsWork105();
		} else {nightsWork146()}
	}
}

function nightsWork71() {
	player.progress = nwOffset + 71;
	document.getElementById("prompt").innerHTML = "You go down the stairs and find yourself in almost complete darkness. ";
	buttonReset();
	var hasCandle = checkForStuff(player.items, items.candleStick);
	if (hasCandle !== false) {
		document.getElementById("prompt").innerHTML += "Good thing you had that candle. "
		setButton(0, "Continue.", nightsWork16)
	} else {
		setButton(0, "Grope around in the cellar.", nightsWork143)	
		setButton(1, "Go back up the stairs.", nightsWork14)
	}
}

function nightsWork72() {
	player.progress = nwOffset + 72;
	document.getElementById("prompt").innerHTML = "It's only worth a few copper coins per bottle - not worth the trouble of stealing. ";
	buttonReset();
	setButton(0, "Drink a bottle.", nightsWork45)
	setButton(1, "Go back.", nightsWork16)
}

function nightsWork73() {
	player.progress = nwOffset + 73;
	document.getElementById("prompt").innerHTML = "You have a brilliant idea - pack the porcelain in the pillows to keep it from breaking. ";
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 35] && player.flags[nwFlags + 36] && player.flags[nwFlags + 37] && !checkForStuff(player.items, items.pillow)) {
		document.getElementById("prompt").innerHTML += "Too bad you already slit the pillows open. You could still take them, but they might break before you get home. "
		setButton(b, "Take the tea set.", unprotected)
		b += 1;
	} else {
		document.getElementById("prompt").innerHTML += "You could package them up and add them to your inventory."
		setButton(b, "Take the tea set.", protected)
		b += 1;
	}
	if (player.flags[nwFlags + 21] === false) {
		setButton(b, "Examine hookahs on the table.", nightsWork66)
		b += 1;
	}
	setButton(b, "Look elsewhere in the room.", nightsWork171)
	function take() {
		document.getElementById("prompt").innerHTML = "The tea set was added to your inventory. ";
		buttonReset();
		setButton(0, "Continue.", nightsWork171);
		player.flags[nwFlags + 22] = true;
		player.flags[nwFlags + 24] = true;
	}
	function protected() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.teaService) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			if (!checkForStuff(player.items, items.pillow)) {
				if (!player.flags[nwFlags + 35]) {
					addStuff(player.items, player.itemsQuantity, 1, items.pillow, "item");
					player.flags[nwFlags + 35] = true;
				} else if (!player.flags[nwFlags + 36]) {
					addStuff(player.items, player.itemsQuantity, 1, items.pillow, "item");
					player.flags[nwFlags + 36] = true;
				} else if (!player.flags[nwFlags + 37]) {
					addStuff(player.items, player.itemsQuantity, 1, items.pillow, "item");
					player.flags[nwFlags + 37] = true;
				}
			}
			take();
			addStuff(player.items, player.itemsQuantity, 1, items.teaService, "item");
			loadInventory();
			player.flags[nwFlags + 56] = true;
		}
	}
	function unprotected() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.teaService) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			take();
			addStuff(player.items, player.itemsQuantity, 1, items.teaService, "item");
			loadInventory();
			player.flags[nwFlags + 56] = false;
		}
	}
}

function nightsWork74() {
	player.progress = nwOffset + 74;
	document.getElementById("prompt").innerHTML = "You failed in your lock picking attempt. What would you like to do?";
	buttonReset();
	setButton(0, "Try again.", nightsWork122)
	setButton(1, "Look around some more.", nightsWork16)
}

function nightsWork75() {
	player.progress = nwOffset + 75;
	document.getElementById("prompt").innerHTML = "You have defeated the guard - but you hear a whistle blowing. The owner of the house, terrified by the ruckus, is "+
	"signaling the watch. You dash out the front door and duck into an alley. ";
	player.flags[nwFlags + 57] = true;
	if (player.questProgress[quests.find(0)] === 2) {
		quests.update(0);
	}
	buttonReset();
	setButton(0, "Continue.", nightsWork185)
}

function nightsWork76() {
	document.getElementById("prompt").innerHTML = "You are being challenged by Max the Guard. ";
	combat.opponent = enemy.create(enemy.guard(), enemy.lvlLessThan())
	combat.opponent.name = "Max the Guard"
	if (player.flags[nwFlags + 31] === false) {
		combat.opponent.weapons = [weapons.scimitar]
	} else {
		combat.opponent.weapons = [weapons.bash]
	}
	combat.challenge();
	buttonReset();
	setButton(0, "Fight.", combat.displayAttacks)
	setButton(1, "Evade.", flee)
	function flee() {
		if (rng(20)+combat.bonus(player.dexterity) >= 15) {
			nightsWork81();
		} else {nightsWork157();}
	}
	combat.statusDefeat = "unconscious";
	combat.statusDefeatFunc = nightsWork141;
	combat.victoryFunc = function() {
		var hasTeaSet = checkForStuff(player.items, items.teaService);
		var vicFunc;
		player.flags[nwFlags + 33] = true;
		if (player.flags[nwFlags + 32] === true) {
			if (player.flags[nwFlags + 52] === false && player.flags[nwFlags + 55] === true) {
				vicFunc = nightsWork75;
			} else {
				vicFunc = data[player.progress];
			}
		} else {
			vicFunc = nightsWork185;
		}
		if (player.flags[nwFlags + 22] === true && player.flags[nwFlags + 56] === false) {
			if (rng(20) > 10) {
				document.getElementById("prompt").innerHTML = "The tea set you stole was broken during the fight. "
				removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.teaService), "item");
				addStuff(player.items, player.itemsQuantity, 1, items.brokenTeaService, "item");
				loadInventory();
				buttonReset();
				setButton(0, "Continue.", vicFunc)
			} else {
				vicFunc();
			}
		} else {
			vicFunc();
		}
		if (player.flags[nwFlags + 31] === false) {
			 player.flags[nwFlags + 31] = true;
		}
	}
}

function nightsWork77() {
	player.progress = nwOffset + 77;
	document.getElementById("prompt").innerHTML = "This jar rattles when you shake it. You open it to find 3 gold coins. ";
	buttonReset();
	setButton(0, "Take coins.", take)
	setButton(1, "Go back.", nightsWork68)
	function take() {
		player.gold += 3; 
		document.getElementById("prompt").innerHTML = "You took the 3 gold coins. ";
		player.flags[nwFlags + 8] = true;
		buttonReset();
		setButton(0, "Go back.", nightsWork68)
	}
}

function nightsWork78() {
	player.progress = nwOffset + 78;
	var dmg = rng(5)+5;
	document.getElementById("prompt").innerHTML = "The last thing you see is the huge figure of Fatso's guard"
	if (player.flags[nwFlags + 31] === false) {
		document.getElementById("prompt").innerHTML += ", scimitar upraised "
	} else {
		document.getElementById("prompt").innerHTML += " lunging toward you "
	}
	document.getElementById("prompt").innerHTML += "- then a trap door opens in the floor and you fall through. You lost "+dmg+" health points from the fall. You land "+
	"in a small room. The door is open, and through it you can see a door that looks like it might lead out of the house. Quickly you scramble to your feet. What do "+
	"you want to do?";
	buttonReset();
	player.health -= dmg;
	displayChar();
	if (player.health < 1) {
		setButton(0, "Continue.", gameOver)
	} else {
		setButton(0, "Flee.", nightsWork10)
		setButton(1, "Wait for the guard to come back.", fight)
	}
	function fight() {
		player.progress = nwOffset + 159;
		nightsWork76();
		guardDeadLoc = "pantry"
	}
}

function nightsWork79() {
	player.progress = nwOffset + 79;
	document.getElementById("prompt").innerHTML = "AH-CHOO! This stuff is potent. You hear footsteps in the next room, and then see a huge shadow pass by. Moonlight "+
	"glitters on an upraised sword. You feel another sneeze coming on. ";
	buttonReset();
	setButton(0, "Continue.", run)
	function run() {
		if (rng(20)+combat.bonus(player.strength) >= 15) {
			document.getElementById("prompt").innerHTML = "You decide to try to run for the window."
			buttonReset();
			setButton(0, "Continue.", nightsWork23)
		} else {
			document.getElementById("prompt").innerHTML = "You are overcome by a sneezing fit."
			buttonReset();
			setButton(0, "Continue.", nightsWork67)
		}
	}
}

function nightsWork80() {
	player.progress = nwOffset + 80;
	document.getElementById("prompt").innerHTML = "You're blind! The ointment stings like fire. ";
	combat.setStatus(player, "blinded", 5)
	displayChar();
	buttonReset();
	if (player.flags[nwFlags + 53] === true || rng(20)+combat.bonus(player.strength) > 15) {
		document.getElementById("prompt").innerHTML += "Your vision clears up a bit, but yoy cannot see well enough to continue. You manage to make your way to the "+
		"window and head back to town."
		buttonReset();
		setButton(0, "Continue.", nightsWork185)
	} else {
		document.getElementById("prompt").innerHTML += "The pain makes you cry out. You stumble into the pantry and knock over a bunch of jars. The guard enters the "+
		"room and knocks you unconscious."
		buttonReset();
		setButton(0, "Continue.", nightsWork141)
	}
}

function nightsWork81() {
	player.progress = nwOffset + 81;
	document.getElementById("prompt").innerHTML = "You duck past the guard. He chases after you. ";
	player.flags[nwFlags + 53] = true;
	buttonReset();
	setButton(0, "Continue.", nightsWork157)
}

function nightsWork82() {
	player.progress = nwOffset + 82;
	if (player.flags[nwFlags + 41] === true) {
		if (player.flags[nwFlags + 42] === true) {
			document.getElementById("prompt").innerHTML = "The gems are worth a lot: about 750 gold coins."
		} else {
			document.getElementById("prompt").innerHTML = "The gems look pretty, but you do not know what they are worth. "
		}
	} else {
		if (rng(20)+combat.bonus(player.iq) >= 15) {
			player.flags[nwFlags + 42] = true;
		} else {
			player.flags[nwFlags + 42] = false;
		}
		player.flags[nwFlags + 41] = true;
		nightsWork82();
	}
	buttonReset();
	setButton(0, "Continue.", nightsWork69)
}

function nightsWork83() {
	var roll = rng(20)+combat.bonus(player.strength);
	player.progress = nwOffset + 83;
	document.getElementById("prompt").innerHTML = "You hit the giant in the head while he is sleeping. ";
	buttonReset();
	if (roll >= 20) {
		document.getElementById("prompt").innerHTML += "You killed the giant. You gained "+combat.opponent.experience+" experience points.";
		setButton(0, "Continue.", nightsWork134)
		player.flags[nwFlags + 33] = true;
		player.experience+=combat.opponent.experience;
		displayChar();
		guardDeadLoc = "bed"
	} else if (roll >= 15) {
		document.getElementById("prompt").innerHTML += "The giant was Knocked out. ";
		player.flags[nwFlags + 33] = true;
		setButton(0, "Continue.", nightsWork134)
	} else if (roll >= 10) {
		document.getElementById("prompt").innerHTML += "The giant was stunned. ";
		setButton(0, "Continue.", nightsWork164)
	} else if (roll < 10) {
		document.getElementById("prompt").innerHTML += "The blow glanced off of the giant and he was startled awake. ";
		setButton(0, "Continue.", nightsWork11)
	}
}

function nightsWork84() {
	player.progress = nwOffset + 84;
	document.getElementById("prompt").innerHTML = "The ointment feels good, but it does not do much of anything else. ";
	buttonReset();
	setButton(0, "Continue.", nightsWork114)
}

function nightsWork85() {
	player.progress = nwOffset + 85;
	document.getElementById("prompt").innerHTML = "As you case the kitchen, you hear quiet footsteps in the next room. Someone is coming to check on the noise you made.";
	if (player.questProgress[quests.find(0)] === 1) {
		quests.update(0);
	}
	buttonReset();
	setButton(0, "Continue.", roll)
	function roll() {
		if (rng(20)+combat.bonus(player.dexterity) >= 15) {
			nightsWork100()
		} else {nightsWork93()}
	}
}

function nightsWork86() {
	player.progress = nwOffset + 86;
	buttonReset();
	if (player.flags[nwFlags + 33] === false) {
		document.getElementById("prompt").innerHTML = "You tiptoe over to the sword lying on the floor. You very gently take it by the grip and attempt to pick it up.";
		setButton(0, "Continue.", roll)
	} else {
		take();
	}
	function take() {
		if (checkQuantityFull(player.weapons, player.weaponsQuantity, weapons.scimitar) === true) {
			return dropStuff(player.weapons, player.weaponsQuantity, "weapon");
		} else {
			document.getElementById("prompt").innerHTML = "The scimitar was added to your weapons. ";
			player.flags[nwFlags + 31] = true;
			addStuff(player.weapons, player.weaponsQuantity, 1, weapons.scimitar, "weapon");
			loadWeapons();
			buttonReset();
			setButton(0, "Continue.", nightsWork149)
		}
	}
	function roll() {
		if (rng(20)+combat.bonus(player.dexterity) >= 10) {
			nightsWork30()
		} else {nightsWork70()}
	}
}

function nightsWork87() {
	player.progress = nwOffset + 87;
	document.getElementById("prompt").innerHTML = "You slit the pillow open and feathers fly everywhere. You find nothing of value except a single gold coin. The "+
	"pillow is now worthless.";
	player.flags[nwFlags + 37] = true;			//blue pillow
	player.gold += 1;
	buttonReset();
	setButton(0, "Continue.", nightsWork46)
}

function nightsWork88() {
	player.progress = nwOffset + 88;
	document.getElementById("prompt").innerHTML = "The guard has you in his grip. What would you like to do?";
	buttonReset();
	setButton(0, "Break free.", breakFree);
	setButton(1, "Fight.", fight);
	function breakFree() {
		if (rng(20)+combat.bonus(player.strength) >= 15) {
			document.getElementById("prompt").innerHTML = "You broke free from the guard's grip. What would you like to do?";
			buttonReset();
			setButton(0, "Run for the pantry.", nightsWork58);
			setButton(1, "Go through the window.", nightsWork113);
		} else {
			document.getElementById("prompt").innerHTML = "You could not escape from the guard's grip.";
			buttonReset();
			player.progress = nwOffset + 128;
			setButton(0, "Continue.", nightsWork76)
		}
	}
	function fight() {
		player.progress = nwOffset + 128;
		nightsWork76();
		guardDeadLoc = "kitchen"
	}
}

function nightsWork89() {
	player.progress = nwOffset + 89;
	document.getElementById("prompt").innerHTML = "You sink your knife into Fatso's wattled neck. He gurgles and sighs, then drops back - dead. But your triumph is "+
	"short-lived. In the time it took to end Fatso's career, the guard has come up behind you. ";
	buttonReset();
	player.flags[nwFlags + 52] = true;
	player.flags[nwFlags + 55] = false;
	setButton(0, "Continue.", fight)
	function fight() {
		player.progress = nwOffset + 128;
		nightsWork76();
		guardDeadLoc = "kitchen"
	}
}

function nightsWork90() {
	player.progress = nwOffset + 90;
	document.getElementById("prompt").innerHTML = "You set off a trap. You hear a click, and the cask you were working on disappears into the floor. Then you hear a "+
	"rumble as the casks start to shift. ";
	buttonReset();
	if (rng(20)+combat.bonus(player.iq) >= 15) {
		document.getElementById("prompt").innerHTML += "Luckily, you sensed the trap and had time to react. ";
		setButton(0, "Continue.", nightsWork61)
	} else {
		document.getElementById("prompt").innerHTML += "Unfortunately, you could not react in time. ";
		setButton(0, "Continue.", nightsWork44)
	}
}

function nightsWork91() {
	player.progress = nwOffset + 91;
	document.getElementById("prompt").innerHTML = "The cloth falls away, and you see that the rope has a core of woven metal, like very fine chainmail. You won't be "+
	"able to cut it after all. ";
	player.flags[nwFlags + 46] = true;
	buttonReset();
	if (rng(20)+combat.bonus(player.dexterity) >= 15) {
		setButton(0, "Continue.", nightsWork110)
	} else {
		document.getElementById("prompt").innerHTML += "You accidentally pulled the rope while attempting to cut it. ";
		setButton(0, "Continue.", nightsWork139)
	}
}

function nightsWork92() {
	if (rng(20)+combat.bonus(player.strength) >= 15) {
		nightsWork168()
	} else {nightsWork138()}
}

function nightsWork93() {
	player.progress = nwOffset + 93;
	document.getElementById("prompt").innerHTML = "You look around frantically - and there seems to be nowhere for you to hide. You hear footsteps approaching from "+
	"another room. ";
	buttonReset();
	setButton(0, "Fight whoever is coming.", nightsWork25)
	setButton(1, "Run for the window.", run)
	function run() {
		if (rng(20)+combat.bonus(player.dexterity) >= 15) {
			nightsWork33();
		} else {
			document.getElementById("prompt").innerHTML = "You ran for the window and could not make it in time. ";
			buttonReset();
			setButton(0, "Continue.", fight)
		}
		function fight() {
			player.progress = nwOffset + 128;
			nightsWork76();
			guardDeadLoc = "kitchen"
		}
	}
}

function nightsWork94() {
	player.progress = nwOffset + 94;
	document.getElementById("prompt").innerHTML = "The casks smell faintly of ale. They are all corked and stamped with the imperial tax seal. All of them seem to be "+
	"full. ";
	buttonReset();
	setButton(0, "Inspect casks further.", roll)
	setButton(1, "Go back.", nightsWork16)
	function roll() {
		if (player.flags[nwFlags + 47] === true) {
			if (player.flags[nwFlags + 48] === true) {
				nightsWork177();
			} else {nightsWork12();}
		} else {
			player.flags[nwFlags + 47] = true;
			if (rng(20)+combat.bonus(player.iq) >= 8) {
				player.flags[nwFlags + 48] = true;
				nightsWork177();
			} else {nightsWork12();}
		}
	}
}

function nightsWork95() {
	player.progress = nwOffset + 95;
	document.getElementById("prompt").innerHTML = "The guard caught up with you. He's angry and ready for a fight. ";
	buttonReset();
	setButton(0, "Continue.", roll)
	function roll() {
		player.progress = nwOffset + 128;
		if (rng(20)+combat.bonus(player.iq) > 15) {
			nightsWork123();
		} else {
			player.progress = nwOffset + 128;
			nightsWork76();
			guardDeadLoc = "kitchen"
		}
	}
}

function nightsWork96() {
	player.progress = nwOffset + 96;
	document.getElementById("prompt").innerHTML = "Under the circumstances, Fatso complies quickly. The guard is surly, but obedient. He backs away. You realize that "+
	"you've done all the burgling you will do tonight. With the master of the house as escort, you walk slowly toward the exit. At the front door, you release Fatso. "+
	"With a mocking bow, you vanish into the night. ";
	buttonReset();
	setButton(0, "Continue.", nightsWork185)
}

function nightsWork97() {
	player.progress = nwOffset + 97;
	document.getElementById("prompt").innerHTML = "The front of the cask swings open to reveal a stack of books and papers and a small bag. The bag has a greasy feel "+
	"to it and is sealed with a led seal. Inside you can feel small lumps and something that crackles. ";
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 39] === false) {
		setButton(0, "Look through the papers.", nightsWork150)
		b += 1;
	}
	if (player.flags[nwFlags + 40] === false) {
		setButton(b, "Open the bag.", nightsWork69)
		setButton(b+1, "Take the bag without opening it.", take)
		b += 2;
	}
	setButton(b, "Go back.", nightsWork16)
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.oilyBag) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "You put the bag in your inventory. "
			addStuff(player.items, player.itemsQuantity, 1, items.oilyBag, "item")
			player.flags[nwFlags + 40] = true;
			loadInventory();
			buttonReset();
			setButton(0, "Continue.", nightsWork97)
		}
	}
}

function nightsWork98() {
	player.progress = nwOffset + 98;
	document.getElementById("prompt").innerHTML = "On one of the shelves, you see many small apothecaries' jars. Most of them are labeled. ";
	buttonReset();
	setButton(0, "Read the labeled jars.", nightsWork101)
	setButton(1, "Take some jars.", nightsWork42)
	setButton(2, "Open some of the jars.", nightsWork115)
	setButton(3, "Leave the jars alone.", nightsWork176)
}

function nightsWork99() {
	player.progress = nwOffset + 99;
	if (rng(20)+combat.bonus(player.iq) >= 12) {
			nightsWork126()
	} else {nightsWork128()}
}

function nightsWork100() {
	player.progress = nwOffset + 100;
	document.getElementById("prompt").innerHTML = "You manage to find a dark corner to hide in. It's a good thing too, because a huge man enters the room to see what's "+
	"going on. He looks around, but can't see you. After a few minutes, he leaves and you come out. ";
	buttonReset();
	setButton(0, "Continue.", nightsWork128)
}

function nightsWork101() {
	player.progress = nwOffset + 101;
	document.getElementById("prompt").innerHTML = "Most of the labeled jars show the names of herbs and spices. Twelve of them show the names of common herbs and "+
	"spices. Twenty show the names of moderately rare spices. Four show the names of very rare spices. Five are unlabeled. ";
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 5] === false) {
		setButton(b, "Take/check the jars.", nightsWork42)
		b += 1;
	}
	setButton(b, "Open some of the jars.", nightsWork115)
	setButton(b+1, "Leave the jars alone.", nightsWork176)
}

function nightsWork102() {
	player.progress = nwOffset + 102;
	document.getElementById("prompt").innerHTML = "As you climb into the window, you lose your balance for a second. One foot hits the floor rather hard, making "+
	"a faint but audible noise. You think you hear something stirring in the house; it could be your imagination, or it might be something moving. What do you do?";
	buttonReset();
	
	setButton(0, "Ignore the noise and go on.", nightsWork85)
	setButton(1, "Stand still for a moment.", nightsWork48)
}

function nightsWork103() {
	player.progress = nwOffset + 103;
	document.getElementById("prompt").innerHTML = "After looking for a while, you realize that this junk is, indeed, junk. There is absolutely nothing worthwhile here, "+
	"unless you come back in the morning and talk the lord of the house into paying you to take it all away - and that sounds too much like honest work. ";
	buttonReset();
	setButton(0, "Continue.", nightsWork16)
}

function nightsWork104() {
	player.progress = nwOffset + 104;
	document.getElementById("prompt").innerHTML = "You have three choices - think fast! ";
	buttonReset();
	setButton(0, "Talk your way out of this.", nightsWork156)
	setButton(1, "Stand and fight.", fight)
	setButton(2, "Run.", nightsWork81)
	function fight() {
		player.progress = nwOffset + 149;
		nightsWork76();
		guardDeadLoc = "floor"
	}
}

function nightsWork105() {
	player.progress = nwOffset + 105;
	document.getElementById("prompt").innerHTML = "You manage to slip from the guard's grasp as he goes for his scimitar. ";
	player.flags[nwFlags + 43] = false;
	buttonReset();
	setButton(0, "Continue.", nightsWork104)
}

function nightsWork106() {
	player.progress = nwOffset + 106;
	document.getElementById("prompt").innerHTML = "You slit the pillow open and feathers fly everywhere - but theres nothing of value inside. The pillow is now worthless. ";
	player.flags[nwFlags + 36] = true;			//yellow pillow
	buttonReset();
	setButton(0, "Continue.", nightsWork46)
}

function nightsWork107() {
	player.progress = nwOffset + 107;
	document.getElementById("prompt").innerHTML = "Yeech! This tastes terrible, and it nauseates you. You lost 1 health point. ";
	player.health -= 1;
	if (player.health < 1) {
		gameOver();
		return;
	}
	displayChar()
	buttonReset();
	setButton(0, "Continue.", nightsWork114)
}

function nightsWork108() {
	player.progress = nwOffset + 108;
	document.getElementById("prompt").innerHTML = "Carefully you grasp the key and ready your knife to cut the cord. ";
	buttonReset();
	setButton(0, "Continue.", roll)
	function roll() {
		if (rng(20)+combat.bonus(player.dexterity) >= 15) {
			nightsWork38()
		} else {nightsWork53()}
	}
}

function nightsWork109() {
	player.progress = nwOffset + 109;
	document.getElementById("prompt").innerHTML = "You are in the guard's bedroom. There is no furniture except the crude mattress on the floor. There is a closet under "+
	"the stairway. There's only one exit, and the guard is standing in it, trapping you inside. What do you do?";
	buttonReset();
	setButton(0, "Fight the guard.", fight);
	setButton(1, "Duck past the guard.", nightsWork81);
	function fight() {
		player.progress = nwOffset + 149;
		nightsWork76();
		guardDeadLoc = "floor"
	}
}

function nightsWork110() {
	player.progress = nwOffset + 110;
	document.getElementById("prompt").innerHTML = "You are in the master bedroom. "
	if (player.flags[nwFlags + 52] === false && player.flags[nwFlags + 55] === false) {
		document.getElementById("prompt").innerHTML += "There is only one person in here: a white-bearded, heavy-set man in loud silk pajamas. He is snoring loudly. "
	} else if (player.flags[nwFlags + 52] === false && player.flags[nwFlags + 55] === true) {
		document.getElementById("prompt").innerHTML +='Fatso is spooked. "Please '+"don't"+' kill me!" he pleads. "Take whatever you want and leave! Just '+"don't"+
		' hurt me!" '
	} else {
		document.getElementById("prompt").innerHTML += "Fatso's dead body is already starting to smell. "
	}
	if (player.flags[nwFlags + 33] === true && guardDeadLoc === "fatso") {
		document.getElementById("prompt").innerHTML += "The guard's dead body is sprawled out on the floor. "
	}
	document.getElementById("prompt").innerHTML += "Various statuettes and objects d'art adorn the bedroom. There is a bell-pull hanging from the ceiling beside the bed. ";
	buttonReset();
	if (player.flags[nwFlags + 52] === false && player.flags[nwFlags + 55] === false) {
		if (player.flags[nwFlags + 46] === false && rng(20)+combat.bonus(player.iq) >= 12) {
			document.getElementById("prompt").innerHTML += "You have an idea. ";
			setButton(0, "Continue.", nightsWork2);
		} else {
			setButton(0, "Look for something to steal.", nightsWork20)
			setButton(1, "Kill Fatso.", kill)
			setButton(2, "Leave the room.", nightsWork18)
		}
	} else if (player.flags[nwFlags + 52] === false && player.flags[nwFlags + 55] === true) {
		setButton(0, "Look for something to steal.", nightsWork20)
		setButton(1, "Kill Fatso.", kill)
		setButton(2, "Leave the room.", nightsWork18)
	} else {
		var b = 1;
		setButton(0, "Look for something to steal.", nightsWork20)
		if (player.flags[nwFlags + 44] === false) {
			setButton(b, "Investigate Fatso's corpse.", nightsWork52)
			b += 1;
		}
		setButton(b, "Leave the room.", nightsWork18)
	}
	function kill() {
		document.getElementById("prompt").innerHTML = "You slit Fatso's throat, and he falls to the ground, gasping for air. "
		player.flags[nwFlags + 52] = true;
		player.flags[nwFlags + 55] = false;
		buttonReset();
		setButton(0, "Continue.", nightsWork110)
	}
}

function nightsWork111() {
	player.progress = nwOffset + 111;
	document.getElementById("prompt").innerHTML = "You are at a little landing which leads into several areas. Facing the stairs and going clockwise they are: stairs "+
	"going up to the left, a great hall, a kitchen, and pantry."
	setButton(0, "Check out the pantry.", nightsWork159);
	setButton(1, "Go up the stairs.", nightsWork18);
	setButton(2, "Go into the great hall.", nightsWork59);
	setButton(3, "Go back to the kitchen.", nightsWork128);
}

function nightsWork112() {
	player.progress = nwOffset + 112;
	document.getElementById("prompt").innerHTML = "HELLO! This is your conscience. Do you REALLY want to kill this man? You can get into trouble if you steal things; "+
	"you can get KILLED if you commit murder. The Thieves' Guild and the City Watch will suddenly become very interested in you. "
	if (player.flags[nwFlags + 33] === false) {
		document.getElementById("prompt").innerHTML += "Think fast, because someone is coming up the stairs. You still have time to kill him, if that's what you want +"
		"to do.";
	}
	buttonReset();
	setButton(0, "Kill Fatso.", nightsWork89)
	setButton(1, "Bully Fatso out of his money.", nightsWork7)
	if (player.flags[nwFlags + 33] === false) {
		setButton(2, "See who comes up the stairs.", nightsWork49)
	}
}

function nightsWork113() {
	player.progress = nwOffset + 113;
	document.getElementById("prompt").innerHTML = "You attempt to dive through the window before the guard can grab you. ";
	buttonReset();
	setButton(0, "Continue.", roll)
	function roll() {
		if (rng(20)+combat.bonus(player.dexterity) >= 15) {
			nightsWork185();
		} else {nightsWork121();}
	}
}

function nightsWork114() {
	player.progress = nwOffset + 114;
	document.getElementById("prompt").innerHTML = "What do you want to do with the oily white cream?";
	buttonReset();
	setButton(0, "Test it on a cut.", nightsWork131)
	setButton(1, "Try it on a burn.", nightsWork65)
	setButton(2, "Rub it on uninjured skin.", nightsWork84)
	setButton(3, "Taste it.", nightsWork107)
	setButton(4, "Rub it in your eyes.", nightsWork80)
	setButton(5, "Take jar.", take)
	setButton(6, "Go back.", nightsWork68)
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.burnOintment) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The jar was added to your inventory. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork68);
			player.flags[nwFlags + 11] = true;
			addStuff(player.items, player.itemsQuantity, 1, items.burnOintment, "item");
			loadInventory();
		}
	}
}

function nightsWork115() {
	player.progress = nwOffset + 115;
	document.getElementById("prompt").innerHTML = "You check several jars against their labels; all are accurate. Most of the jars are almost full.";
	buttonReset();
	setButton(0, "Continue.", nightsWork42)
}

function nightsWork116() {
	player.progress = nwOffset + 116;
	buttonReset();
	if (rng(20)+combat.bonus(player.iq) >= 15) {
		document.getElementById("prompt").innerHTML = "You sampled the wine. It is definitely high quality. ";
		setButton(0, "Continue.", nightsWork16)
	} else {
		document.getElementById("prompt").innerHTML = "You sampled the wine. You drank too much and got a little drunk. ";
		combat.boostTempStat(0, -3, 5, 1);
		combat.boostTempStat(0, -3, 5, 2);
		setButton(0, "Continue.", nightsWork16)
	}
}

function nightsWork117() {
	player.progress = nwOffset + 117;
	document.getElementById("prompt").innerHTML = 'As you come up out of the cellar you see something that '+"wasn't"+' there before; a huge man'
	if (player.flags[nwFlags + 31] === false) {
		document.getElementById("prompt").innerHTML += " with a scimitar"
	}
	document.getElementById("prompt").innerHTML += '. "I would give you five seconds to explain what you are doing here," the man bellows, "but I '+"don't"+' really '+
	'care!" And he advances toward you.';
	buttonReset();
	setButton(0, "Talk your way out of this.", nightsWork156)
	setButton(1, "Stand and Fight.", fight)
	setButton(2, "Run past the guard.", nightsWork81)
	function fight() {
		player.progress = nwOffset + 159;
		nightsWork76();
		guardDeadLoc = "pantry"
	}
}

function nightsWork118() {
	player.progress = nwOffset + 118;
	document.getElementById("prompt").innerHTML = "The jar contains 10 gold coins. You take the coins.";
	buttonReset();
	setButton(0, "Continue.", take)
	function take() {
		player.gold += 10;
		displayChar();
		player.flags[nwFlags + 9] = true;
		nightsWork68();
	}
}

function nightsWork119() {
	player.progress = nwOffset + 119;
	document.getElementById("prompt").innerHTML = "You study the china. ";
	buttonReset();
	if (player.flags[nwFlags + 26] === false) {
		if (rng(20)+combat.bonus(player.iq) >= 12) {
			nightsWork47();
			player.flags[nwFlags + 27] = true;
			return;
		} else {
			document.getElementById("prompt").innerHTML += "The china looks old and fragile, not something worth taking. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork129)
			player.flags[nwFlags + 27] = false;
		}
		player.flags[nwFlags + 26] = true;
	} else {
		if (player.flags[nwFlags + 27] === true) {
			nightsWork47();
			return;
		} else {
			document.getElementById("prompt").innerHTML += "The china looks old and fragile, not something worth taking. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork129)
		}
	}
	var b = 0;
	if (player.flags[nwFlags + 22] === false) {
		setButton(b, "Take the tea set.", unprotected)
		b += 1;
	}
	if (player.flags[nwFlags + 23] === false) {
		setButton(b, "Take the spoons.", take)
		b += 1;
	}
	if (player.flags[nwFlags + 26] === false) {
		setButton(b, "Examine the hookahs.", 66)
		b += 1;
	}
	setButton(b, "Look elsewhere.", nightsWork171)
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.spoon) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The spoons were added to your inventory. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork129);
			player.flags[nwFlags + 23] = true;
			addStuff(player.items, player.itemsQuantity, 4, items.spoon, "item");
			loadInventory();
		}
	}
	function unprotected() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.teaService) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The tea set was added to your inventory. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork129);
			addStuff(player.items, player.itemsQuantity, 1, items.teaService, "item");
			loadInventory();
			player.flags[nwFlags + 56] = false;
			player.flags[nwFlags + 22] = true;
		}
	}
}

function nightsWork120() {
	player.progress = nwOffset + 120;
	document.getElementById("prompt").innerHTML = "The mark is that of Jharno, weaver whose work is in great demand. Once word gets around that this particular piece "+
	"has been stolen it may be hard to sell it here, but your fence will almost certainly be able to find a buyer somewhere far enough away that it won't be recognized.";
	buttonReset();
	setButton(0, "Remove the tapestry from the wall.", nightsWork41)
	setButton(1, "Look at something else.", nightsWork171)
}

function nightsWork121() {
	player.progress = nwOffset + 121;
	document.getElementById("prompt").innerHTML = "The guard catches up with you and tries to pull you back in the house. ";
	buttonReset();
	if (rng(20)+combat.bonus(player.strength) >= 15) {
		document.getElementById("prompt").innerHTML += "However, you manage to break loose. ";
		setButton(0, "Try again.", nightsWork113)
		setButton(1, "Continue.", nightsWork113)
	} else {
		document.getElementById("prompt").innerHTML += "He manages to drag you back inside. ";
		setButton(0, "Continue.", nightsWork88)
	}
}

function nightsWork122() {
	player.progress = nwOffset + 122;
	document.getElementById("prompt").innerHTML = "Whoever made this lock knew what they were doing. ";
	buttonReset();
	if (rng(20)+combat.bonus(player.iq) >= 15) {
		document.getElementById("prompt").innerHTML += "You successfully picked the lock. ";
		setButton(0, "Continue.", nightsWork97)
	} else {
		document.getElementById("prompt").innerHTML += "You failed to pick the lock. ";
		setButton(0, "Continue.", nightsWork74)
	}
}

function nightsWork123() {
	document.getElementById("prompt").innerHTML = "You're in the kitchen, remember? If you need a weapon, grab one of the pots or pans. ";
	buttonReset();
	setButton(0, "Take pan.", take)
	setButton(1, "Continue.", nightsWork76)
	function take() {
		if (checkQuantityFull(player.weapons, player.weaponsQuantity, weapons.pan) === true) {
			return dropStuff(player.weapons, player.weaponsQuantity, "weapon");
		} else {
			document.getElementById("prompt").innerHTML = "The pan was added to your weapons. ";
			addStuff(player.weapons, player.weaponsQuantity, 1, weapons.pan, "weapon");
			loadWeapons();
			buttonReset();
			setButton(0, "Continue.", nightsWork76)
		}
	}
}

function nightsWork124() {
	player.progress = nwOffset + 124;
	if (player.flags[nwFlags + 35] && player.flags[nwFlags + 36] && player.flags[nwFlags + 37]) {
		return nightsWork171();
	}
	var count = 3;
	if (player.flags[nwFlags + 35] === true) {
		count -= 1;
	}
	if (player.flags[nwFlags + 36] === true) {
		count -= 1;
	}
	if (player.flags[nwFlags + 37] === true) {
		count -= 1;
	}
	if (count !== 1) {
		document.getElementById("prompt").innerHTML = "There are "+count+" pillows. They are made of silk, and fine embroidery, and they look like they might be worth some money. "
	} else {
		document.getElementById("prompt").innerHTML = "There is one pillow. It is made of silk, and fine embroidery, and it looks like it might be worth some money. ";
	}
	if (player.flags[nwFlags + 35] === false) {
		document.getElementById("prompt").innerHTML += "You feel a couple of lumps in the red pillow - like something might be hidden inside it.";
	}
	buttonReset();
	var b = 1;
	setButton(0, "Cut the pillows open.", cut)
	if (player.flags[nwFlags + 35] === false) {
		setButton(b, "Take the red pillow.", takeRed)
		b += 1;
	}
	if (player.flags[nwFlags + 36] === false) {
		setButton(b, "Take the yellow pillow.", takeYellow)
		b += 1;
	}
	if (player.flags[nwFlags + 37] === false) {
		setButton(b, "Take the blue pillow.", takeBlue)
		b += 1;
	}
	setButton(b, "Go back.", nightsWork171)
	function cut() {
		if (rng(20)+combat.bonus(player.iq) >= 15) {
			nightsWork60();
		} else {nightsWork46();}
	}
	function takeRed() {take(35, "red")}
	function takeYellow() {take(36, "yellow")}
	function takeBlue() {take(37, "blue")}
	function take(boolNum, color) {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.pillow) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The "+color+" pillow was added to your inventory. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork124)
			addStuff(player.items, player.itemsQuantity, 1, items.pillow, "item")				//add the pillow to inventory
			player.flags[nwFlags + boolNum] = true;
			loadInventory();
		}
	}
}

function nightsWork125() {
	player.progress = nwOffset + 125;
	document.getElementById("prompt").innerHTML = "Most of the wines are of a local vintage; stout, hearty and good for washing down meals.";
	buttonReset();
	if (player.flags[nwFlags + 17] === false) {
		if (rng(20)+combat.bonus(player.iq) >= 15) {
			setButton(0, "Continue.", nightsWork175)
			player.flags[nwFlags + 18] = true;
		} else {
			setButton(0, "Continue.", nightsWork72)
			player.flags[nwFlags + 18] = false;
		}
	} else {
		if (player.flags[nwFlags + 18] === true) {
			setButton(0, "Continue.", nightsWork175)
		} else {
			setButton(0, "Continue.", nightsWork72)
		}
	}
	player.flags[nwFlags + 17] = true;
}

function nightsWork126() {
	player.progress = nwOffset + 126;
	document.getElementById("prompt").innerHTML = "You spot a heavy iron skillet under the counter with some other cookware. You may take it if you wish. Good cooking "+
	"utensils are in demand, and in a pinch you could use it as a weapon!";
	buttonReset();
	setButton(0, "Take iron skillet.", take);
	setButton(1, "Continue.", nightsWork128);
	function take() {
		if (checkQuantityFull(player.weapons, player.weaponsQuantity, weapons.ironSkillet) === true) {
			return dropStuff(player.weapons, player.weaponsQuantity, "weapon");
		} else {
			document.getElementById("prompt").innerHTML = "The iron skillet was added to your weapons. ";
			player.flags[nwFlags + 0] = true;
			addStuff(player.weapons, player.weaponsQuantity, 1, weapons.ironSkillet, "weapon");
			loadWeapons();
			buttonReset();
			setButton(0, "Continue.", nightsWork128)
		}
	}
}

function nightsWork127() {
	player.progress = nwOffset + 127;
	document.getElementById("prompt").innerHTML = "Holding your breath, you toss the entire jar of pepper at the guard's face. He stumbles back with a choked cry. "+
	"Seizing the chance, you dodge past him. Above you a whistle has begun to blow; you know it's time you were leaving. You head back to the kitchen and dive out "+
	"through the window.";
	player.flags[nwFlags + 57] = true;
	buttonReset();
	setButton(0, "Continue.", nightsWork148)
}

function nightsWork128() {
	player.progress = nwOffset + 128;
	document.getElementById("prompt").innerHTML = "You are in the kitchen. A fire is dying in the fireplace. A heavy, lidded iron pot sits in the embers. Something in "+
	"that pot smells very good! "
	if (player.flags[nwFlags + 2] === false) {
		document.getElementById("prompt").innerHTML += "There is a candle in an ornate candle holder on the table near the fireplace. ";
	}
	if (player.flags[nwFlags + 33] === true && guardDeadLoc === "kitchen") {
		document.getElementById("prompt").innerHTML += "The guard's dead body is sprawled out on the floor. "
	}
	if (player.questProgress[quests.find(0)] === 1) {
		quests.update(0);
	}
	buttonReset();
	var b = 2;
	setButton(0, "Search the kitchen.", nightsWork183)
	setButton(1, "Open the pot.", nightsWork158)
	if (player.flags[nwFlags + 1] === false && player.flags[nwFlags + 2] === false) {
		setButton(b, "Light the candle.", nightsWork3);
		document.getElementById("prompt").innerHTML += "There is a candle in an ornate candle holder on the table near the fireplace. ";
		b += 1;
	} else if (player.flags[nwFlags + 1] === true && player.flags[nwFlags + 2] === false) {
		setButton(b, "Take the lit candle.", take);
		document.getElementById("prompt").innerHTML += "There is a lit candle in an ornate candle holder on the table near the fireplace. ";
		b += 1;
	}
	setButton(b, "Go to the next room.", nightsWork111)
	setButton(b+1, "Leave through the window and go back to town.", nightsWork27)
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.candleStick) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The candlestick was added to your inventory. "
			buttonReset();
			setButton(0, "Go back.", nightsWork128)
			addStuff(player.items, player.itemsQuantity, 1, items.candleStick, "item");
			player.flags[nwFlags + 2] = true;
			loadInventory();
		}
	}
}

function nightsWork129() {
	player.progress = nwOffset + 129;
	document.getElementById("prompt").innerHTML = "There is little in this room; just a low table with a tea service and three hookahs are about it. The table is too "+
	"big to consider stealing. The hookahs are ornate brass. The tea service looks very old and delicate.";
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 22] === false || player.flags[nwFlags + 23] === false) {
		setButton(b, "Look at the tea service.", nightsWork167)
		b += 1;
	}
	if (player.flags[nwFlags + 21] === false) {
		setButton(b, "Appraise the hookahs.", nightsWork66)
		b += 1;
	}
	setButton(b, "Go back.", nightsWork171)
}

function nightsWork130() {
	player.progress = nwOffset + 130;
	document.getElementById("prompt").innerHTML = "You slit the pillow open and feathers fly everywhere - but there is nothing of value inside.";
	player.flags[nwFlags + 35] = true;				//red pillow
	buttonReset();
	setButton(0, "Continue.", nightsWork46)
}

function nightsWork131() {
	player.progress = nwOffset + 131;
	document.getElementById("prompt").innerHTML = "The ointment stings!";
	buttonReset();
	setButton(0, "Continue.", roll)
	function roll() {
		if (rng(20)+combat.bonus(player.strength) >= 15) {
			nightsWork114();
		} else {nightsWork24();}
	}
}

function nightsWork132() {
	player.progress = nwOffset + 132;
	document.getElementById("prompt").innerHTML = "This fancy spoon shouldn't be too hard to sell. I'll give you 50 gold coins for each. ";
	buttonReset();
	setButton(0, "Deal.", deal)
	setButton(1, "Nevermind.", data22)
	function deal() {
		player.gold += 50;
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.spoon), "item");
		loadInventory();
		displayChar();
		data22();
	}
}

function nightsWork133() {
	player.progress = nwOffset + 133;
	document.getElementById("prompt").innerHTML = "You dash through the door, slamming it behind you. You're outside! The closed door gives you a moment's head start "+
	"on the guard. ";
	player.flags[nwFlags + 32] = false;
	buttonReset();
	var guardRoll = rng(20) + 3
	if (rng(20) + combat.bonus(player.dexterity) > guardRoll) {
		document.getElementById("prompt").innerHTML += "You manage to find a hiding place. The guard looks around for a few minutes then returns to the house, cursing "+
		"under his breath. You sigh with relief and head back towards the town. ";
		setButton(0, "Continue.", data6)
	} else {
		document.getElementById("prompt").innerHTML += "However, the guard manages to catch up to you. ";
		setButton(0, "Continue.", nightsWork76);
	}
}

function nightsWork134() {
	player.progress = nwOffset + 134;
	document.getElementById("prompt").innerHTML = "You killed the giant. ";
	player.flags[nwFlags + 33] = true;
	guardDeadLoc = "bed"
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 31] === false) {
		document.getElementById("prompt").innerHTML += "You may take the scimitar if you like. "
		setButton(0, "Take scimitar.", take);
		b += 1;
	}
	setButton(b, "Continue.", nightsWork59);
	document.getElementById("prompt").innerHTML += "Searching the room, you find nothing else of any value whatever. ";
	function take() {
		if (checkQuantityFull(player.weapons, player.weaponsQuantity, weapons.scimitar) === true) {
			return dropStuff(player.weapons, player.weaponsQuantity, "weapon");
		} else {
			document.getElementById("prompt").innerHTML = "The scimitar was added to your weapons. ";
			player.flags[nwFlags + 31] = true;
			addStuff(player.weapons, player.weaponsQuantity, 1, weapons.scimitar, "weapon");
			loadWeapons();
			buttonReset();
			setButton(0, "Continue.", nightsWork59)
		}
	}
}

function nightsWork135() {
	player.progress = nwOffset + 135;
	document.getElementById("prompt").innerHTML = "The guard shouts with anger, raising his "
	if (player.flags[nwFlags + 31] === false) {
		document.getElementById("prompt").innerHTML += "scimitar"
	} else {
		document.getElementById("prompt").innerHTML += "arms"
	}
	document.getElementById("prompt").innerHTML += " - and distracting you. The merchant seizes his chance. Grabbing your arm, he yanks the bell pull. The floor opens "+
	"beneath you and you fall... with 250 pounds of angry fat man on top of you. Everything goes black. ";
	buttonReset();
	setButton(0, "Continue.", nightsWork141)
}

function nightsWork136() {
	player.progress = nwOffset + 136;
	document.getElementById("prompt").innerHTML = "Further examination reveals nothing more.";
	buttonReset();
	var b = 2;
	setButton(0, "Pull the bell-rope.", nightsWork139)
	setButton(1, "Leave the room.", nightsWork18)
	if (player.flags[nwFlags + 52] === true) {
		setButton(b, "Look at Fatso's corpse.", nightsWork52)
	} else if (player.flags[nwFlags + 55] === false) {
		setButton(b, "Take a closer look at Fatso.", nightsWork52)
	}
}

function nightsWork137() {
	player.progress = nwOffset + 137;
	document.getElementById("prompt").innerHTML = "You can't quite recognize the odor, so you try a bigger sniff. Then you know what it is - it's cayenne pepper! It's "+
	"rare and valuable - and it's making you sneeze!";
	buttonReset();
	setButton(0, "Continue.", roll)
	function roll() {
		if (player.flags[nwFlags + 12] === false) {
			player.flags[nwFlags + 12] = true;
			if (rng(20)+combat.bonus(player.strength) >= 15) {
				nightsWork68();
			} else {
				if (player.flags[nwFlags + 33] === false) {
					nightsWork79();
				} else {nightsWork68();}
			}
		} else {
			nightsWork68();
		}
	}
}

function nightsWork138() {
	player.progress = nwOffset + 138;
	var dmg = rng(3)+3;
	player.health -= dmg;
	document.getElementById("prompt").innerHTML = "Ouch! You managed to burn yourself. You lost "+dmg+" health points. ";
	combat.setStatus(player, "burned", 5)
	displayChar();
	buttonReset();
	if (player.health < 1) {
		gameOver();
		return;
	} else if (rng(20)+combat.bonus(player.dexterity) >= 12) {
		document.getElementById("prompt").innerHTML += "You manage to set the lid down quietly. A stew is cooking in the pot. ";
		setButton(0, "Taste the stew.", nightsWork68);
		setButton(1, "Look around more.", nightsWork128);
	} else {
		document.getElementById("prompt").innerHTML += "You drop the lid and make a loud noise. ";
		if (player.flags[nwFlags + 33] === false) {
			setButton(0, "Continue.", nightsWork40);
		} else {
			setButton(0, "Continue.", nightsWork168);
		}
	}
}

function nightsWork139() {
	player.progress = nwOffset + 139;
	document.getElementById("prompt").innerHTML = "A trap door opens beneath you! You fall into a room below the fat man's chambers. ";
	var dmg = rng(5)+5;
	if (rng(20)+combat.bonus(player.dexterity) > 12) {
		dmg = Math.floor(dmg/2)
		document.getElementById("prompt").innerHTML += "Your acrobatic skills helped you to break your fall. You lose "+dmg+" health points. ";
	} else {
		document.getElementById("prompt").innerHTML += "You lose "+dmg+" health points. ";
	}
	player.health -= dmg;
	displayChar();
	if (player.flags[nwFlags + 33] === false) {
		document.getElementById("prompt").innerHTML += "As you stand, you see a large man reaching for his scimitar. "
		if (player.flags[nwFlags + 31] === true) {
			document.getElementById("prompt").innerHTML += "Too bad for him that you already took it. "
		} else {
			document.getElementById("prompt").innerHTML += "He will have it in hand before you can react. ";
		}
	}
	buttonReset();
	if (player.health < 1) {
		setButton(0, "Continue.", gameOver);
	} else {
		if (player.flags[nwFlags + 33] === false) {
			setButton(0, "Continue.", nightsWork104);
		} else {
			setButton(0, "Continue.", guardsRoom);
		}
	}
	function guardsRoom() {
		nightsWork149();
		document.getElementById("prompt").innerHTML = "You are back in the guard's room. The huge man's limp body is hanging off the bed. "
		if (player.flags[nwFlags + 31] === false) {
			document.getElementById("prompt").innerHTML += "On the floor next to him is a scimitar. ";
		}
	}
}

function nightsWork140() {
	player.progress = nwOffset + 140;
	document.getElementById("prompt").innerHTML = "The jar has two marks inscribed on the lid. ";
	buttonReset();
	if (player.flags[nwFlags + 14] === false) {
		if (rng(20)+combat.bonus(player.iq) >= 15) {
			document.getElementById("prompt").innerHTML += "You recognize the marks. ";
			player.flags[nwFlags + 15] = true;
			setButton(0, "Continue.", nightsWork174);
		} else {
			document.getElementById("prompt").innerHTML += "The marks mean nothing to you. ";
			player.flags[nwFlags + 15] = false;
			setButton(0, "Continue.", nightsWork26);
		}
		player.flags[nwFlags + 14] = true;
	} else {
		if (player.flags[nwFlags + 15] === false) {
			document.getElementById("prompt").innerHTML += "The marks mean nothing to you. ";
			setButton(0, "Continue.", nightsWork26);
		} else {
			document.getElementById("prompt").innerHTML += "You recognize the marks. ";
			setButton(0, "Continue.", nightsWork174);
		}
	}
}

function nightsWork141() {
	player.progress = nwOffset + 141;
	document.getElementById("prompt").innerHTML = "You are lying unconscious on the floor. You wake up the next morning in a cold, dark prison cell. All your "+
	"possessions are gone. "
	buttonReset();
	setButton(0, "Continue.", data65)
}

function nightsWork142() {
	player.progress = nwOffset + 142;
	document.getElementById("prompt").innerHTML = "You dash past the guard and down the stairs. He charges after you.";
	buttonReset();
	setButton(0, "Run for the great hall.", nightsWork157)
	setButton(1, "Run for the pantry.", nightsWork58)
	setButton(2, "Run for the kitchen.", nightsWork23)
}

function nightsWork143() {
	player.progress = nwOffset + 143;
	document.getElementById("prompt").innerHTML = "You feel around the darkened walls. Evidently the cellar is full of junk. "
	buttonReset();
	if (player.flags[nwFlags + 54] === false) {
		document.getElementById("prompt").innerHTML += "You feel the shape of a heay box... then it starts to slide onto you! You try to catch it. ";
		if (rng(20)+combat.bonus(player.iq) >= 15) {
			document.getElementById("prompt").innerHTML += "You manage to grab the box and set it down quietly. ";
			player.flags[nwFlags + 54] = true;
			setButton(0, "Continue.", nightsWork14);
		} else {
			var dmg = rng(5)+5;
			player.health -= dmg;
			displayChar(); 
			document.getElementById("prompt").innerHTML += "The box fell to the ground and bruised your leg. You lost "+dmg+" health points. ";
			player.flags[nwFlags + 54] = true;
			if (player.health < 1) {
				setButton(0, "Continue.", gameOver);
			} else {
				if (player.flags[nwFlags + 33] === false) {
					setButton(0, "Go back.", nightsWork159)
				} else {
					setButton(0, "Go back.", nightsWork117);
				}
			}
		}
	} else {
		document.getElementById("prompt").innerHTML += "It is too dark in here. You start back up the stairs to the pantry.";
		if (player.flags[nwFlags + 33] === false) {
			setButton(0, "Continue.", nightsWork117)
		} else {
			if (hasCandle !== false) {
				setButton(0, "Continue.", nightsWork16)
			} else {
				setButton(0, "Continue.", nightsWork159);
			}
			setButton(1, "Go back up the stairs.", nightsWork14)
		}
	}
}

function nightsWork144() {
	player.progress = nwOffset + 144;
	document.getElementById("prompt").innerHTML = "No bell rings. Instead, you hear a loud CREEEEK as the trap door beneath you opens. You find yourself falling.";
	buttonReset();
	setButton(0, "Continue.", nightsWork139)
}

function nightsWork145() {
	player.progress = nwOffset + 145;
	document.getElementById("prompt").innerHTML = "You recognize the mark of a local smith on the base of the hookahs. You can tell that the hookahs are too well used "+
	"to be valuable in and of themselves, and too recent to be antiques. You can take them if you wish, but they are probably not worth the effort to carry them home.";
	buttonReset();
	setButton(0, "Take the hookahs.", take)
	setButton(1, "Leave the hookahs.", nightsWork129)
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.hookah) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The hookahs were added to your inventory. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork171);
			addStuff(player.items, player.itemsQuantity, 3, items.hookah, "item");
			player.flags[nwFlags + 21] = true;
			loadInventory();
		}
	}
}

function nightsWork146() {
	player.progress = nwOffset + 146;
	if (player.flags[nwFlags + 31] === false) {
		document.getElementById("prompt").innerHTML = "With his scimitar in one hand and you in the other, "
	} else {
		document.getElementById("prompt").innerHTML = "Grabbing you by the arm, "
	}
	document.getElementById("prompt").innerHTML += "the guard hauls you into the pantry, opens the trap door, shoves you down the stairs, and closes the door behind "+
	"you. You hear him shoving a couple of flour barrels over the top of the trap door, making it too heavy for you to move. You can safely assume that you will still "+
	"be in the cellar when the guards arrive in the morning. When the guards arrive, they are rough with you and knock you unconscious. You wake up in a prison cell. "
	buttonReset();
	setButton(0, "Continue.", data65)
}

function nightsWork147() {
	player.progress = nwOffset + 147;
	document.getElementById("prompt").innerHTML = "NO! It's an AWFUL THING, and it TOUCHED you! You panic. Screaming, you run blindly for the exit... and slam into "+
	"the door frame, head first. ";
	buttonReset();
	setButton(0, "Continue.", nightsWork141)
}

function nightsWork148() {
	player.progress = nwOffset + 148;
	document.getElementById("prompt").innerHTML = "You run away from the house and down an alley. You slow to a walk as you emerge into another street. Tipping your "+
	"hat to  the groggy watchman, you leave the fortified neighborhood and head toward town. ";
	buttonReset();
	setButton(0, "Continue.", nightsWork27)
}

function nightsWork149() {
	player.progress = nwOffset + 149;
	document.getElementById("prompt").innerHTML = "You go through the doorway into a bedroom. "
	if (player.flags[nwFlags + 33] === false) {
		document.getElementById("prompt").innerHTML += "You see a huge man, about seven feet tall, with a day's growth of beard. He is asleep on a crude mattress, snoring loudly. He is wearing a loincloth and nothing else. "
	} else {
		if (guardDeadLoc === "bed") {
			document.getElementById("prompt").innerHTML += "The huge man's limp body is hanging off the bed. "
		} else if (player.flags[nwFlags + 33] === true && guardDeadLoc === "floor") {
			document.getElementById("prompt").innerHTML += "The guard's dead body is sprawled out on the floor. "
		}
	}
	if (player.flags[nwFlags + 31] === false) {
		document.getElementById("prompt").innerHTML += "You see a scimitar on the floor. ";
	}
	buttonReset();
	var b = 1;
	setButton(0, "Look for valuables.", nightsWork155)
	if (player.flags[nwFlags + 31] === false) {
		setButton(b, "Steal the scimitar.", nightsWork86)
		b += 1;
	}
	if (player.flags[nwFlags + 33] === false) {
		setButton(b, "Attack the guard.", nightsWork160)
		b += 1;
	}
	setButton(b, "Leave the room.", nightsWork59)
}

function nightsWork150() {
	player.progress = nwOffset + 150;
	document.getElementById("prompt").innerHTML = "These papers are a mixed lot: old love letters, a pedigree for a canary, 100 shares in a corporation long dead, a "+
	"collection of bawdy limericks, a good citizenship award, and so on and so forth. Some of these might be embarrassing to the owner, but none of them look important. ";
	buttonReset();
	var b = 0;
	if (player.flags[nwFlags + 39] === false) {
		setButton(b, "Take the papers.", take)
		b += 1;
	}
	if (player.flags[nwFlags + 40] === false) {
		setButton(b, "Open the small bag.", nightsWork69)
		b += 1;
	}
	setButton(b, "Go back.", nightsWork16)
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.fatsosPapers) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The papers were added to your inventory. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork97)
			addStuff(player.items, player.itemsQuantity, 1, items.fatsosPapers, "item");
			player.flags[nwFlags + 39] = true;
			loadInventory();
		}
	}
}

function nightsWork151() {
	player.progress = nwOffset + 151;
	document.getElementById("prompt").innerHTML = '"Tell him to move away from the door!" you command Fatso. ';
	buttonReset();
	setButton(0, "Continue.", roll)
	function roll() {
		var reaction = ((rng(20)+combat.bonus(player.dexterity)) + (rng(20)+combat.bonus(player.iq)))/2
		if (reaction > 15) {
			nightsWork96();
		} else if (reaction >= 10 && reaction <= 15) {
			nightsWork50();
		} else {
			nightsWork135();
		}
	}
}

function nightsWork152() {
	player.progress = nwOffset + 152;
	document.getElementById("prompt").innerHTML = "The guard did not believe you in the slightest. ";
	buttonReset();
	if (player.flags[nwFlags + 43] === false) {
		document.getElementById("prompt").innerHTML += "He lumbers toward you. "
		setButton(0, "Continue.", nightsWork76);						//attacking you
	} else {
		setButton(0, "Continue.", nightsWork146);						//had you by the wrist
	}
}

function nightsWork153() {
	player.progress = nwOffset + 153;
	document.getElementById("prompt").innerHTML = "Carefully, you re-enter the kitchen. The guard is gone, but he has been alerted. ";
	buttonReset();
	setButton(0, "Continue.", nightsWork128)
}

function nightsWork154() {
	player.progress = nwOffset + 154;
	document.getElementById("prompt").innerHTML = "This looks like the place where the owner of the house stores all the stuff he doesn't want anymore. ";
	buttonReset();
	setButton(0, "Continue.", roll)
	function roll() {
		if (player.flags[nwFlags + 49] === true) {
			if (player.flags[nwFlags + 50] === true) {
				nightsWork103();
			} else {
				nightsWork57();
			}
		} else {
			if (rng(20)+combat.bonus(player.iq) > 12) {
				player.flags[nwFlags + 50] = true;
			}
			player.flags[nwFlags + 49] = true;
			nightsWork154();
		}
	}
}

function nightsWork155() {
	player.progress = nwOffset + 155;
	document.getElementById("prompt").innerHTML = "This is obviously not a wealthy man. If he has any valuable possessions other than the scimitar, you can't find them.";
	buttonReset();
	setButton(0, "Continue.", nightsWork149)
}

function nightsWork156() {
	player.progress = nwOffset + 156;
	document.getElementById("prompt").innerHTML = "You decide on a story to tell the guard - you are a world class knife champion, you have seven starving children, "+
	"whatever. ";
	buttonReset();
	if (rng(20)+combat.bonus(player.iq) > 12) {
		document.getElementById("prompt").innerHTML += "You manage to convince him. ";
		setButton(0, "Continue.", nightsWork4);
	} else {
		document.getElementById("prompt").innerHTML += "The guard laughs at your ridiculous story. ";
		setButton(0, "Continue.", nightsWork152);
	}
}

function nightsWork157() {
	player.progress = nwOffset + 157;
	document.getElementById("prompt").innerHTML = "You are in the great hall being chased by the guard. You don't have time to look around. ";
	player.flags[nwFlags + 53] = true;
	buttonReset();
	if (player.flags[nwFlags + 34] === false) {
		if (rng(20)+combat.bonus(player.iq) > 15) {
			setButton(0, "Continue.", nightsWork161);
		}
		player.flags[nwFlags + 34] = true;
		nightsWork157()
	} else {
		setButton(0, "Duck off into the small room.", nightsWork109);
		setButton(1, "Go into the pantry.", nightsWork58);
		setButton(2, "Go through the door across from guard's room.", nightsWork133);
		setButton(3, "Fight.", fight);
	}
	function fight() {
		player.progress = nwOffset + 59;
		nightsWork76();
		guardDeadLoc = "hall"
	}
}

function nightsWork158() {
	player.progress = nwOffset + 158;
	document.getElementById("prompt").innerHTML = "You reach for the lid of the pot. ";
	buttonReset();
	if (rng(20)+combat.bonus(player.iq) >= 10) {
		document.getElementById("prompt").innerHTML += "You remembered to cover your hand with a towel and avoided a burn. "
		setButton(0, "Continue.", nightsWork168)
	} else {
		setButton(0, "Continue.", nightsWork92)
	}
}

function nightsWork159() {
	player.progress = nwOffset + 159;
	document.getElementById("prompt").innerHTML = "You are in a pantry. There are shelves and shelves of goods here. ";
	if (player.flags[nwFlags + 33] === true && guardDeadLoc === "pantry") {
		document.getElementById("prompt").innerHTML += "The guard's dead body is sprawled out on the floor. "
	}
	buttonReset();
	if (player.flags[nwFlags + 3] === false) {
		player.flags[nwFlags + 3] = true;
		if (rng(20)+combat.bonus(player.iq) >= 8) {
			player.flags[nwFlags + 4] = true;
		}
	}
	if (player.flags[nwFlags + 3] === true && player.flags[nwFlags + 4] === true) {
		if (player.flags[nwFlags + 5] && player.flags[nwFlags + 6] && player.flags[nwFlags + 7] && player.flags[nwFlags + 8] && player.flags[nwFlags + 9] && player.flags[nwFlags + 11] && player.flags[nwFlags + 38] === false) {
			document.getElementById("prompt").innerHTML += "You found nothing of value. You return to the landing to search somewhere else. "
			setButton(0, "Continue.", nightsWork111);
		} else {
			setButton(0, "Continue.", nightsWork98);
		}
	} else {
		document.getElementById("prompt").innerHTML += "You found nothing of value. You return to the landing to search somewhere else. "
		setButton(0, "Continue.", nightsWork111);
		if (player.flags[nwFlags + 38] === true) {
			document.getElementById("prompt").innerHTML += "You can return to the landing to search somewhere else, or go downstairs to the cellar.  "
			setButton(1, "Go downstairs.", nightsWork5);
		} else {
			document.getElementById("prompt").innerHTML += "You return to the landing to search somewhere else. "
		}
	}
}

function nightsWork160() {
	player.progress = nwOffset + 160;
	document.getElementById("prompt").innerHTML = "Attacking someone this size, even while he is asleep, is risky. ";
	buttonReset();
	setButton(0, "Reconsider.", nightsWork149)
	setButton(1, "Kill the giant.", nightsWork15)
	setButton(2, "Knock the giant out.", nightsWork83)
}

function nightsWork161() {
	player.progress = nwOffset + 161;
	document.getElementById("prompt").innerHTML = "You can tell the door opposite the guard's room leads out of the house.";
	buttonReset();
	setButton(0, "Turn and leave.", nightsWork133)
	setButton(1, "Continue.", nightsWork157)
}

function nightsWork162() {
	player.progress = nwOffset + 162;
	document.getElementById("prompt").innerHTML = "You manage to grab Fatso's arm before he can reach the bell-pull. You still have the weapon at his throat.";
	buttonReset();
	setButton(0, "Cut Fatso's throat.", nightsWork112)
	setButton(1, "Threaten to cut Fatso's throat.", nightsWork7)
	setButton(2, "Flee.", nightsWork22)
}

function nightsWork163() {
	player.progress = nwOffset + 163;
	document.getElementById("prompt").innerHTML = "As you check under Fatso's bed, you notice something unusual - tapping the rug by the side of the bed reveals a "+
	"hollow spot. You move the rug and see a trap door built into the floor. ";
	buttonReset();
	setButton(0, "Continue.", roll);
	function roll() {
		var baseRoll = rng(20);
		if (baseRoll === 1) {
			nightsWork31();
		} else if (baseRoll+combat.bonus(player.iq) > 12) {
			nightsWork39();
		} else {nightsWork136();}
	}
}

function nightsWork164() {
	player.progress = nwOffset + 164;
	buttonReset();
	if (rng(20)+combat.bonus(player.strength) > 10) {
		document.getElementById("prompt").innerHTML = "Your blow stunned the giant, but he's recovering quickly. ";
		setButton(0, "Hit him again.", nightsWork83);
		setButton(1, "Flee from house.", nightsWork27);
	} else {
		document.getElementById("prompt").innerHTML = "You knocked the giant unconscious. "
		setButton(0, "Continue.", nightsWork134);
		player.flags[nwFlags + 33] = true;
		guardDeadLoc = "bed"
	}
}

function nightsWork165() {
	player.progress = nwOffset + 165;
	document.getElementById("prompt").innerHTML = "Even with the engravings, these will be easy to sell. I'll pay you 1500 gold coins for them. With that kind of "+
	"money, you should go take a vacation. ";
	buttonReset();
	setButton(0, "Deal.", deal)
	setButton(1, "Nevermind.", data22)
	function deal() {
		player.gold += 1500;
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.bagOfGems), "item");
		loadInventory();
		displayChar();
		data22();
	}
}

function nightsWork166() {
	player.progress = nwOffset + 166;
	document.getElementById("prompt").innerHTML = "Do you know what you have here? You do not, of course. The pedigree of a canary... some old love letters... and ten "+
	"years of business records for a cesspool cleaning service. This is worthless. ";
	removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.fatsosPapers), "item");
	loadInventory();	
	buttonReset();
	setButton(0, "Continue.", data22)
}

function nightsWork167() {
	player.progress = nwOffset + 167;
	document.getElementById("prompt").innerHTML = "The tea service consists of four porcelain cups, a porcelain tea pot, and four silver spoons. ";
	buttonReset();
	if (player.flags[nwFlags + 23] === false) {
		if (rng(20)+combat.bonus(player.iq) > 10) {
			document.getElementById("prompt").innerHTML += "You study the spoons and notice some markings. ";
			setButton(0, "Continue.", nightsWork181);
		} else {
			document.getElementById("prompt").innerHTML += "You study the spoons, but do not notice anything. "
			setButton(0, "Continue.", nightsWork119);
		}
	} else {
		setButton(0, "Continue.", nightsWork119);
	}
}

function nightsWork168() {
	player.progress = nwOffset + 168;
	document.getElementById("prompt").innerHTML = "It's a good stew! You may eat as much as you like. ";
	buttonReset();
	if (rng(20)+combat.bonus(player.iq) < 10) {
		document.getElementById("prompt").innerHTML += " However, you end up eating too much. ";
		setButton(0, "Continue.", nightsWork178);
	} else {
		setButton(0, "Look around the kitchen.", nightsWork128);
		setButton(1, "Leave the kitchen.", nightsWork111);
	}
}

function nightsWork169() {
	player.progress = nwOffset + 172;
	document.getElementById("prompt").innerHTML = "You've got some balls to steal this key from around that guy's neck. This thing is solid gold. I'll give you 100 gold coins for it. ";
	buttonReset();
	setButton(0, "Deal.", deal)
	setButton(1, "Nevermind.", data22)
	function deal() {
		player.gold += 100;
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.goldKey), "item");
		loadInventory();
		displayChar();
		data22();
	}
}

function nightsWork170() {
	player.progress = nwOffset + 170;
	document.getElementById("prompt").innerHTML = "You knocked the spider off onto the shelf. It scuttles behind a clutter of boxes and disappears.";
	buttonReset();
	player.flags[nwFlags + 10] = true;
	setButton(0, "Look in the jar.", nightsWork118)
	setButton(1, "Look at something else.", nightsWork68)
}

function nightsWork171() {
	player.progress = nwOffset + 171;
	document.getElementById("prompt").innerHTML = "What do you want to do?";
	buttonReset();
	var b = 1;
	setButton(0, "Examine the statues.", nightsWork184)
	if (player.flags[nwFlags + 35] === false || player.flags[nwFlags + 36] === false || player.flags[nwFlags + 37] === false) {
		setButton(1, "Look at the pillows.", nightsWork124);
		b += 1;
	}
	if (player.flags[nwFlags + 30] === false) {
		setButton(b, "Examine the tapestries.", nightsWork51);
		b += 1;
	}
	if (player.flags[nwFlags + 21] === false || player.flags[nwFlags + 22] === false) {
		setButton(b, "Look at the other furnishings.", nightsWork129);
		b += 1;
	}
	setButton(b, "Go back.", nightsWork59);
}

function nightsWork172() {
	player.progress = nwOffset + 172;
	document.getElementById("prompt").innerHTML = "This finely woven tapestry shouldn't be too hard to sell. I'll give you 400 gold coins for it. ";
	buttonReset();
	setButton(0, "Deal.", deal)
	setButton(1, "Nevermind.", data22)
	function deal() {
		player.gold += 400;
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.tapestry), "item");
		loadInventory();
		displayChar();
		data22();
	}
}

function nightsWork173() {
	if (rng(20)+combat.bonus(player.iq) > 12) {
		nightsWork54();
	} else {nightsWork147();}
}

function nightsWork174() {
	player.progress = nwOffset + 174;
	document.getElementById("prompt").innerHTML = "The marks are Apothecaries' Guild symbols for Ointment and Burn.";
	buttonReset();
	setButton(0, "Continue.", nightsWork26)
}

function nightsWork175() {
	player.progress = nwOffset + 175;
	document.getElementById("prompt").innerHTML = "One of the labels in the wine rack stands out. It's faded, but you can see the name written in gold leaf. Only very "+
	"valuable wines are labeled in gold leaf; you should be able to fence it for at least 150 gold coins. ";
	buttonReset();
	setButton(0, "Take the wine.", take)
	setButton(1, "Drink the wine.", nightsWork45)
	setButton(2, "Go back.", nightsWork16)
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.rareWine) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The wine was added to your inventory. ";
			buttonReset();
			setButton(0, "Continue.", nightsWork16);
			addStuff(player.items, player.itemsQuantity, 1, items.rareWine, "item");
			player.flags[nwFlags + 16] = true;
			loadInventory();
		}
	}
}

function nightsWork176() {
	if (player.flags[nwFlags + 38] === true) {
		nightsWork5();
	} else {
		if (rng(20)+combat.bonus(player.iq) >= 8) {
			nightsWork5();
		} else {nightsWork111();}
	}
}

function nightsWork177() {
	player.progress = nwOffset + 177;
	document.getElementById("prompt").innerHTML = "You notice that the seal on one of the bungs on the bottom row isn't quite right. You pull on the bung and it comes "+
	"out readily, disclosing a keyhole! ";
	buttonReset();
	var b = 0;
	if (checkForStuff(player.items, items.goldKey) !== false) {				//has key
		setButton(b, "Open lock with key.", nightsWork8);
		b += 1;
	}
	setButton(b, "Pick the lock.", nightsWork122)
	setButton(b+1, "Go back.", nightsWork16)
}

function nightsWork178() {
	player.progress = nwOffset + 178;
	document.getElementById("prompt").innerHTML = "The stew is delicious! You take several helpings. You can't eat the entire pot of stew, but you really try.";
	buttonReset();
	setButton(0, "Continue.", nightsWork128)
}

function nightsWork179() {
	player.progress = nwOffset + 179;
	document.getElementById("prompt").innerHTML = "This decorative tea set shouldn't be too hard to sell. I'll give you 300 gold coins for it. ";
	buttonReset();
	setButton(0, "Deal.", deal)
	setButton(1, "Nevermind.", data22)
	function deal() {
		player.gold += 300;
		removeStuff(player.items, player.itemsQuantity, checkForStuff(player.items, items.teaService), "item");
		loadInventory();
		displayChar();
		data22();
	}
}

function nightsWork180() {
	player.progress = nwOffset + 180;
	document.getElementById("prompt").innerHTML = "As you complete your perusal, you notice something unusual: a gold key on a silken cord around the fat man's neck.";
	buttonReset();
	if (player.flags[nwFlags + 52] === false) {
		setButton(0, "Remove the key.", nightsWork108)
	} else {
		setButton(0, "Remove the key.", key)
	}
	setButton(1, "Leave the room.", nightsWork18)
	function key() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.goldKey) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "You rip the key from Fatso's corpse. ";
			player.flags[nwFlags + 44] = true;
			addStuff(player.items, player.itemsQuantity, 1, items.goldKey, "item");
			loadInventory();
			buttonReset();
			setButton(0, "Continue.", nightsWork110)
		}
	}
}

function nightsWork181() {
	player.progress = nwOffset + 181;
	document.getElementById("prompt").innerHTML = "The spoons are hallmarked, indicating that they are silver and the work of a master smith.";
	buttonReset();
	setButton(0, "Continue.", nightsWork119)
}

function nightsWork182() {
	player.progress = nwOffset + 182;
	document.getElementById("prompt").innerHTML = "This jar feels like it might be empty, but when you open it - sure enough, it's empty!";
	buttonReset();
	setButton(0, "Take the jar.", take)
	setButton(1, "Continue.", nightsWork68)
	function take() {
		if (checkQuantityFull(player.items, player.itemsQuantity, items.emptyJar) === true) {
			return dropStuff(player.items, player.itemsQuantity, "item");
		} else {
			document.getElementById("prompt").innerHTML = "The jar was added to your inventory. ";
			player.flags[nwFlags + 7] = true;
			buttonReset();
			setButton(0, "Go back.", nightsWork68)
			addStuff(player.items, player.itemsQuantity, 1, items.emptyJar, "item");
			loadInventory();
		}
	}
}

function nightsWork183() {
	player.progress = nwOffset + 183;
	document.getElementById("prompt").innerHTML = "Whoever owns this house seems to have plenty of money. The huge pots and kettles here must have been very expensive. "+
	"Unfortunately, they are also too large to fit comfortably into your bag.";
	buttonReset();
	if (player.flags[nwFlags + 0] === false) {
		setButton(0, "Look more closely.", nightsWork99)
		setButton(1, "Go back.", nightsWork128)
	} else {
		setButton(0, "Go back.", nightsWork128)		
	}
}

function nightsWork184() {
	player.progress = nwOffset + 184;
	document.getElementById("prompt").innerHTML = "These statues are made of marble, life-size and VERY heavy. There is no way to take one with you.";
	buttonReset();
	setButton(0, "Continue.", nightsWork171)
}

function nightsWork185() {
	player.progress = nwOffset + 185;
	document.getElementById("prompt").innerHTML = "You made it out with all your loot. You are going to want to sell some of it through a fence because a shopkeeper "+
	"might recognize them and report you to the city guard. ";
	if (player.questProgress[quests.find(0)] === 2) {
		quests.update(0);
	}
	buttonReset();
	setButton(0, "Continue.", data0)
}

	function nwCheck() {
		window.alert(checkClass(weapons.dagger))
		var withOffset = 0;
		while (true) {
			var next = window.prompt("NW number is "+withOffset+". Next number?")
			next = parseInt(next);
			if ((next>0||next<0) === false) {
				break;
			}
			next += nwOffset;
			withOffset = next;
		}
	}

</script>
</body>
</html>
